# 需求管理平台 - 后端架构

## 目录结构

```
models/
  ├── company.go
  ├── project.go
  ├── mission_list.go
  ├── mission.go
  ├── mission_comment.go
  ├── mission_attachment.go
  └── mission_relation.go

controllers/
  ├── company_controller.go
  ├── project_controller.go
  ├── mission_list_controller.go
  ├── mission_controller.go
  └── statistics_controller.go

services/
  ├── company_service.go
  ├── project_service.go
  ├── mission_service.go
  ├── notification_service.go
  └── statistics_service.go

middleware/
  ├── company_permission.go
  └── project_permission.go
```

## 核心类设计

### models/company.go

```go
type Company struct {
  ID          uint
  Name        string
  Logo        string
  Description string
  OwnerID     uint
  Status      string
  CreatedAt   time.Time
  UpdatedAt   time.Time

  Members     []CompanyMember
  Projects    []Project
}

type CompanyMember struct {
  ID        uint
  CompanyID uint
  UserID    uint
  Role      string
  JoinedAt  time.Time

  User      User
}
```

### models/project.go

```go
type Project struct {
  ID          uint
  CompanyID   uint
  Name        string
  Key         string
  Description string
  OwnerID     uint
  Status      string
  StartDate   *time.Time
  EndDate     *time.Time
  CreatedAt   time.Time
  UpdatedAt   time.Time

  Company      Company
  Members      []ProjectMember
  MissionLists []MissionList
}

type ProjectMember struct {
  ID        uint
  ProjectID uint
  UserID    uint
  Role      string
  JoinedAt  time.Time

  User      User
}
```

### models/mission.go

```go
type Mission struct {
  ID             uint
  MissionListID  uint
  ProjectID      uint
  Title          string
  Description    string
  Type           string
  Priority       string
  Status         string
  AssigneeID     *uint
  ReporterID     uint
  EstimatedHours float64
  ActualHours    float64
  StartDate      *time.Time
  DueDate        *time.Time
  CompletedAt    *time.Time
  SortOrder      int
  CreatedAt      time.Time
  UpdatedAt      time.Time

  MissionList  MissionList
  Assignee     *User
  Reporter     User
  Comments     []MissionComment
  Attachments  []MissionAttachment
  Relations    []MissionRelation
  Logs         []MissionLog
}
```

### controllers/mission_controller.go

```go
type MissionController struct {
  service *services.MissionService
}

func (mc *MissionController) Create(c *gin.Context)
func (mc *MissionController) List(c *gin.Context)
func (mc *MissionController) GetDetail(c *gin.Context)
func (mc *MissionController) Update(c *gin.Context)
func (mc *MissionController) Delete(c *gin.Context)
func (mc *MissionController) BatchUpdateStatus(c *gin.Context)
func (mc *MissionController) AddComment(c *gin.Context)
func (mc *MissionController) UploadAttachment(c *gin.Context)
func (mc *MissionController) CreateRelation(c *gin.Context)
```

### services/mission_service.go

```go
type MissionService struct {
  db                  *gorm.DB
  notificationService *NotificationService
}

func (ms *MissionService) CreateMission(req CreateMissionRequest) (*Mission, error)
func (ms *MissionService) UpdateMission(id uint, req UpdateMissionRequest) (*Mission, error)
func (ms *MissionService) GetMissionDetail(id uint) (*Mission, error)
func (ms *MissionService) ListMissions(filters MissionFilters) ([]Mission, int64, error)
func (ms *MissionService) DeleteMission(id uint) error
func (ms *MissionService) UpdateStatus(id uint, status string, userID uint) error
func (ms *MissionService) AddComment(missionID uint, content string, userID uint) (*MissionComment, error)
func (ms *MissionService) CreateRelation(sourceID, targetID uint, relationType string) error
```

### services/notification_service.go

```go
type NotificationService struct {
  db *gorm.DB
}

func (ns *NotificationService) NotifyMissionAssigned(mission *Mission)
func (ns *NotificationService) NotifyMissionStatusChanged(mission *Mission, oldStatus string)
func (ns *NotificationService) NotifyMissionCommented(comment *MissionComment)
func (ns *NotificationService) NotifyMissionMentioned(mission *Mission, userIDs []uint)
```

### services/statistics_service.go

```go
type StatisticsService struct {
  db *gorm.DB
}

func (ss *StatisticsService) GetProjectStatistics(projectID uint) (*ProjectStatistics, error)
func (ss *StatisticsService) GetMemberWorkload(projectID uint, startDate, endDate time.Time) ([]MemberWorkload, error)
func (ss *StatisticsService) GetBurndownData(missionListID uint) (*BurndownData, error)
func (ss *StatisticsService) GetCompletionTrend(projectID uint, days int) ([]TrendPoint, error)
```

### middleware/project_permission.go

```go
func RequireProjectAccess(role string) gin.HandlerFunc
func RequireProjectMember() gin.HandlerFunc
func RequireCompanyMember() gin.HandlerFunc
func CheckMissionPermission(action string) gin.HandlerFunc
```

## 权限控制

### 公司级别

- owner: 所有权限
- admin: 管理成员、创建项目
- member: 查看公司信息
- viewer: 只读

### 项目级别

- admin: 项目管理、成员管理
- developer: 创建/更新需求
- viewer: 只读

### 需求级别

- 创建人: 编辑、删除
- 负责人: 更新状态、工时
- 项目成员: 评论、查看
- 项目管理员: 所有操作

## 数据库迁移

```go
// database/migrations/
// 001_create_companies.go
// 002_create_projects.go
// 003_create_mission_lists.go
// 004_create_missions.go
// 005_create_mission_comments.go
// 006_create_mission_attachments.go
// 007_create_mission_relations.go
// 008_create_mission_logs.go
```

## 缓存策略

- 项目成员列表: Redis, TTL 5分钟
- 项目统计数据: Redis, TTL 1分钟
- 用户权限: Redis, TTL 10分钟

## 性能优化

- 需求列表分页加载
- 评论懒加载
- 附件异步上传
- 统计数据后台计算
- 数据库索引优化
- N+1查询优化（使用Preload）
