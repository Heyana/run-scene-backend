# 数据库设计

## 表结构概览

```
models (模型主表)
├── model_tags (模型-标签关联，复用 tags 表)
└── model_metrics (统计指标)
```

---

## 1. 模型主表 (models)

```go
type Model struct {
    ID            uint       `gorm:"primaryKey" json:"id"`
    Name          string     `gorm:"size:200;index" json:"name"`
    Description   string     `gorm:"type:text" json:"description"`
    Category      string     `gorm:"size:50;index" json:"category"`
    Tags          string     `gorm:"type:text" json:"tags"` // 逗号分隔
    Type          string     `gorm:"size:20;index" json:"type"` // glb, glt(私有格式)

    // 文件信息
    FileSize      int64      `json:"file_size"` // 字节
    FilePath      string     `gorm:"size:512" json:"file_path"` // 模型文件相对路径
    FileHash      string     `gorm:"size:64;index" json:"file_hash"` // MD5

    // 预览图
    ThumbnailPath string     `gorm:"size:512" json:"thumbnail_path"` // 缩略图路径

    // 使用统计
    UseCount      int        `gorm:"default:0;index" json:"use_count"`
    LastUsedAt    *time.Time `json:"last_used_at"`

    // 上传信息
    UploadedBy    string     `gorm:"size:100" json:"uploaded_by"`
    UploadIP      string     `gorm:"size:50" json:"upload_ip"`

    CreatedAt     time.Time  `json:"created_at"`
    UpdatedAt     time.Time  `json:"updated_at"`
}
```

**索引**：

- `name`, `category`, `type` (普通)
- `use_count` (排序)
- `file_hash` (去重)

---

## 2. 模型-标签关联表 (model_tags)

```go
type ModelTag struct {
    ID        uint      `gorm:"primaryKey" json:"id"`
    ModelID   uint      `gorm:"index" json:"model_id"`
    TagID     uint      `gorm:"index" json:"tag_id"` // 复用 tags 表
    CreatedAt time.Time `json:"created_at"`
}
```

**说明**：复用贴图库的 `tags` 表，统一管理标签

---

## 3. 统计指标表 (model_metrics)

```go
type ModelMetrics struct {
    ID            uint      `gorm:"primaryKey" json:"id"`
    Date          string    `gorm:"uniqueIndex;size:10" json:"date"` // YYYY-MM-DD
    TotalModels   int       `json:"total_models"`
    TotalSize     int64     `json:"total_size"` // 字节
    UploadCount   int       `json:"upload_count"` // 当日上传数
    UploadSize    int64     `json:"upload_size"` // 当日上传大小
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
}
```

---

## 4. 复用表

### 4.1 标签表 (tags)

复用贴图库的 `tags` 表，统一管理标签和分类

---

## 数据库迁移

```go
func AutoMigrate(db *gorm.DB) error {
    return db.AutoMigrate(
        &Model{},
        &ModelTag{},
        &ModelMetrics{},
    )
}
```

---

## 文件存储结构

```
static/models/
  ├── 1/
  │   ├── model.glb           # 模型文件
  │   └── thumbnail.webp      # 预览图
  ├── 2/
  │   ├── model.glt           # 私有格式
  │   └── thumbnail.webp
  └── ...
```
