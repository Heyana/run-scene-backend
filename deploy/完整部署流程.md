# 完整部署流程

## ✅ 第一步：启动 Mihomo 代理（已完成）

```bash
cd /vol1/1003/app
./mihomo -d ./mihomo-config
```

**状态：** ✅ 成功启动

- HTTP proxy: `http://127.0.0.1:7890`
- SOCKS proxy: `socks5://127.0.0.1:7891`
- API: `http://127.0.0.1:9090`

## 第二步：后台运行 Mihomo

现在 mihomo 在前台运行，按 `Ctrl+C` 会停止。建议后台运行：

```bash
# 按 Ctrl+C 停止当前进程

# 后台运行
cd /vol1/1003/app
nohup ./mihomo -d ./mihomo-config > mihomo.log 2>&1 &

# 查看日志
tail -f mihomo.log

# 按 Ctrl+C 退出日志查看（不会停止 mihomo）
```

## 第三步：测试代理

```bash
# 测试 Google
curl -x http://127.0.0.1:7890 https://www.google.com

# 测试 Cloudflare
curl -x http://127.0.0.1:7890 https://www.cloudflare.com/cdn-cgi/trace

# 如果能看到返回内容，说明代理工作正常
```

## 第四步：启动后端服务

```bash
# 进入后端目录
cd /vol1/1003/project/editor_v2/deploy

# 确认配置文件中代理已启用
cat config.yaml | grep -A 2 "proxy"

# 应该看到：
# proxy_enabled: true
# proxy_url: "http://127.0.0.1:7890"

# 如果没有，编辑配置
nano config.yaml

# 停止旧的后端服务（如果在运行）
pkill -f app-linux

# 启动后端服务
nohup ./app-linux > logs/app.log 2>&1 &

# 查看日志
tail -f logs/app.log
```

## 第五步：验证服务

```bash
# 检查后端是否启动
ps aux | grep app-linux

# 检查端口
netstat -tlnp | grep 23359

# 测试 API（从另一台机器或浏览器）
# http://192.168.3.10:23359/api/docs
```

## 常用管理命令

### 查看所有服务状态

```bash
# Mihomo 代理
ps aux | grep mihomo
netstat -tlnp | grep 7890

# 后端服务
ps aux | grep app-linux
netstat -tlnp | grep 23359
```

### 停止服务

```bash
# 停止 Mihomo
pkill -f mihomo

# 停止后端
pkill -f app-linux
```

### 重启服务

```bash
# 重启 Mihomo
pkill -f mihomo
cd /vol1/1003/app
nohup ./mihomo -d ./mihomo-config > mihomo.log 2>&1 &

# 重启后端
pkill -f app-linux
cd /vol1/1003/project/editor_v2/deploy
nohup ./app-linux > logs/app.log 2>&1 &
```

### 查看日志

```bash
# Mihomo 日志
tail -f /vol1/1003/app/mihomo.log

# 后端日志
tail -f /vol1/1003/project/editor_v2/deploy/logs/app.log
```

## 开机自启动（推荐）

创建启动脚本：

```bash
nano /vol1/1003/startup.sh
```

内容：

```bash
#!/bin/bash

# 启动 Mihomo 代理
cd /vol1/1003/app
nohup ./mihomo -d ./mihomo-config > mihomo.log 2>&1 &

# 等待代理启动
sleep 3

# 启动后端服务
cd /vol1/1003/project/editor_v2/deploy
nohup ./app-linux > logs/app.log 2>&1 &

echo "所有服务已启动"
```

赋予执行权限：

```bash
chmod +x /vol1/1003/startup.sh
```

添加到 crontab：

```bash
crontab -e
```

添加：

```
@reboot /vol1/1003/startup.sh
```

## 故障排查

### Mihomo 无法启动

```bash
# 检查端口占用
netstat -tlnp | grep 7890

# 查看配置文件
cat /vol1/1003/app/mihomo-config/config.yaml

# 查看日志
cat /vol1/1003/app/mihomo.log
```

### 后端无法连接外网

```bash
# 测试代理
curl -x http://127.0.0.1:7890 https://www.google.com

# 检查后端配置
cat /vol1/1003/project/editor_v2/deploy/config.yaml | grep proxy

# 查看后端日志
tail -f /vol1/1003/project/editor_v2/deploy/logs/app.log
```

### 端口被占用

```bash
# 查找占用进程
lsof -i :7890
lsof -i :23359

# 杀死进程
kill -9 <PID>
```

## 下一步

1. ✅ Mihomo 代理已启动
2. ⏳ 后台运行 Mihomo
3. ⏳ 测试代理连接
4. ⏳ 启动后端服务
5. ⏳ 验证服务正常
6. ⏳ 配置开机自启动

**当前任务：** 按 `Ctrl+C` 停止前台运行的 mihomo，然后用 `nohup` 后台运行。

cd /vol1/1003/app/mihomo-config

wget -O base64.txt "https://103.200.216.101/proxy?url=https%3A%2F%2Fxn--wtq35pfyd55o.co%2Fanswer%2Fland%2F06fbffb33c84b9a7a8bc899c2967734d"

base64 -d base64.txt > config.yaml

pscp mihomo.yaml LiLeng@192.168.3.10:/vol1/1003/app/mihomo-config/config.yaml

pscp app-linux LiLeng@192.168.3.10:/vol1/1003/project/editor_v2/app-linux

curl -X PUT http://127.0.0.1:9090/proxies/便宜机场 -d '{"name":"德国hy2-3"}' -H "Content-Type: application/json"

curl -X PUT http://127.0.0.1:9090/proxies/便宜机场 -d '{"name":"新加坡vless-1"}' -H "Content-Type: application/json"

# 先停止服务

sudo systemctl stop mihomo

# 手动运行看输出

cd /vol1/1003/app
./mihomo -d ./mihomo-config

curl -x http://127.0.0.1:7890 https://www.google.com -I
