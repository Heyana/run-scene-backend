# 需求管理平台 - 补充设计

## 缺失功能补充

### 1. 任务状态流转规则

```go
// models/mission_status.go
var StatusTransitions = map[string][]string{
    "todo":        {"in_progress", "closed"},
    "in_progress": {"done", "todo", "closed"},
    "done":        {"closed", "in_progress"},
    "closed":      {"todo"},
}

func (m *Mission) CanTransitionTo(newStatus string) bool {
    allowedStatuses, ok := StatusTransitions[m.Status]
    if !ok {
        return false
    }
    for _, status := range allowedStatuses {
        if status == newStatus {
            return true
        }
    }
    return false
}
```

### 2. 任务编号自动生成

```go
// models/mission.go
type Mission struct {
    // ... 其他字段
    MissionKey string `gorm:"uniqueIndex:idx_project_key"` // 如 PRJ-001
}

// 生成任务编号
func GenerateMissionKey(db *gorm.DB, projectID uint) (string, error) {
    var project Project
    db.First(&project, projectID)

    var count int64
    db.Model(&Mission{}).Where("project_id = ?", projectID).Count(&count)

    return fmt.Sprintf("%s-%d", project.Key, count+1), nil
}
```

### 3. 任务模板

```go
// models/mission_template.go
type MissionTemplate struct {
    ID          uint
    ProjectID   uint
    Name        string
    Description string
    Type        string
    Priority    string
    Checklist   string // JSON格式的检查清单
    CreatedAt   time.Time
}
```

### 4. 任务检查清单

```go
// models/mission_checklist.go
type MissionChecklistItem struct {
    ID        uint
    MissionID uint
    Content   string
    Completed bool
    SortOrder int
}
```

### 5. 任务时间跟踪

```go
// models/mission_time_log.go
type MissionTimeLog struct {
    ID          uint
    MissionID   uint
    UserID      uint
    StartTime   time.Time
    EndTime     *time.Time
    Duration    int // 秒
    Description string
}
```

### 6. 任务优先级自动调整

```go
// services/mission_service.go
func (ms *MissionService) AutoAdjustPriority(mission *Mission) {
    // 临近截止日期自动提升优先级
    if mission.DueDate != nil {
        daysLeft := time.Until(*mission.DueDate).Hours() / 24
        if daysLeft <= 1 && mission.Priority != "P0" {
            mission.Priority = "P0"
            ms.db.Save(mission)
        }
    }
}
```

### 7. 任务依赖检查

```go
// services/mission_service.go
func (ms *MissionService) CanComplete(missionID uint) (bool, string) {
    // 检查是否有未完成的依赖任务
    var count int64
    ms.db.Model(&MissionRelation{}).
        Joins("JOIN missions ON missions.id = mission_relations.source_mission_id").
        Where("mission_relations.target_mission_id = ? AND mission_relations.relation_type = ? AND missions.status != ?",
            missionID, "depends_on", "done").
        Count(&count)

    if count > 0 {
        return false, "存在未完成的依赖任务"
    }
    return true, ""
}
```

### 8. 批量操作

```go
// controllers/mission_controller.go
func (mc *MissionController) BatchUpdate(c *gin.Context) {
    var req struct {
        MissionIDs []uint                 `json:"mission_ids"`
        Updates    map[string]interface{} `json:"updates"`
    }

    // 批量更新状态、优先级、负责人等
    db.Model(&Mission{}).Where("id IN ?", req.MissionIDs).Updates(req.Updates)
}
```

### 9. 任务搜索与筛选

```go
// services/mission_service.go
type MissionFilter struct {
    Keyword    string
    Status     []string
    Priority   []string
    AssigneeID []uint
    Type       []string
    StartDate  *time.Time
    EndDate    *time.Time
    Tags       []string
}

func (ms *MissionService) Search(filter MissionFilter) ([]Mission, error) {
    query := ms.db.Model(&Mission{})

    if filter.Keyword != "" {
        query = query.Where("title LIKE ? OR description LIKE ?",
            "%"+filter.Keyword+"%", "%"+filter.Keyword+"%")
    }

    if len(filter.Status) > 0 {
        query = query.Where("status IN ?", filter.Status)
    }

    if len(filter.Priority) > 0 {
        query = query.Where("priority IN ?", filter.Priority)
    }

    if len(filter.AssigneeID) > 0 {
        query = query.Where("assignee_id IN ?", filter.AssigneeID)
    }

    var missions []Mission
    err := query.Find(&missions).Error
    return missions, err
}
```

### 10. 任务标签系统

```go
// models/mission_tag.go
type MissionTag struct {
    ID        uint
    ProjectID uint
    Name      string
    Color     string
}

// 多对多关联
type Mission struct {
    // ... 其他字段
    Tags []MissionTag `gorm:"many2many:mission_tag_relations;"`
}
```

## 性能优化

### 1. 数据库索引优化

```sql
-- 任务表索引
CREATE INDEX idx_missions_project_status ON missions(project_id, status);
CREATE INDEX idx_missions_assignee ON missions(assignee_id);
CREATE INDEX idx_missions_due_date ON missions(due_date);
CREATE INDEX idx_missions_created_at ON missions(created_at);

-- 评论表索引
CREATE INDEX idx_comments_mission_created ON mission_comments(mission_id, created_at);

-- 关联表索引
CREATE INDEX idx_relations_source ON mission_relations(source_mission_id);
CREATE INDEX idx_relations_target ON mission_relations(target_mission_id);
```

### 2. 查询优化

```go
// 使用 Preload 避免 N+1 查询
func (ms *MissionService) GetMissionDetail(id uint) (*Mission, error) {
    var mission Mission
    err := ms.db.
        Preload("Assignee").
        Preload("Reporter").
        Preload("Comments.User").
        Preload("Attachments").
        Preload("Relations.TargetMission").
        Preload("Tags").
        First(&mission, id).Error
    return &mission, err
}
```

### 3. 缓存策略

```go
// 缓存项目成员列表
func (ps *ProjectService) GetMembers(projectID uint) ([]ProjectMember, error) {
    cacheKey := fmt.Sprintf("project:members:%d", projectID)

    // 尝试从缓存获取
    if cached, err := redis.Get(cacheKey); err == nil {
        var members []ProjectMember
        json.Unmarshal([]byte(cached), &members)
        return members, nil
    }

    // 从数据库查询
    var members []ProjectMember
    err := ps.db.Where("project_id = ?", projectID).
        Preload("User").
        Find(&members).Error

    // 写入缓存
    if err == nil {
        data, _ := json.Marshal(members)
        redis.Set(cacheKey, data, 5*time.Minute)
    }

    return members, err
}
```

### 4. 分页优化

```go
// 使用游标分页代替偏移分页（大数据量时更高效）
func (ms *MissionService) ListWithCursor(lastID uint, limit int) ([]Mission, error) {
    var missions []Mission
    query := ms.db.Model(&Mission{}).Limit(limit)

    if lastID > 0 {
        query = query.Where("id > ?", lastID)
    }

    err := query.Order("id ASC").Find(&missions).Error
    return missions, err
}
```

## 安全加固

### 1. SQL注入防护

```go
// 使用参数化查询，GORM已自动处理
// 避免直接拼接SQL
// ❌ 错误示例
db.Where(fmt.Sprintf("name = '%s'", userInput))

// ✅ 正确示例
db.Where("name = ?", userInput)
```

### 2. XSS防护

```go
// 富文本内容过滤
import "github.com/microcosm-cc/bluemonday"

func SanitizeHTML(content string) string {
    p := bluemonday.UGCPolicy()
    return p.Sanitize(content)
}
```

### 3. 文件上传安全

```go
// 文件类型验证
func ValidateFileType(filename string) bool {
    allowedTypes := []string{".jpg", ".png", ".pdf", ".doc", ".docx", ".xls", ".xlsx"}
    ext := strings.ToLower(filepath.Ext(filename))
    for _, allowed := range allowedTypes {
        if ext == allowed {
            return true
        }
    }
    return false
}

// 文件大小限制
const MaxFileSize = 10 * 1024 * 1024 // 10MB
```

### 4. 操作日志审计

```go
// 记录敏感操作
func (ms *MissionService) LogOperation(userID uint, action string, missionID uint, details string) {
    log := MissionLog{
        MissionID: missionID,
        UserID:    userID,
        Action:    action,
        Details:   details,
        CreatedAt: time.Now(),
    }
    ms.db.Create(&log)
}
```

## 前端补充

### 1. 离线支持

```typescript
// 使用 IndexedDB 缓存数据
import { openDB } from "idb";

const db = await openDB("requirement-db", 1, {
  upgrade(db) {
    db.createObjectStore("missions");
    db.createObjectStore("projects");
  },
});

// 离线时从本地读取
async function getMission(id: number) {
  if (!navigator.onLine) {
    return await db.get("missions", id);
  }
  const mission = await api.mission.getDetail(id);
  await db.put("missions", mission, id);
  return mission;
}
```

### 2. 乐观更新

```typescript
// 立即更新UI，后台同步
const updateMissionStatus = async (id: number, status: string) => {
  // 立即更新本地状态
  const mission = missions.value.find((m) => m.id === id);
  if (mission) {
    const oldStatus = mission.status;
    mission.status = status;

    try {
      // 后台同步
      await api.mission.updateStatus(id, status);
    } catch (error) {
      // 失败时回滚
      mission.status = oldStatus;
      message.error("更新失败");
    }
  }
};
```

### 3. 快捷键支持

```typescript
// 全局快捷键
import { useKeyboard } from "@/composables/useKeyboard";

useKeyboard({
  "ctrl+n": () => openCreateMissionModal(),
  "ctrl+s": () => saveMission(),
  "ctrl+f": () => focusSearch(),
  esc: () => closeModal(),
});
```

### 4. 拖拽优化

```typescript
// 使用虚拟滚动优化大量卡片
import { useVirtualList } from "@vueuse/core";

const { list, containerProps, wrapperProps } = useVirtualList(missions, {
  itemHeight: 100,
});
```

### 5. 错误边界

```typescript
// 组件错误捕获
app.config.errorHandler = (err, instance, info) => {
  console.error("Error:", err);
  console.error("Info:", info);

  // 上报错误
  reportError({
    error: err.message,
    stack: err.stack,
    component: instance?.$options.name,
    info,
  });
};
```

## 监控与告警

### 1. 性能监控

```go
// 慢查询监控
func SlowQueryMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        c.Next()
        duration := time.Since(start)

        if duration > 1*time.Second {
            logger.Log.Warnf("Slow request: %s %s took %v",
                c.Request.Method, c.Request.URL.Path, duration)
        }
    }
}
```

### 2. 错误告警

```go
// 错误率监控
func ErrorRateMonitor() {
    ticker := time.NewTicker(1 * time.Minute)
    for range ticker.C {
        errorRate := getErrorRate()
        if errorRate > 0.05 { // 错误率超过5%
            sendAlert("Error rate too high: %.2f%%", errorRate*100)
        }
    }
}
```

### 3. 业务指标

```go
// 统计活跃用户、任务创建数等
type Metrics struct {
    ActiveUsers    int
    MissionsCreated int
    MissionsCompleted int
    AvgCompletionTime float64
}

func CollectMetrics() Metrics {
    // 收集业务指标
}
```

## 测试补充

### 1. 单元测试

```go
// mission_service_test.go
func TestCreateMission(t *testing.T) {
    service := NewMissionService(db)

    mission, err := service.CreateMission(CreateMissionRequest{
        Title: "Test Mission",
        Type: "feature",
        Priority: "P1",
    })

    assert.NoError(t, err)
    assert.NotNil(t, mission)
    assert.Equal(t, "Test Mission", mission.Title)
}
```

### 2. 集成测试

```go
// api_test.go
func TestMissionAPI(t *testing.T) {
    router := setupRouter()

    // 创建任务
    w := httptest.NewRecorder()
    req, _ := http.NewRequest("POST", "/api/missions", body)
    router.ServeHTTP(w, req)

    assert.Equal(t, 200, w.Code)
}
```

### 3. 前端测试

```typescript
// MissionCard.spec.ts
import { mount } from "@vue/test-utils";
import MissionCard from "@/components/MissionCard.vue";

describe("MissionCard", () => {
  it("renders mission title", () => {
    const wrapper = mount(MissionCard, {
      props: {
        mission: { id: 1, title: "Test Mission" },
      },
    });
    expect(wrapper.text()).toContain("Test Mission");
  });
});
```
