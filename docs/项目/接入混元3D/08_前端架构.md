# 混元3D接入 - 前端架构

## 目录结构

```
src/views/editor/components/NetTextureLibs/
├── NetTextureLibs.tsx          # 主组件（已存在）
├── NetAssetLibs.tsx            # 资产库Tab（已存在）
├── NetHunyuanLibs.tsx          # 混元3D Tab（新增）
└── NetHunyuan/                 # 混元3D模块
    ├── index.ts                # 导出
    ├── types.ts                # 类型定义
    ├── api.ts                  # API调用
    └── utils.ts                # 工具函数
```

## 类型定义 (types.ts)

```typescript
// 任务状态
export type TaskStatus = "WAIT" | "RUN" | "DONE" | "FAIL";

// 输入类型
export type InputType = "text" | "image" | "multi_view";

// 任务信息
export interface HunyuanTask {
  id: number;
  jobId: string;
  status: TaskStatus;
  inputType: InputType;
  prompt?: string;
  imageUrl?: string;

  model: string; // 默认 3.1
  faceCount?: number;
  enablePbr: boolean; // 默认 true
  resultFormat: string; // 默认 GLB

  errorCode?: string;
  errorMessage?: string;

  localPath?: string;
  nasPath?: string;
  thumbnailPath?: string;
  fileSize?: number;

  name: string;
  description?: string;
  tags?: string[];
  category: string;

  createdBy: string;
  createdAt: string;
  updatedAt: string;
}

// 提交参数
export interface SubmitParams {
  inputType: InputType;
  prompt?: string;
  imageUrl?: string;
  imageBase64?: string;

  name?: string;
  description?: string;
  tags?: string[];
}

// 任务列表响应
export interface TaskListResponse {
  list: HunyuanTask[];
  total: number;
  page: number;
  pageSize: number;
}

// 统计信息
export interface Statistics {
  total: number;
  waiting: number;
  running: number;
  done: number;
  failed: number;
  todayCount: number;
  successRate: number;
}
```

## API调用 (api.ts)

```typescript
import { request } from "@/utils/request";

const BASE_URL = "/api/hunyuan";

// 提交任务
export const submitTask = (params: SubmitParams) =>
  request.post<HunyuanTask>(`${BASE_URL}/tasks`, params);

// 获取任务列表
export const getTaskList = (params: {
  page: number;
  pageSize: number;
  status?: TaskStatus;
  inputType?: InputType;
}) => request.get<TaskListResponse>(`${BASE_URL}/tasks`, { params });

// 获取任务详情
export const getTask = (id: number) =>
  request.get<HunyuanTask>(`${BASE_URL}/tasks/${id}`);

// 轮询任务
export const pollTask = (id: number) =>
  request.post(`${BASE_URL}/tasks/${id}/poll`);

// 删除任务
export const deleteTask = (id: number) =>
  request.delete(`${BASE_URL}/tasks/${id}`);

// 获取统计信息
export const getStatistics = () =>
  request.get<Statistics>(`${BASE_URL}/statistics`);
```

## 主组件 (NetHunyuanLibs.tsx)

```typescript
import { defineComponent, ref, onMounted } from 'vue'
import { getTaskList, submitTask, pollTask, deleteTask, getStatistics } from './NetHunyuan/api'
import type { HunyuanTask, SubmitParams, Statistics } from './NetHunyuan/types'

export default defineComponent({
  name: 'NetHunyuanLibs',
  setup() {
    // 状态
    const tasks = ref<HunyuanTask[]>([])
    const loading = ref(false)
    const stats = ref<Statistics | null>(null)
    const currentPage = ref(1)
    const pageSize = ref(24)
    const total = ref(0)

    // 筛选
    const statusFilter = ref<string>()
    const inputTypeFilter = ref<string>()
    const keyword = ref('')

    // 加载数据
    const loadTasks = async () => {
      loading.value = true
      try {
        const res = await getTaskList({
          page: currentPage.value,
          pageSize: pageSize.value,
          status: statusFilter.value as any,
          inputType: inputTypeFilter.value as any
        })
        tasks.value = res.data.list
        total.value = res.data.total
      } finally {
        loading.value = false
      }
    }

    // 加载统计
    const loadStats = async () => {
      const res = await getStatistics()
      stats.value = res.data
    }

    // 提交任务
    const handleSubmit = async (params: SubmitParams) => {
      await submitTask(params)
      await loadTasks()
      await loadStats()
    }

    // 轮询任务
    const handlePoll = async (id: number) => {
      await pollTask(id)
      await loadTasks()
      await loadStats()
    }

    // 删除任务
    const handleDelete = async (id: number) => {
      await deleteTask(id)
      await loadTasks()
      await loadStats()
    }

    onMounted(() => {
      loadTasks()
      loadStats()
    })

    return () => (
      <div class="net-hunyuan-libs">
        {/* 统计信息 */}
        <div class="stats-bar">
          <span>总任务: {stats.value?.total || 0}</span>
          <span>等待: {stats.value?.waiting || 0}</span>
          <span>运行: {stats.value?.running || 0}</span>
          <span>完成: {stats.value?.done || 0}</span>
          <span>失败: {stats.value?.failed || 0}</span>
        </div>

        {/* 筛选栏 */}
        <div class="filter-bar">
          <input
            v-model={keyword.value}
            placeholder="搜索任务..."
          />
          <select v-model={statusFilter.value}>
            <option value="">全部状态</option>
            <option value="WAIT">等待中</option>
            <option value="RUN">运行中</option>
            <option value="DONE">已完成</option>
            <option value="FAIL">失败</option>
          </select>
          <button onClick={loadTasks}>刷新</button>
        </div>

        {/* 任务列表 */}
        <div class="task-grid">
          {tasks.value.map(task => (
            <div key={task.id} class="task-card">
              <img src={task.thumbnailPath} />
              <div class="task-info">
                <div class="task-name">{task.name}</div>
                <div class="task-status">{task.status}</div>
              </div>
              <div class="task-actions">
                {task.status === 'WAIT' || task.status === 'RUN' ? (
                  <button onClick={() => handlePoll(task.id)}>轮询</button>
                ) : null}
                <button onClick={() => handleDelete(task.id)}>删除</button>
              </div>
            </div>
          ))}
        </div>

        {/* 分页 */}
        <div class="pagination">
          <button
            disabled={currentPage.value === 1}
            onClick={() => { currentPage.value--; loadTasks() }}
          >
            上一页
          </button>
          <span>{currentPage.value} / {Math.ceil(total.value / pageSize.value)}</span>
          <button
            disabled={currentPage.value >= Math.ceil(total.value / pageSize.value)}
            onClick={() => { currentPage.value++; loadTasks() }}
          >
            下一页
          </button>
        </div>
      </div>
    )
  }
})
```

## 工具函数 (utils.ts)

```typescript
import type { TaskStatus } from "./types";

// 状态文本
export const getStatusText = (status: TaskStatus): string => {
  const map = { WAIT: "等待中", RUN: "运行中", DONE: "已完成", FAIL: "失败" };
  return map[status];
};

// 状态颜色
export const getStatusColor = (status: TaskStatus): string => {
  const map = {
    WAIT: "#999",
    RUN: "#1890ff",
    DONE: "#52c41a",
    FAIL: "#f5222d",
  };
  return map[status];
};

// 格式化文件大小
export const formatFileSize = (bytes?: number): string => {
  if (!bytes) return "-";
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
  return `${(bytes / 1024 / 1024).toFixed(2)} MB`;
};

// 轮询直到完成
export const pollUntilDone = async (
  taskId: number,
  pollFn: (id: number) => Promise<any>,
  interval = 5000,
  maxAttempts = 100,
): Promise<void> => {
  for (let i = 0; i < maxAttempts; i++) {
    const result = await pollFn(taskId);
    if (result.status === "DONE" || result.status === "FAIL") return;
    await new Promise((resolve) => setTimeout(resolve, interval));
  }
  throw new Error("轮询超时");
};
```

## 集成到主组件

### 更新 NetTextureLibs.tsx

```typescript
import NetHunyuanLibs from './NetHunyuanLibs'

// 在 Tab 中添加
<SelectTab
  list={[
    { name: '贴图库', key: 0 },
    { name: '模型库', key: 1 },
    { name: '资产库', key: 2 },
    { name: '混元3D', key: 3 }  // 新增
  ]}
  value={activeTab.value}
  onChange={(key) => activeTab.value = key}
/>

// 在内容区添加
{activeTab.value === 3 && <NetHunyuanLibs />}
```

## 样式复用

直接复用现有的样式类：

- `.custom-content` - 主容器
- `.list` - 左侧筛选栏
- `.content` - 右侧内容区
- `.texture-grid` - 网格布局
- `.texture-card` - 卡片样式
- `.search-bar` - 搜索栏
- `.pagination` - 分页

## 关键功能

1. **任务提交** - 文生3D/图生3D
2. **任务列表** - 分页、筛选、排序
3. **任务轮询** - 自动或手动轮询
4. **文件下载** - 自动保存到本地/NAS
5. **拖拽应用** - 拖拽GLB文件到场景
6. **右键菜单** - 删除、重试、预览

## 注意事项

- 默认使用3.1模型
- 默认启用PBR材质
- 默认导出GLB格式
- 支持本地和NAS存储
- 轮询间隔5秒
- 最大并发3个任务
