# 中间件设计

## AuthMiddleware 认证中间件

已有实现，位于 `middleware/auth.go`

```go
func (j *JWTAuth) AuthMiddleware() gin.HandlerFunc
```

**功能：**

- 从请求中提取 Token
- 验证 Token 有效性
- 将用户信息存入上下文
- 未认证返回 401

**使用：**

```go
protected := api.Group("/protected")
protected.Use(jwtAuth.AuthMiddleware())
```

## RequirePermission 权限验证中间件

```go
func RequirePermission(resource, action string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)

        // 获取用户权限
        perms := GetUserPermissions(userID)

        // 检查权限
        required := fmt.Sprintf("%s:%s", resource, action)
        if !MatchPermission(perms, required) {
            response.Forbidden(c, "权限不足")
            c.Abort()
            return
        }

        c.Next()
    }
}
```

**使用：**

```go
documents.PUT("/:id",
    RequirePermission("documents", "update"),
    documentController.Update,
)
```

## RequireAnyPermission 任一权限验证

```go
func RequireAnyPermission(permissions ...string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)
        userPerms := GetUserPermissions(userID)

        for _, perm := range permissions {
            if MatchPermission(userPerms, perm) {
                c.Next()
                return
            }
        }

        response.Forbidden(c, "权限不足")
        c.Abort()
    }
}
```

**使用：**

```go
// 需要文档读取或管理权限
documents.GET("/:id",
    RequireAnyPermission("documents:read", "documents:admin"),
    documentController.GetDetail,
)
```

## RequireAllPermissions 全部权限验证

```go
func RequireAllPermissions(permissions ...string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)
        userPerms := GetUserPermissions(userID)

        for _, perm := range permissions {
            if !MatchPermission(userPerms, perm) {
                response.Forbidden(c, "权限不足")
                c.Abort()
                return
            }
        }

        c.Next()
    }
}
```

## RequireOwnership 所有权验证中间件

```go
func RequireOwnership(resourceType string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)
        resourceID := c.Param("id")

        // 检查是否是资源所有者
        if !IsOwner(userID, resourceType, resourceID) {
            // 检查是否有管理权限
            if !HasPermission(userID, resourceType, "admin") {
                response.Forbidden(c, "无权访问此资源")
                c.Abort()
                return
            }
        }

        c.Next()
    }
}
```

**使用：**

```go
documents.DELETE("/:id",
    RequireOwnership("documents"),
    documentController.Delete,
)
```

## RequireRole 角色验证中间件

已有实现，位于 `middleware/auth.go`

```go
func (j *JWTAuth) RoleMiddleware(roles ...string) gin.HandlerFunc
```

**使用：**

```go
admin := api.Group("/admin")
admin.Use(jwtAuth.RoleMiddleware("admin", "super_admin"))
```

## RequireResourcePermission 资源权限验证

```go
func RequireResourcePermission(resourceType, permission string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)
        resourceID := c.Param("id")

        // 检查资源权限
        if !HasResourcePermission(userID, resourceType, resourceID, permission) {
            response.Forbidden(c, "无权访问此资源")
            c.Abort()
            return
        }

        c.Next()
    }
}
```

**使用：**

```go
documents.GET("/:id/download",
    RequireResourcePermission("documents", "download"),
    documentController.Download,
)
```

## OptionalAuth 可选认证中间件

已有实现，位于 `middleware/auth.go`

```go
func (j *JWTAuth) OptionalAuthMiddleware() gin.HandlerFunc
```

**功能：**

- 尝试提取和验证 Token
- 如果有效，存入用户信息
- 无 Token 或无效不阻止请求

**使用：**

```go
// 公开接口，但登录用户可获得额外信息
documents.GET("",
    jwtAuth.OptionalAuthMiddleware(),
    documentController.List,
)
```

## PermissionCache 权限缓存中间件

```go
func PermissionCacheMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := middleware.GetUserID(c)

        // 尝试从缓存获取权限
        perms, found := GetCachedPermissions(userID)
        if !found {
            // 计算并缓存权限
            perms = CalculateUserPermissions(userID)
            CacheUserPermissions(userID, perms)
        }

        // 存入上下文
        c.Set("user_permissions", perms)
        c.Next()
    }
}
```

## 中间件组合使用

```go
// 需要认证 + 权限验证
documents.PUT("/:id",
    jwtAuth.AuthMiddleware(),
    RequirePermission("documents", "update"),
    RequireOwnership("documents"),
    documentController.Update,
)

// 需要认证 + 角色验证
users.POST("",
    jwtAuth.AuthMiddleware(),
    jwtAuth.RoleMiddleware("admin", "super_admin"),
    userController.Create,
)

// 需要认证 + 多个权限
admin.GET("/dashboard",
    jwtAuth.AuthMiddleware(),
    RequireAllPermissions("users:read", "roles:read", "permissions:read"),
    adminController.Dashboard,
)
```

## 辅助函数

```go
// 从上下文获取用户权限
func GetUserPermissions(c *gin.Context) []string {
    if perms, exists := c.Get("user_permissions"); exists {
        return perms.([]string)
    }

    userID := middleware.GetUserID(c)
    return CalculateUserPermissions(userID)
}

// 权限匹配
func MatchPermission(userPerms []string, required string) bool {
    // 精确匹配
    if contains(userPerms, required) {
        return true
    }

    // 通配符匹配
    parts := strings.Split(required, ":")
    if len(parts) == 2 {
        resource, action := parts[0], parts[1]

        // resource:*
        if contains(userPerms, resource+":*") {
            return true
        }

        // *:action
        if contains(userPerms, "*:"+action) {
            return true
        }

        // *:*
        if contains(userPerms, "*:*") {
            return true
        }
    }

    return false
}

// 检查是否是资源所有者
func IsOwner(userID uint, resourceType string, resourceID string) bool {
    // 根据资源类型查询所有者
    // 实现逻辑...
}

// 检查资源权限
func HasResourcePermission(userID uint, resourceType string, resourceID string, permission string) bool {
    // 查询 resource_permissions 表
    // 实现逻辑...
}
```

## 错误处理

```go
// 统一权限错误响应
func PermissionDenied(c *gin.Context, message string) {
    response.Forbidden(c, message)

    // 记录审计日志
    auditLog := models.AuditLog{
        UserID:     middleware.GetUserID(c),
        Action:     "permission_denied",
        Resource:   c.Request.URL.Path,
        StatusCode: 403,
        ErrorMsg:   message,
    }
    // 保存日志...
}
```
