# 项目管理系统 - 后端设计

## 概述

提供项目管理的后端服务，支持项目创建、版本上传、历史管理等功能，复用现有文件上传服务。

## 配置文件

### configs/project_config.yaml

```yaml
project:
  # 本地存储配置
  local_storage_enabled: false
  storage_dir: "static/projects"

  # 网络访问配置
  base_url: "http://192.168.3.39:23359/projects"

  # NAS存储配置
  nas_enabled: true
  nas_path: "\\\\192.168.3.10\\project\\editor_v2\\static\\projects"

  # 文件限制
  max_file_size: 524288000 # 500MB
  max_project_size: 1073741824 # 1GB

  # 版本配置
  default_initial_version: "1.0.0"
  version_format: "semantic" # semantic | custom

  # 压缩配置
  enable_compression: true
  compression_format: "zip"
```

## 数据模型

### models/project.go

```go
// Project 项目表
type Project struct {
  ID              uint       `gorm:"primaryKey" json:"id"`
  Name            string     `gorm:"size:200;uniqueIndex" json:"name"`
  Description     string     `gorm:"type:text" json:"description"`
  CurrentVersion  string     `gorm:"size:20" json:"current_version"`
  LatestVersionID uint       `json:"latest_version_id"`

  CreatedAt       time.Time  `json:"created_at"`
  UpdatedAt       time.Time  `json:"updated_at"`

  // 关联
  Versions        []ProjectVersion `gorm:"foreignKey:ProjectID" json:"versions,omitempty"`
}

// ProjectVersion 项目版本表
type ProjectVersion struct {
  ID          uint       `gorm:"primaryKey" json:"id"`
  ProjectID   uint       `gorm:"index" json:"project_id"`
  Version     string     `gorm:"size:20;index" json:"version"`
  Username    string     `gorm:"size:100" json:"username"`
  Description string     `gorm:"type:text" json:"description"`

  // 文件信息
  FilePath    string     `gorm:"size:512" json:"file_path"`
  FileSize    int64      `json:"file_size"`
  FileHash    string     `gorm:"size:64" json:"file_hash"`

  // 元数据
  FileCount   int        `json:"file_count"`
  UploadIP    string     `gorm:"size:50" json:"upload_ip"`

  CreatedAt   time.Time  `json:"created_at"`

  // 虚拟字段
  FileURL     string     `gorm:"-" json:"file_url"`
}

// AfterFind 查询后钩子
func (pv *ProjectVersion) AfterFind(tx *gorm.DB) error {
  if pv.FilePath != "" {
    pv.FileURL = buildProjectURL(pv.FilePath)
  }
  return nil
}
```

## 控制器

### controllers/project_controller.go

```go
type ProjectController struct {
  service *services.ProjectService
}

// GetProjects 获取项目列表
func (pc *ProjectController) GetProjects(c *gin.Context) {
  params := QueryParams{
    Page:     c.Query("page"),
    PageSize: c.Query("page_size"),
    Keyword:  c.Query("keyword"),
  }
  // 返回分页数据
}

// CreateProject 创建项目
func (pc *ProjectController) CreateProject(c *gin.Context) {
  var req CreateProjectRequest
  // 验证并创建项目
}

// UploadVersion 上传版本
func (pc *ProjectController) UploadVersion(c *gin.Context) {
  // 处理文件上传
  // 解析表单数据
  // 保存版本信息
}

// GetVersionHistory 获取版本历史
func (pc *ProjectController) GetVersionHistory(c *gin.Context) {
  projectID := c.Param("id")
  // 返回版本列表
}

// DeleteProject 删除项目
func (pc *ProjectController) DeleteProject(c *gin.Context) {
  projectID := c.Param("id")
  // 删除项目及所有版本
}

// DownloadVersion 下载版本
func (pc *ProjectController) DownloadVersion(c *gin.Context) {
  versionID := c.Param("id")
  // 返回文件下载
}

// RollbackVersion 回滚版本
func (pc *ProjectController) RollbackVersion(c *gin.Context) {
  versionID := c.Param("id")
  // 将指定版本设为当前版本
}
```

## 服务层

### services/project_service.go

```go
type ProjectService struct {
  db            *gorm.DB
  config        *config.ProjectConfig
  storageService *StorageService
}

// CreateProject 创建项目
func (ps *ProjectService) CreateProject(req CreateProjectRequest) (*Project, error) {
  project := &Project{
    Name:           req.Name,
    Description:    req.Description,
    CurrentVersion: ps.config.DefaultInitialVersion,
  }
  // 保存到数据库
  return project, nil
}

// UploadVersion 上传版本
func (ps *ProjectService) UploadVersion(req UploadVersionRequest) (*ProjectVersion, error) {
  // 1. 验证项目存在
  // 2. 计算新版本号
  // 3. 压缩文件夹
  // 4. 上传到存储（NAS/本地）
  // 5. 保存版本记录
  // 6. 更新项目当前版本
}

// GetVersionHistory 获取版本历史
func (ps *ProjectService) GetVersionHistory(projectID uint) ([]ProjectVersion, error) {
  var versions []ProjectVersion
  // 按创建时间倒序查询
  return versions, nil
}

// DeleteProject 删除项目
func (ps *ProjectService) DeleteProject(projectID uint) error {
  // 1. 查询所有版本
  // 2. 删除所有版本文件
  // 3. 删除数据库记录
}

// RollbackVersion 回滚版本
func (ps *ProjectService) RollbackVersion(versionID uint) error {
  // 1. 查询版本信息
  // 2. 更新项目当前版本
}

// CalculateNextVersion 计算下一个版本号
func (ps *ProjectService) CalculateNextVersion(current string, versionType string) (string, error) {
  // 解析当前版本号
  // 根据类型递增
  // major: 1.0.0 -> 2.0.0
  // minor: 1.0.0 -> 1.1.0
  // patch: 1.0.0 -> 1.0.1
}
```

## 文件处理

### utils/archive.go

```go
type ArchiveUtil struct{}

// CompressFolder 压缩文件夹
func (au *ArchiveUtil) CompressFolder(sourcePath string, destPath string) error {
  // 创建zip文件
  // 遍历文件夹
  // 添加所有文件到zip
  // 返回压缩文件路径
}

// ExtractArchive 解压文件
func (au *ArchiveUtil) ExtractArchive(archivePath string, destPath string) error {
  // 解压zip文件到指定目录
}

// CalculateHash 计算文件哈希
func (au *ArchiveUtil) CalculateHash(filePath string) (string, error) {
  // 计算MD5哈希值
}

// CountFiles 统计文件数量
func (au *ArchiveUtil) CountFiles(folderPath string) (int, error) {
  // 递归统计文件数量
}
```

## 存储服务复用

### services/storage_service.go

```go
// 复用现有的存储服务
type StorageService struct {
  config *config.StorageConfig
}

// SaveToNAS 保存到NAS
func (ss *StorageService) SaveToNAS(localPath string, remotePath string) error {
  // 复用现有NAS上传逻辑
}

// SaveToLocal 保存到本地
func (ss *StorageService) SaveToLocal(sourcePath string, destPath string) error {
  // 复用现有本地存储逻辑
}

// DeleteFile 删除文件
func (ss *StorageService) DeleteFile(filePath string) error {
  // 删除NAS或本地文件
}
```

## 路由配置

### api/routes.go

```go
func SetupProjectRoutes(r *gin.Engine) {
  pc := controllers.NewProjectController()

  projectGroup := r.Group("/api/projects")
  {
    projectGroup.GET("", pc.GetProjects)
    projectGroup.POST("", pc.CreateProject)
    projectGroup.POST("/:id/versions", pc.UploadVersion)
    projectGroup.GET("/:id/versions", pc.GetVersionHistory)
    projectGroup.DELETE("/:id", pc.DeleteProject)
    projectGroup.GET("/versions/:id/download", pc.DownloadVersion)
    projectGroup.POST("/versions/:id/rollback", pc.RollbackVersion)
  }
}
```

## 数据库迁移

### database/migrations/xxx_create_projects.go

```go
func CreateProjectTables(db *gorm.DB) error {
  // 创建projects表
  if err := db.AutoMigrate(&Project{}); err != nil {
    return err
  }

  // 创建project_versions表
  if err := db.AutoMigrate(&ProjectVersion{}); err != nil {
    return err
  }

  return nil
}
```

## 请求/响应结构

### types/project.go

```go
// CreateProjectRequest 创建项目请求
type CreateProjectRequest struct {
  Name        string `json:"name" binding:"required,max=200"`
  Description string `json:"description"`
}

// UploadVersionRequest 上传版本请求
type UploadVersionRequest struct {
  ProjectID   uint   `form:"project_id" binding:"required"`
  Username    string `form:"username" binding:"required,max=100"`
  Description string `form:"description"`
  VersionType string `form:"version_type" binding:"required,oneof=major minor patch"`
  Files       []*multipart.FileHeader `form:"files"`
}

// ProjectListResponse 项目列表响应
type ProjectListResponse struct {
  Total    int64     `json:"total"`
  Page     int       `json:"page"`
  PageSize int       `json:"page_size"`
  Data     []Project `json:"data"`
}
```

## 错误处理

- 项目名称重复检查
- 文件大小限制验证
- 版本号格式验证
- 存储空间检查
- 并发上传控制

## 日志记录

- 项目创建日志
- 版本上传日志
- 文件操作日志
- 错误日志
