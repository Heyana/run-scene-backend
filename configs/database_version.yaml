# 数据库版本配置
# 修改此版本号会触发相应的升级任务

# 当前数据库版本
# 修改此值会触发从当前版本到目标版本之间的所有升级任务
version: 7

# 版本历史记录
history:
  - version: 1
    date: "2026-01-20"
    description: "基础清理和修复"
    tasks:
      - "清理空 CDN 路径的文件记录"
      - "更新 CDN 路径为相对路径"
      - "删除重复的文件记录"
      - "更新材质同步状态"
      - "修复 CDN 路径重复问题"

  - version: 2
    date: "2026-01-26"
    description: "贴图类型重新分析和映射"
    tasks:
      - "强制重新分析所有文件的贴图类型"
      - "强制重新更新所有材质的贴图类型列表"
      - "支持 PolyHaven 和 AmbientCG 两个数据源"
      - "更新 Three.js 类型映射规则"
    affected:
      files: 5716
      textures: 2692

  - version: 3
    date: "2026-01-26"
    description: "改进 AmbientCG 贴图类型提取"
    tasks:
      - "修复 AmbientCG 文件名解析逻辑"
      - "正确提取 Color、NormalGL、Roughness 等类型"
      - "重新分析所有 AmbientCG 贴图"
    affected:
      files: 5716
      textures: 2692

  - version: 4
    date: "2026-01-26"
    description: "清理丢失的文件记录"
    tasks:
      - "检查所有文件记录对应的物理文件是否存在"
      - "删除物理文件不存在的数据库记录"
      - "更新材质的下载状态和同步状态"
      - "触发重新下载丢失的文件"
    note: "解决文件实际不存在但数据库显示已下载的问题"

  - version: 5
    date: "2026-01-26"
    description: "修复下载服务的贴图类型解析"
    tasks:
      - "统一使用 ExtractTextureType 函数解析贴图类型"
      - "重新分析所有已下载文件的贴图类型"
      - "修复 Opacity 等类型被错误标记为 other 的问题"
    note: "确保下载和同步使用相同的类型解析逻辑"

  - version: 6
    date: "2026-02-12"
    description: "添加文件夹递归统计功能"
    tasks:
      - "添加 total_size 字段：递归统计所有子文件的总大小"
      - "添加 total_count 字段：递归统计所有子文件的总数量"
      - "添加 stats_updated_at 字段：统计信息更新时间"
      - "计算所有现有文件夹的统计信息"
      - "配置 GORM 钩子自动更新统计"
    note: "支持文件夹递归统计，自动维护数据一致性"

  - version: 7
    date: "2026-02-12"
    description: "创建审计日志系统"
    tasks:
      - "创建 audit_logs 表"
      - "支持记录用户操作历史"
      - "支持 IP、用户、时间、操作类型等信息"
      - "支持自动归档到 NAS（7天保留策略）"
    note: "完整的审计日志系统，支持操作追溯和安全分析"

# 说明
# 1. 修改 version 值会触发升级
# 2. 系统会记住上次执行的版本号（存储在 data/.db_version 文件中）
# 3. 只会执行从上次版本到当前版本之间的所有升级任务
# 4. 如果需要重新执行某个版本的升级，删除 data/.db_version 文件或修改其内容
