# 混元3D接入 - 配置管理

## 配置文件

### config.yaml 新增配置

```yaml
# 混元3D配置
hunyuan:
  # API配置
  secret_id: "" # 腾讯云SecretId
  secret_key: "" # 腾讯云SecretKey
  region: "ap-guangzhou" # 地域

  # 默认参数
  default_model: "3.0" # 默认模型版本
  default_face_count: 500000 # 默认面数
  default_generate_type: "Normal" # 默认生成类型
  default_enable_pbr: false # 默认PBR材质

  # 任务控制
  max_concurrent: 3 # 最大并发任务数
  poll_interval: 5 # 轮询间隔（秒）
  task_timeout: 86400 # 任务超时（秒，24小时）

  # 存储配置
  auto_save_to_library: true # 自动保存到模型库
  default_category: "AI生成" # 默认分类

  # 重试配置
  max_retry_times: 3 # 最大重试次数
  retry_interval: 10 # 重试间隔（秒）
```

## 环境变量

支持通过环境变量覆盖配置：

```bash
# API配置
HUNYUAN_SECRET_ID=AKIDxxxxx
HUNYUAN_SECRET_KEY=xxxxxxxx
HUNYUAN_REGION=ap-guangzhou

# 默认参数
HUNYUAN_DEFAULT_MODEL=3.1
HUNYUAN_DEFAULT_FACE_COUNT=1000000

# 任务控制
HUNYUAN_MAX_CONCURRENT=5
HUNYUAN_POLL_INTERVAL=3

# 存储配置
HUNYUAN_AUTO_SAVE=true
HUNYUAN_DEFAULT_CATEGORY=AI生成
```

## 配置结构

### config/config.go 新增

```go
type HunyuanConfig struct {
    // API配置
    SecretID  string `yaml:"secret_id"`
    SecretKey string `yaml:"secret_key"`
    Region    string `yaml:"region"`

    // 默认参数
    DefaultModel        string `yaml:"default_model"`
    DefaultFaceCount    int    `yaml:"default_face_count"`
    DefaultGenerateType string `yaml:"default_generate_type"`
    DefaultEnablePBR    bool   `yaml:"default_enable_pbr"`

    // 任务控制
    MaxConcurrent int `yaml:"max_concurrent"`
    PollInterval  int `yaml:"poll_interval"`
    TaskTimeout   int `yaml:"task_timeout"`

    // 存储配置
    AutoSaveToLibrary bool   `yaml:"auto_save_to_library"`
    DefaultCategory   string `yaml:"default_category"`

    // 重试配置
    MaxRetryTimes int `yaml:"max_retry_times"`
    RetryInterval int `yaml:"retry_interval"`
}

// 添加到 Config 结构
type Config struct {
    // ... 现有字段
    Hunyuan HunyuanConfig
}
```

### 默认配置

```go
var DefaultHunyuanConfig = HunyuanConfig{
    Region:              "ap-guangzhou",
    DefaultModel:        "3.0",
    DefaultFaceCount:    500000,
    DefaultGenerateType: "Normal",
    DefaultEnablePBR:    false,
    MaxConcurrent:       3,
    PollInterval:        5,
    TaskTimeout:         86400,
    AutoSaveToLibrary:   true,
    DefaultCategory:     "AI生成",
    MaxRetryTimes:       3,
    RetryInterval:       10,
}
```

## 配置加载

### 加载优先级

```
环境变量 > YAML配置文件 > 数据库配置 > 默认值
```

### 加载流程

```go
func LoadHunyuanConfig() *HunyuanConfig {
    // 1. 加载默认配置
    config := DefaultHunyuanConfig

    // 2. 从YAML覆盖
    if yamlConfig := loadYAMLConfig(); yamlConfig.Hunyuan != nil {
        mergeConfig(&config, yamlConfig.Hunyuan)
    }

    // 3. 从环境变量覆盖
    if secretID := os.Getenv("HUNYUAN_SECRET_ID"); secretID != "" {
        config.SecretID = secretID
    }
    // ... 其他环境变量

    // 4. 从数据库加载（运行时配置）
    if dbConfig := loadDBConfig(); dbConfig != nil {
        mergeConfig(&config, dbConfig)
    }

    return &config
}
```

## 配置验证

### 必填项检查

```go
func ValidateConfig(config *HunyuanConfig) error {
    if config.SecretID == "" {
        return errors.New("SecretID不能为空")
    }
    if config.SecretKey == "" {
        return errors.New("SecretKey不能为空")
    }
    return nil
}
```

### 参数范围检查

```go
func ValidateParams(params *GenerateParams) error {
    // 模型版本
    if params.Model != "3.0" && params.Model != "3.1" {
        return errors.New("模型版本必须是3.0或3.1")
    }

    // 面数范围
    if params.FaceCount != nil {
        if *params.FaceCount < 10000 || *params.FaceCount > 1500000 {
            return errors.New("面数必须在10000-1500000之间")
        }
    }

    // 输入检查
    hasPrompt := params.Prompt != nil && *params.Prompt != ""
    hasImage := params.ImageBase64 != nil || params.ImageURL != nil

    if !hasPrompt && !hasImage {
        return errors.New("必须提供文本或图片")
    }
    if hasPrompt && hasImage {
        return errors.New("文本和图片不能同时存在")
    }

    return nil
}
```

## 配置更新

### 热更新支持

- 数据库配置支持热更新
- 更新后立即生效
- 不影响正在运行的任务

### 更新接口

```go
func (s *ConfigService) UpdateConfig(config *HunyuanConfig) error {
    // 1. 验证配置
    if err := ValidateConfig(config); err != nil {
        return err
    }

    // 2. 测试连接
    client := NewHunyuanClient(config.SecretID, config.SecretKey, config.Region)
    if err := client.TestConnection(); err != nil {
        return errors.New("API密钥验证失败")
    }

    // 3. 保存到数据库
    return s.db.Save(config).Error
}
```

## 安全性

### 密钥保护

- SecretKey在API响应中脱敏显示
- 日志中不记录完整密钥
- 建议使用环境变量存储

### 权限控制

- 配置管理需要管理员权限
- 普通用户只能查看部分配置
- 密钥更新需要二次确认
