# 文件库配置设计

## YAML 配置结构

在 `config.yaml` 中添加 `document` 配置段：

```yaml
# 文件库配置
document:
  # 本地存储配置
  local_storage_enabled: false
  storage_dir: "static/documents"

  # 网络访问配置
  base_url: "http://192.168.3.39:23359/documents"

  # NAS 存储配置
  nas_enabled: true
  nas_path: "\\\\192.168.3.10\\project\\editor_v2\\static\\documents"

  # 文件限制（按类型）
  max_file_size:
    document: 104857600 # 100MB
    video: 2147483648 # 2GB
    archive: 524288000 # 500MB
    other: 52428800 # 50MB

  # 允许的文件格式
  allowed_formats:
    document:
      - pdf
      - doc
      - docx
      - xls
      - xlsx
      - ppt
      - pptx
      - txt
      - md
    video:
      - mp4
      - webm
      - avi
      - mov
    archive:
      - zip
      - rar
      - 7z
    other:
      - jpg
      - png
      - gif
      - mp3
      - wav

  # 预览配置
  preview:
    enabled: true
    pdf_to_image: true # PDF转图片预览
    max_preview_pages: 10 # 最多预览页数
    preview_quality: 85 # 预览图质量
    preview_width: 800 # 预览图宽度

  # 视频处理配置
  video:
    ffmpeg_path: "ffmpeg"
    thumbnail_time: 1.0 # 截图时间点（秒）
    thumbnail_count: 3 # 生成缩略图数量

  # 版本控制
  version_control:
    enabled: true
    max_versions: 10 # 保留最大版本数
    auto_version: true # 自动版本号

  # 权限配置
  permission:
    enable_department: true # 启用部门隔离
    enable_project: true # 启用项目隔离
    default_public: false # 默认是否公开

  # 日志配置
  log:
    enabled: true
    log_access: true # 记录访问日志
    log_retention_days: 90 # 日志保留天数
```

## Go 配置结构

在 `config/config.go` 中添加：

### YAMLConfig 扩展

```go
type YAMLConfig struct {
    // ... 现有字段

    Document struct {
        LocalStorageEnabled bool                    `yaml:"local_storage_enabled"`
        StorageDir          string                  `yaml:"storage_dir"`
        BaseURL             string                  `yaml:"base_url"`
        NASEnabled          bool                    `yaml:"nas_enabled"`
        NASPath             string                  `yaml:"nas_path"`
        MaxFileSize         map[string]int64        `yaml:"max_file_size"`
        AllowedFormats      map[string][]string     `yaml:"allowed_formats"`
        Preview             struct {
            Enabled         bool   `yaml:"enabled"`
            PDFToImage      bool   `yaml:"pdf_to_image"`
            MaxPreviewPages int    `yaml:"max_preview_pages"`
            PreviewQuality  int    `yaml:"preview_quality"`
            PreviewWidth    int    `yaml:"preview_width"`
        } `yaml:"preview"`
        Video struct {
            FFmpegPath      string  `yaml:"ffmpeg_path"`
            ThumbnailTime   float64 `yaml:"thumbnail_time"`
            ThumbnailCount  int     `yaml:"thumbnail_count"`
        } `yaml:"video"`
        VersionControl struct {
            Enabled     bool `yaml:"enabled"`
            MaxVersions int  `yaml:"max_versions"`
            AutoVersion bool `yaml:"auto_version"`
        } `yaml:"version_control"`
        Permission struct {
            EnableDepartment bool `yaml:"enable_department"`
            EnableProject    bool `yaml:"enable_project"`
            DefaultPublic    bool `yaml:"default_public"`
        } `yaml:"permission"`
        Log struct {
            Enabled           bool `yaml:"enabled"`
            LogAccess         bool `yaml:"log_access"`
            LogRetentionDays  int  `yaml:"log_retention_days"`
        } `yaml:"log"`
    } `yaml:"document"`
}
```

### DocumentConfig 结构

```go
type DocumentConfig struct {
    // 存储配置
    LocalStorageEnabled bool
    StorageDir          string
    BaseURL             string
    NASEnabled          bool
    NASPath             string

    // 文件限制
    MaxFileSize    map[string]int64
    AllowedFormats map[string][]string

    // 预览配置
    PreviewEnabled      bool
    PDFToImage          bool
    MaxPreviewPages     int
    PreviewQuality      int
    PreviewWidth        int

    // 视频配置
    FFmpegPath         string
    VideoThumbnailTime float64
    VideoThumbnailCount int

    // 版本控制
    VersionControlEnabled bool
    MaxVersions           int
    AutoVersion           bool

    // 权限配置
    EnableDepartment bool
    EnableProject    bool
    DefaultPublic    bool

    // 日志配置
    LogEnabled          bool
    LogAccess           bool
    LogRetentionDays    int
}
```

### Config 结构扩展

```go
type Config struct {
    // ... 现有字段
    Document DocumentConfig // 文件库配置
}
```

## 默认配置

```go
// 在 loadYAMLConfig() 中添加默认值
defaultConfig.Document.LocalStorageEnabled = false
defaultConfig.Document.StorageDir = "static/documents"
defaultConfig.Document.BaseURL = ""
defaultConfig.Document.NASEnabled = true
defaultConfig.Document.NASPath = ""
defaultConfig.Document.MaxFileSize = map[string]int64{
    "document": 104857600,  // 100MB
    "video":    2147483648, // 2GB
    "archive":  524288000,  // 500MB
    "other":    52428800,   // 50MB
}
defaultConfig.Document.AllowedFormats = map[string][]string{
    "document": {"pdf", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "txt", "md"},
    "video":    {"mp4", "webm", "avi", "mov"},
    "archive":  {"zip", "rar", "7z"},
    "other":    {"jpg", "png", "gif", "mp3", "wav"},
}
defaultConfig.Document.Preview.Enabled = true
defaultConfig.Document.Preview.PDFToImage = true
defaultConfig.Document.Preview.MaxPreviewPages = 10
defaultConfig.Document.Preview.PreviewQuality = 85
defaultConfig.Document.Preview.PreviewWidth = 800
defaultConfig.Document.Video.FFmpegPath = "ffmpeg"
defaultConfig.Document.Video.ThumbnailTime = 1.0
defaultConfig.Document.Video.ThumbnailCount = 3
defaultConfig.Document.VersionControl.Enabled = true
defaultConfig.Document.VersionControl.MaxVersions = 10
defaultConfig.Document.VersionControl.AutoVersion = true
defaultConfig.Document.Permission.EnableDepartment = true
defaultConfig.Document.Permission.EnableProject = true
defaultConfig.Document.Permission.DefaultPublic = false
defaultConfig.Document.Log.Enabled = true
defaultConfig.Document.Log.LogAccess = true
defaultConfig.Document.Log.LogRetentionDays = 90
```

## 环境变量支持

支持通过环境变量覆盖配置：

- `DOCUMENT_LOCAL_STORAGE_ENABLED`
- `DOCUMENT_STORAGE_DIR`
- `DOCUMENT_BASE_URL`
- `DOCUMENT_NAS_ENABLED`
- `DOCUMENT_NAS_PATH`
- `DOCUMENT_PREVIEW_ENABLED`
- `DOCUMENT_VERSION_CONTROL_ENABLED`
- 等等...
