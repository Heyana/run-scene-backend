# 代码修改

## 修改 main.go

### 修改前

```go
// 阻塞主线程，保持服务器运行
select {}
```

### 修改后

```go
// 优雅停机
server.WaitForShutdown(appCore)
```

---

## 新增函数

### server/graceful.go

已在之前创建，主要函数：

```go
// WaitForShutdown 等待关闭信号并执行优雅停机
func WaitForShutdown(appCore interface{ Shutdown() })

// GracefulShutdown 优雅关闭管理器
type GracefulShutdown struct {
    ShutdownTimeout time.Duration  // 默认 30 秒
}

func (g *GracefulShutdown) ListenForShutdown()
func (g *GracefulShutdown) Shutdown()
```

### core/app_core.go 新增

```go
// Shutdown 执行优雅停机
func (a *AppCore) Shutdown() {
    // 1. 停止备份调度器
    // 2. 停止 HTTP 服务器
    // 3. 关闭数据库连接
}
```

---

## 完整修改清单

| 文件                   | 修改                       |
| ---------------------- | -------------------------- |
| `main.go`              | 替换 `select{}` 为信号监听 |
| `core/app_core.go`     | 新增 `Shutdown()` 方法     |
| `server/graceful.go`   | 已创建，无需修改           |
| `database/database.go` | 确认 `Close()` 函数存在    |

---

## 相关文档

- [概述](./01_概述.md)
- [部署集成](./03_部署集成.md)
