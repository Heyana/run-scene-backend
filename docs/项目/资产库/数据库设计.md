# 数据库设计

## 表结构概览

```
assets (资产主表)
├── asset_tags (资产-标签关联，复用 tags 表)
├── asset_metadata (类型特定元数据)
└── asset_metrics (统计指标)
```

---

## 1. 资产主表 (assets)

```go
type Asset struct {
    ID            uint       `gorm:"primaryKey" json:"id"`
    Name          string     `gorm:"size:200;index" json:"name"`
    Description   string     `gorm:"type:text" json:"description"`
    Category      string     `gorm:"size:50;index" json:"category"`
    Tags          string     `gorm:"type:text" json:"tags"` // 逗号分隔
    Type          string     `gorm:"size:20;index" json:"type"` // image, video

    // 文件信息
    FileSize      int64      `json:"file_size"` // 字节
    FilePath      string     `gorm:"size:512" json:"file_path"` // 资产文件相对路径
    FileHash      string     `gorm:"size:64;index" json:"file_hash"` // MD5
    Format        string     `gorm:"size:20" json:"format"` // jpg, png, hdr, mp4等

    // 预览图
    ThumbnailPath string     `gorm:"size:512" json:"thumbnail_path"` // 缩略图路径

    // 使用统计
    UseCount      int        `gorm:"default:0;index" json:"use_count"`
    LastUsedAt    *time.Time `json:"last_used_at"`

    // 上传信息
    UploadedBy    string     `gorm:"size:100" json:"uploaded_by"`
    UploadIP      string     `gorm:"size:50" json:"upload_ip"`

    CreatedAt     time.Time  `json:"created_at"`
    UpdatedAt     time.Time  `json:"updated_at"`
}
```

**索引**：

- `name`, `category`, `type`, `format` (普通)
- `use_count` (排序)
- `file_hash` (去重)

---

## 2. 资产元数据表 (asset_metadata)

存储类型特定的元数据

```go
type AssetMetadata struct {
    ID        uint      `gorm:"primaryKey" json:"id"`
    AssetID   uint      `gorm:"uniqueIndex" json:"asset_id"`

    // 图片/贴图元数据
    Width     int       `json:"width,omitempty"`
    Height    int       `json:"height,omitempty"`
    ColorMode string    `gorm:"size:20" json:"color_mode,omitempty"` // RGB, RGBA, Grayscale
    DPI       int       `json:"dpi,omitempty"`

    // 视频元数据
    Duration  float64   `json:"duration,omitempty"` // 秒
    FrameRate float64   `json:"frame_rate,omitempty"`
    Codec     string    `gorm:"size:50" json:"codec,omitempty"`
    Bitrate   int       `json:"bitrate,omitempty"` // kbps

    // 音频元数据
    SampleRate int      `json:"sample_rate,omitempty"` // Hz
    Channels   int      `json:"channels,omitempty"` // 1=单声道, 2=立体声

    // HDR/环境图元数据
    Projection string   `gorm:"size:50" json:"projection,omitempty"` // equirectangular, cubemap
    DynamicRange string `gorm:"size:20" json:"dynamic_range,omitempty"` // SDR, HDR

    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}
```

---

## 3. 资产-标签关联表 (asset_tags)

```go
type AssetTag struct {
    ID        uint      `gorm:"primaryKey" json:"id"`
    AssetID   uint      `gorm:"index" json:"asset_id"`
    TagID     uint      `gorm:"index" json:"tag_id"` // 复用 tags 表
    CreatedAt time.Time `json:"created_at"`
}
```

**说明**：复用贴图库的 `tags` 表，统一管理标签

---

## 4. 统计指标表 (asset_metrics)

```go
type AssetMetrics struct {
    ID            uint      `gorm:"primaryKey" json:"id"`
    Date          string    `gorm:"uniqueIndex;size:10" json:"date"` // YYYY-MM-DD
    Type          string    `gorm:"size:20" json:"type"` // image, video
    TotalAssets   int       `json:"total_assets"`
    TotalSize     int64     `json:"total_size"` // 字节
    UploadCount   int       `json:"upload_count"` // 当日上传数
    UploadSize    int64     `json:"upload_size"` // 当日上传大小
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
}
```

**复合索引**：`(date, type)`

---

## 5. 复用表

### 5.1 标签表 (tags)

复用贴图库的 `tags` 表，统一管理标签和分类

---

## 数据库迁移

```go
func AutoMigrate(db *gorm.DB) error {
    return db.AutoMigrate(
        &Asset{},
        &AssetMetadata{},
        &AssetTag{},
        &AssetMetrics{},
    )
}
```

---

## 文件存储结构

```
static/assets/
  ├── 1/
  │   ├── file.png           # 原始文件
  │   └── thumbnail.webp     # 预览图
  ├── 2/
  │   ├── file.jpg
  │   └── thumbnail.webp
  ├── 3/
  │   ├── file.mp4           # 视频文件
  │   └── thumbnail.webp     # 视频截图
  └── 4/
      ├── file.webm
      └── thumbnail.webp
```

**说明**：

- 所有资产统一存储在 `static/assets/` 目录
- 按资产ID创建子目录
- 通过数据库的 `type` 字段区分类型

---

## 查询优化

### 常用查询索引

```sql
-- 按类型和分类查询
CREATE INDEX idx_assets_type_category ON assets(type, category);

-- 按使用次数排序
CREATE INDEX idx_assets_use_count ON assets(use_count DESC);

-- 按创建时间排序
CREATE INDEX idx_assets_created_at ON assets(created_at DESC);

-- 标签关联查询
CREATE INDEX idx_asset_tags_asset_id ON asset_tags(asset_id);
CREATE INDEX idx_asset_tags_tag_id ON asset_tags(tag_id);
```
