# 优雅停机概述

## 什么是优雅停机

优雅停机（Graceful Shutdown）是指在关闭服务时：

1. 停止接受新请求
2. 等待正在处理的请求完成
3. 关闭数据库连接
4. 释放其他资源
5. 安全退出进程

## 当前问题

```go
// main.go 第 86 行
select {}  // 无限阻塞，无法响应关闭信号
```

**问题**：

- 收到 SIGTERM 时直接强制退出
- 正在处理的请求被中断
- 数据库连接未正常关闭
- 可能导致数据不一致

## 改造目标

```
收到 SIGTERM/SIGINT
        │
        ▼
┌─────────────────┐
│ 停止接受新连接   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 等待现有请求完成 │ (最多30秒)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 停止备份调度器   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 关闭数据库连接   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 进程退出         │
└─────────────────┘
```

## 相关文档

- [代码修改](./02_代码修改.md)
- [部署集成](./03_部署集成.md)
