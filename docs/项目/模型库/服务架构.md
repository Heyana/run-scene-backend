# 服务架构

## 目录结构

```
services/model/
  ├── upload_service.go    # 上传服务
  ├── query_service.go     # 查询服务
  └── tag_service.go       # 标签服务（复用贴图库）

models/
  ├── model.go             # 模型相关模型
  └── texture.go           # 贴图模型（已存在）

controllers/
  └── model_controller.go  # 模型控制器
```

---

## 核心服务

### 1. UploadService (上传服务)

```go
type UploadService struct {
    db *gorm.DB
    config *ModelConfig
}

// 单文件上传（模型 + 预览图）
func (s *UploadService) UploadSingle(modelFile, thumbnailFile *multipart.FileHeader, metadata UploadMetadata) (*Model, error)

// 保存模型文件到磁盘
func (s *UploadService) saveModelFile(file *multipart.FileHeader, modelID uint) (string, error)

// 保存预览图到磁盘
func (s *UploadService) saveThumbnail(file *multipart.FileHeader, modelID uint) (string, error)

// 验证文件格式
func (s *UploadService) validateFile(file *multipart.FileHeader, allowedTypes []string) error

// 检查文件是否已存在（基于MD5）
func (s *UploadService) checkDuplicate(fileHash string) (*Model, bool, error)

// 计算文件哈希
func (s *UploadService) calculateHash(file *multipart.FileHeader) (string, error)
```

**UploadMetadata 结构**：

```go
type UploadMetadata struct {
    Name        string
    Description string
    Category    string
    Tags        []string
    Type        string   // glb, glt
    UploadedBy  string
    UploadIP    string
}
```

---

### 2. QueryService (查询服务)

```go
type QueryService struct {
    db *gorm.DB
}

// 分页查询
func (q *QueryService) List(page, pageSize int, filters QueryFilters) ([]*Model, int64, error)

// 按分类查询
func (q *QueryService) ListByCategory(category string, page, pageSize int) ([]*Model, int64, error)

// 按标签查询
func (q *QueryService) ListByTags(tagIDs []uint, page, pageSize int) ([]*Model, int64, error)

// 搜索（名称、标签）
func (q *QueryService) Search(keyword string, page, pageSize int) ([]*Model, int64, error)

// 获取详情
func (q *QueryService) GetDetail(id uint) (*Model, []*Tag, error)

// 记录使用次数
func (q *QueryService) IncrementUseCount(id uint) error

// 获取统计信息
func (q *QueryService) GetStatistics() (*ModelStatistics, error)

// 删除模型
func (q *QueryService) Delete(id uint) error
```

**QueryFilters 结构**：

```go
type QueryFilters struct {
    Category  string
    Tags      []string
    Type      string   // glb, glt
    SortBy    string   // name, created_at, use_count
    SortOrder string   // asc, desc
}
```

---

### 3. TagService (标签服务)

复用贴图库的 TagService，扩展支持模型：

```go
// 关联模型和标签
func (t *TagService) AssociateModelTags(modelID uint, tagIDs []uint) error

// 获取模型的标签
func (t *TagService) GetModelTags(modelID uint) ([]*Tag, error)

// 更新模型标签
func (t *TagService) UpdateModelTags(modelID uint, tagIDs []uint) error
```

---

## 工作流程

### 上传流程

```
1. 接收文件上传请求（模型文件 + 预览图）
2. 验证文件格式和大小
3. 计算模型文件MD5，检查是否重复
4. 创建模型ID
5. 保存模型文件到磁盘 (static/models/{id}/model.{type})
6. 保存预览图到磁盘 (static/models/{id}/thumbnail.webp)
7. 创建数据库记录
8. 处理标签关联
9. 返回模型信息
```

### 查询流程

```
1. 接收查询参数
2. 构建查询条件
3. 执行数据库查询
4. 加载关联数据（标签）
5. 组装返回数据
6. 返回结果
```

---

## 配置管理

```go
type ModelConfig struct {
    StorageDir        string
    MaxFileSize       int64
    MaxThumbnailSize  int64
    AllowedTypes      []string
    UploadConcurrency int
}

func LoadConfig() (*ModelConfig, error)
```

---

## 错误处理

```go
var (
    ErrInvalidType      = errors.New("不支持的文件类型")
    ErrFileTooLarge     = errors.New("文件大小超过限制")
    ErrDuplicateFile    = errors.New("文件已存在")
    ErrMissingThumbnail = errors.New("缺少预览图")
    ErrInvalidMetadata  = errors.New("元数据格式错误")
)
```

---

## 并发控制

```go
type UploadPool struct {
    workers   int
    taskQueue chan *UploadTask
    wg        sync.WaitGroup
}

func NewUploadPool(workers int) *UploadPool

func (p *UploadPool) Submit(task *UploadTask)

func (p *UploadPool) Wait()
```
