# 贴图库管理系统实现方案

## 1. 概述

从 Polyhaven API 同步材质贴图数据，本地化存储元数据和图片资源，提供查询接口。

**核心流程**：API 获取 → 数据库存储 → 图片下载转码 → 定时增量更新

---

## 2. 数据库设计

### 2.1 通用文件表 (files)

```go
type File struct {
    ID          uint      `gorm:"primaryKey"`
    FileType    string    `gorm:"size:20;index"` // thumbnail, texture, image, video等
    RelatedID   uint      `gorm:"index"`         // 关联ID（如TextureID）
    RelatedType string    `gorm:"size:50"`       // 关联类型（如Texture）
    OriginalURL string    `gorm:"size:500"`
    LocalPath   string    `gorm:"size:500;index"` // 相对路径
    CDNPath     string    `gorm:"size:500"`       // CDN路径（可选）
    FileName    string    `gorm:"size:200"`
    FileSize    int64
    Width       int
    Height      int
    Format      string    `gorm:"size:10"` // jpg, png, webp
    MD5         string    `gorm:"size:50;index"`
    Version     int       `gorm:"default:1"` // 文件版本
    Status      int       `gorm:"default:0;index"` // 0=待下载 1=已下载 2=失败 3=已删除
    DownloadRetry int     `gorm:"default:0"` // 重试次数
    LastError   string    `gorm:"type:text"` // 最后错误信息
    CreatedAt   time.Time
    UpdatedAt   time.Time
    DeletedAt   *time.Time `gorm:"index"` // 软删除
}
```

### 2.2 材质表 (textures)

```go
type Texture struct {
    ID            uint      `gorm:"primaryKey"`
    AssetID       string    `gorm:"uniqueIndex;size:100"` // 材质唯一标识
    Name          string    `gorm:"size:200;index"`
    Description   string    `gorm:"type:text"`
    Type          int       // 类型：1=texture
    Authors       string    `gorm:"type:text"` // JSON对象字符串
    MaxResolution string    `gorm:"size:50"`   // 如 "8192x8192"
    FilesHash     string    `gorm:"size:100;index"` // 用于增量更新
    DatePublished int64     `gorm:"index"`
    DownloadCount int       // API提供的下载次数
    UseCount      int       `gorm:"default:0;index"` // 本地使用次数
    LastUsedAt    *time.Time // 最后使用时间
    Priority      int       `gorm:"default:0;index"` // 下载优先级（0-10）
    SyncStatus    int       `gorm:"default:0;index"` // 0=待同步 1=已同步 2=失败
    CreatedAt     time.Time
    UpdatedAt     time.Time
}
```

### 2.3 标签表 (tags)

```go
type Tag struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string    `gorm:"uniqueIndex;size:100"` // 标签名称
    Type      string    `gorm:"size:20;index"`        // tag=标签 category=分类
    UseCount  int       `gorm:"default:0;index"`      // 使用次数（用于排序）
    CreatedAt time.Time
}
```

### 2.4 材质标签关联表 (texture_tags)

```go
type TextureTag struct {
    ID        uint `gorm:"primaryKey"`
    TextureID uint `gorm:"index"`
    TagID     uint `gorm:"index"`
    CreatedAt time.Time
}
// 联合唯一索引
// Index: texture_id + tag_id
```

### 2.5 材质文件表 (texture_files)

```go
type TextureFile struct {
    ID         uint      `gorm:"primaryKey"`
    TextureID  uint      `gorm:"index"`
    FileID     uint      `gorm:"index"` // 关联 files 表
    MapType    string    `gorm:"size:50;index"` // Diffuse, Normal, Roughness等
    Resolution string    `gorm:"size:20"` // 1k, 2k, 4k等
    CreatedAt  time.Time
}
```

### 2.6 同步记录表 (texture_sync_logs)

```go
type TextureSyncLog struct {
    ID             uint      `gorm:"primaryKey"`
    SyncType       string    `gorm:"size:20"` // full=全量 incremental=增量
    Status         int       `gorm:"default:0;index"` // 0=进行中 1=成功 2=失败 3=已取消
    TotalCount     int       // 总材质数
    ProcessedCount int       // 已处理数
    SuccessCount   int       // 成功数
    FailCount      int       // 失败数
    SkipCount      int       // 跳过数
    CurrentAsset   string    `gorm:"size:100"` // 当前处理的材质
    Progress       float64   // 进度百分比（0-100）
    DownloadSpeed  float64   // 下载速度（MB/s）
    StartTime      time.Time
    EndTime        time.Time
    ErrorMsg       string    `gorm:"type:text"`
    CreatedAt      time.Time
    UpdatedAt      time.Time
}
```

### 2.7 下载队列表 (download_queue)

```go
type DownloadQueue struct {
    ID          uint      `gorm:"primaryKey"`
    FileID      uint      `gorm:"index"`
    TextureID   uint      `gorm:"index"`
    Priority    int       `gorm:"default:5;index"` // 优先级 0-10
    Status      int       `gorm:"default:0;index"` // 0=待处理 1=处理中 2=完成 3=失败
    RetryCount  int       `gorm:"default:0"`
    MaxRetry    int       `gorm:"default:3"`
    ErrorMsg    string    `gorm:"type:text"`
    ScheduledAt time.Time `gorm:"index"` // 计划执行时间
    StartedAt   *time.Time
    CompletedAt *time.Time
    CreatedAt   time.Time
    UpdatedAt   time.Time
}
```

### 2.8 系统指标表 (texture_metrics)

```go
type TextureMetrics struct {
    ID              uint      `gorm:"primaryKey"`
    Date            string    `gorm:"uniqueIndex;size:10"` // YYYY-MM-DD
    TotalTextures   int       // 总材质数
    TotalFiles      int       // 总文件数
    TotalSize       int64     // 总大小（字节）
    DownloadCount   int       // 当日下载数
    DownloadSize    int64     // 当日下载大小
    FailedCount     int       // 失败数
    AvgDownloadTime float64   // 平均下载时间（秒）
    CreatedAt       time.Time
    UpdatedAt       time.Time
}
```

---

## 3. 服务架构

### 3.1 目录结构

```
services/
  └── texture/
      ├── sync_service.go      # 同步服务
      ├── download_service.go  # 下载服务
      ├── query_service.go     # 查询服务
      └── tag_service.go       # 标签服务

models/
  ├── texture.go               # 材质模型
  ├── file.go                  # 通用文件模型
  └── tag.go                   # 标签模型

api/
  └── texture_controller.go    # API控制器
```

### 3.2 核心服务

#### SyncService (同步服务)

```go
type SyncService struct {
    db *gorm.DB
    downloadService *DownloadService
    tagService *TagService
    logger *logrus.Logger  // 日志记录器
}

// 全量同步
func (s *SyncService) FullSync() error

// 增量同步（基于 files_hash 对比）
func (s *SyncService) IncrementalSync() error

// 获取材质列表
func (s *SyncService) fetchTextureList() (map[string]interface{}, error)

// 获取材质详情
func (s *SyncService) fetchTextureDetail(assetID string) (map[string]interface{}, error)

// 保存材质元数据
func (s *SyncService) saveTexture(data map[string]interface{}) error

// 处理标签和分类
func (s *SyncService) processTags(textureID uint, tags []string, categories []string) error

// 更新同步进度
func (s *SyncService) updateProgress(logID uint, processed int, total int, currentAsset string) error

// 记录同步日志
func (s *SyncService) logInfo(message string, args ...interface{})
func (s *SyncService) logError(message string, err error, args ...interface{})
func (s *SyncService) logDebug(message string, args ...interface{})

// 启动定时任务（每6小时）
func (s *SyncService) StartScheduler()
```

#### TagService (标签服务)

```go
type TagService struct {
    db *gorm.DB
}

// 创建或获取标签
func (t *TagService) GetOrCreateTag(name string, tagType string) (*Tag, error)

// 关联材质和标签
func (t *TagService) AssociateTextureTags(textureID uint, tagIDs []uint) error

// 更新标签使用次数
func (t *TagService) IncrementTagUseCount(tagID uint) error

// 获取热门标签
func (t *TagService) GetPopularTags(limit int) ([]Tag, error)

// 按类型获取标签列表
func (t *TagService) ListByType(tagType string) ([]Tag, error)
```

#### DownloadService (下载服务)

```go
type DownloadService struct {
    db *gorm.DB
    storageDir string // static/textures
    logger *logrus.Logger
}

// 下载缩略图
func (d *DownloadService) DownloadThumbnail(textureID uint, assetID string, thumbnailURL string) (*File, error)

// 下载并转码贴图（选择>1K的最小分辨率）
func (d *DownloadService) DownloadAndConvert(textureID uint, assetID string, files map[string]interface{}) error

// 选择最优分辨率（>1K的最小）
func (d *DownloadService) selectBestResolution(files map[string]interface{}) (url string, resolution string)

// 下载图片（带进度日志）
func (d *DownloadService) downloadImage(url string) ([]byte, error)

// 转码为 WebP（带进度日志）
func (d *DownloadService) convertToWebP(imageData []byte, targetSize int) ([]byte, error)

// 保存到本地并创建 File 记录（带日志）
func (d *DownloadService) saveFile(relatedID uint, relatedType string, fileType string, data []byte, fileName string) (*File, error)

// 记录下载日志
func (d *DownloadService) logDownloadProgress(assetID string, step string, details string)
```

#### QueryService (查询服务)

```go
type QueryService struct {
    db *gorm.DB
}

// 分页查询
func (q *QueryService) List(page, pageSize int, filters map[string]interface{}) ([]Texture, int64, error)

// 按标签查询
func (q *QueryService) ListByTag(tagID uint, page, pageSize int) ([]Texture, int64, error)

// 按分类查询
func (q *QueryService) ListByCategory(category string, page, pageSize int) ([]Texture, int64, error)

// 搜索（名称、标签）
func (q *QueryService) Search(keyword string, page, pageSize int) ([]Texture, int64, error)

// 获取详情（包含标签和文件）
func (q *QueryService) GetDetail(assetID string) (*Texture, []Tag, []File, error)

// 记录使用次数
func (q *QueryService) IncrementUseCount(textureID uint) error
```

---

## 4. API 接口

### 4.1 材质列表

```
GET /api/textures
Query: page, pageSize, tagId, category, keyword, sortBy(useCount|datePublished)
Response: {
    list: Texture[],
    total: int,
    page: int,
    pageSize: int
}
```

### 4.2 材质详情

```
GET /api/textures/:assetId
Response: {
    texture: Texture,
    tags: Tag[],
    files: File[]
}
```

### 4.3 标签列表

```
GET /api/tags
Query: type(tag|category), sortBy(useCount|name)
Response: Tag[]
```

### 4.4 按标签查询材质

```
GET /api/tags/:tagId/textures
Query: page, pageSize
Response: {
    tag: Tag,
    textures: Texture[],
    total: int
}
```

### 4.5 记录使用

```
POST /api/textures/:assetId/use
Response: { success: bool, useCount: int }
```

### 4.6 手动同步

```
POST /api/textures/sync
Body: { type: "full" | "incremental" }
Response: { message: string, logId: int }
```

### 4.7 同步状态

```
GET /api/textures/sync/status/:logId
Response: TextureSyncLog
```

---

## 5. 实现要点

### 5.1 增量更新策略

1. 对比 `files_hash` 字段判断是否变更
2. 对比 `date_published` 获取新增材质
3. 只下载未本地化的资源

### 5.2 标签处理流程

```
1. 从 API 获取 tags 和 categories 数组
2. 遍历每个标签/分类：
   - 查询 tags 表是否存在
   - 不存在则创建（type=tag 或 category）
   - 获取 tag_id
3. 在 texture_tags 表创建关联关系
4. 更新标签的 use_count（每次关联+1）
```

### 5.3 图片处理流程

#### 缩略图本地化

```
1. 下载 API 提供的缩略图（thumbnail_url）
2. 转码为 WebP 格式（256x256）
3. 创建 File 记录：
   - file_type = "thumbnail"
   - related_id = texture_id
   - related_type = "Texture"
   - local_path = "static/textures/{assetId}/thumbnail.webp"
4. 保存文件到磁盘
```

#### 贴图文件本地化

```
1. 从 API 获取文件列表（Diffuse, Normal, Roughness等）
2. 遍历分辨率：1k, 2k, 4k, 8k, 16k
3. 选择第一个 >= 2k 的分辨率（如果没有则选1k）
4. 优先下载 jpg 格式（体积小）
5. 使用 nativewebp 转码为 1024x1024 WebP
6. 创建 File 记录：
   - file_type = "texture"
   - related_id = texture_id
   - related_type = "Texture"
   - local_path = "static/textures/{assetId}/{mapType}_1k.webp"
7. 在 texture_files 表创建关联（记录 map_type 和 resolution）
```

### 5.4 使用次数统计

```
1. 用户使用材质时调用 /api/textures/:assetId/use
2. 更新 textures.use_count 字段 +1
3. 可用于：
   - 热门材质排序
   - 推荐算法
   - 使用统计报表
```

### 5.5 定时任务

```go
func (s *SyncService) StartScheduler() {
    ticker := time.NewTicker(6 * time.Hour)
    go func() {
        for range ticker.C {
            s.IncrementalSync()
        }
    }()
}
```

### 5.6 并发控制

- 使用 goroutine pool 限制并发下载数（如10个）
- 使用 channel 控制任务队列
- 错误重试机制（最多3次）
- 缩略图和贴图文件分开下载，优先下载缩略图

### 5.7 本地化资源目录结构

```
static/textures/
  ├── aerial_asphalt_01/
  │   ├── thumbnail.webp          # 缩略图 256x256
  │   ├── diffuse_1k.webp         # 漫反射贴图 1024x1024
  │   ├── normal_1k.webp          # 法线贴图 1024x1024
  │   └── roughness_1k.webp       # 粗糙度贴图 1024x1024
  ├── aerial_beach_01/
  │   ├── thumbnail.webp
  │   └── ...
  └── ...
```

---

## 6. 配置项

### 6.1 config.yaml 配置

```yaml
# 贴图库配置
texture:
  # 存储基础路径
  storage_dir: "static/textures"

  # 同步配置
  sync_interval: "6h" # 自动同步间隔
  download_concurrency: 10 # 并发下载数
  retry_times: 3 # 失败重试次数

  # 图片处理配置
  thumbnail_size: 256 # 缩略图尺寸
  texture_resolution: 1024 # 贴图目标分辨率
  webp_quality: 80 # WebP质量（0-100）

  # 下载控制
  download_thumbnail: true # 是否下载缩略图
  download_textures: true # 是否下载贴图文件

  # API配置
  api_base_url: "https://api.polyhaven.com"
  api_timeout: 30 # API请求超时（秒）

  # 日志配置
  log_enabled: true # 是否启用详细日志
  log_level: "info" # 日志级别：debug|info|warn|error
  log_to_file: true # 是否输出到文件
  log_file_path: "./logs/texture_sync.log"
```

### 6.2 配置读取

```go
type TextureConfig struct {
    StorageDir          string `yaml:"storage_dir"`
    SyncInterval        string `yaml:"sync_interval"`
    DownloadConcurrency int    `yaml:"download_concurrency"`
    RetryTimes          int    `yaml:"retry_times"`
    ThumbnailSize       int    `yaml:"thumbnail_size"`
    TextureResolution   int    `yaml:"texture_resolution"`
    WebPQuality         int    `yaml:"webp_quality"`
    DownloadThumbnail   bool   `yaml:"download_thumbnail"`
    DownloadTextures    bool   `yaml:"download_textures"`
    APIBaseURL          string `yaml:"api_base_url"`
    APITimeout          int    `yaml:"api_timeout"`
    LogEnabled          bool   `yaml:"log_enabled"`
    LogLevel            string `yaml:"log_level"`
    LogToFile           bool   `yaml:"log_to_file"`
    LogFilePath         string `yaml:"log_file_path"`
}
```

---

## 7. 日志系统

### 7.1 日志级别

- **DEBUG**: 详细的调试信息（每个文件下载、转码细节）
- **INFO**: 关键操作信息（同步开始/结束、进度更新）
- **WARN**: 警告信息（重试、跳过）
- **ERROR**: 错误信息（下载失败、转码失败）

### 7.2 日志内容

#### 同步任务日志

```
[INFO] 2024-01-20 10:00:00 开始增量同步任务
[INFO] 2024-01-20 10:00:01 获取材质列表成功，共 1523 个材质
[INFO] 2024-01-20 10:00:02 检测到 15 个新增材质，3 个更新材质
[INFO] 2024-01-20 10:00:03 开始处理材质: aerial_asphalt_01
[DEBUG] 2024-01-20 10:00:04 创建标签: road (type=tag)
[DEBUG] 2024-01-20 10:00:04 创建标签: asphalt (type=category)
[INFO] 2024-01-20 10:00:05 下载缩略图: aerial_asphalt_01 [1/18]
[DEBUG] 2024-01-20 10:00:06 下载完成: 45.2KB, 耗时 1.2s
[DEBUG] 2024-01-20 10:00:07 转码为 WebP: 256x256, 质量 80
[INFO] 2024-01-20 10:00:08 保存文件: static/textures/aerial_asphalt_01/thumbnail.webp
[INFO] 2024-01-20 10:00:09 下载贴图: Diffuse 2k [2/18]
[DEBUG] 2024-01-20 10:00:15 下载完成: 2.5MB, 耗时 6.1s
[DEBUG] 2024-01-20 10:00:18 转码为 WebP: 1024x1024, 质量 80
[INFO] 2024-01-20 10:00:19 保存文件: static/textures/aerial_asphalt_01/diffuse_1k.webp
[INFO] 2024-01-20 10:00:20 材质处理完成: aerial_asphalt_01 (2/18)
[INFO] 2024-01-20 10:15:30 同步任务完成: 成功 18, 失败 0, 耗时 15m30s
```

#### 错误日志

```
[ERROR] 2024-01-20 10:05:12 下载失败: aerial_beach_01/thumbnail.webp
        URL: https://cdn.polyhaven.com/asset_img/thumbs/aerial_beach_01.png
        错误: connection timeout after 30s
        重试: 1/3
[WARN] 2024-01-20 10:05:45 跳过材质: concrete_layers_02
       原因: 本地文件已存在且 MD5 匹配
[ERROR] 2024-01-20 10:08:23 转码失败: bark_brown_01/diffuse_1k.webp
        原因: invalid image format
        操作: 保存原图
```

### 7.3 进度显示

#### 控制台输出

```
同步进度: [████████████░░░░░░░░] 65% (982/1523)
当前处理: aerial_rocks_04
下载速度: 2.3 MB/s
预计剩余: 8m15s
```

#### 数据库记录

```go
type TextureSyncLog struct {
    ID            uint
    SyncType      string    // full | incremental
    Status        int       // 0=进行中 1=成功 2=失败
    TotalCount    int       // 总数
    ProcessedCount int      // 已处理
    SuccessCount  int       // 成功
    FailCount     int       // 失败
    CurrentAsset  string    // 当前处理的材质
    Progress      float64   // 进度百分比
    StartTime     time.Time
    EndTime       time.Time
    ErrorMsg      string
}
```

### 7.4 日志查询接口

```
GET /api/textures/sync/logs
Query: page, pageSize, status, syncType
Response: {
    logs: TextureSyncLog[],
    total: int
}

GET /api/textures/sync/progress
Response: {
    isRunning: bool,
    progress: float64,
    currentAsset: string,
    processedCount: int,
    totalCount: int,
    estimatedTime: string
}
```

---

## 8. 初始化流程

1. 数据库迁移（创建6张表：files, textures, tags, texture_tags, texture_files, texture_sync_logs）
2. 创建存储目录（根据 config.yaml 中的 storage_dir）
3. 初始化日志系统（根据配置创建日志文件）
4. 启动定时任务
5. 首次全量同步（可选，或手动触发）

---

## 9. 错误处理

- API 请求失败：记录ERROR日志，跳过该材质，继续处理下一个
- 下载失败：记录ERROR日志，标记状态为失败，重试（最多3次）
- 转码失败：记录WARN日志，保存原图，标记转码失败
- 磁盘空间不足：记录ERROR日志，停止下载，更新同步状态为失败
- 网络超时：记录WARN日志，自动重试，超过重试次数后跳过

---

## 10. 性能优化

- 使用 HTTP 连接池复用
- 图片下载使用流式处理，避免内存溢出
- 数据库批量插入（每100条提交一次）
- 缩略图优先下载（用户可快速浏览）
- 贴图文件按需下载（可配置延迟下载）
- 已存在的本地文件跳过下载（基于MD5校验）
- 日志异步写入，避免阻塞主流程
- 进度信息缓存到内存，减少数据库写入频率（每10秒更新一次）
