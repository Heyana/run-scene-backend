# AI3D 统一表迁移步骤

## 已完成的工作

✅ 1. 创建统一模型 `models/ai3d/task.go`
✅ 2. 创建适配器接口 `services/ai3d/adapter.go`
✅ 3. 创建混元适配器 `services/ai3d/adapters/hunyuan_adapter.go`
✅ 4. 创建Meshy适配器 `services/ai3d/adapters/meshy_adapter.go`
✅ 5. 创建统一任务服务 `services/ai3d/task_service.go`
✅ 6. 创建统一轮询器 `services/ai3d/poller.go`
✅ 7. 创建数据迁移脚本 `database/migrations/merge_ai3d.go`
✅ 8. 创建初始化文件 `bootstrap/ai3d.go`
✅ 9. 创建统一控制器 `controllers/ai3d_unified_controller.go`

---

## 迁移步骤

### 第一阶段：准备和测试（不影响现有系统）

#### 1. 在 `database/database.go` 中添加迁移调用

在 `InitDatabase` 函数中添加：

```go
import "go_wails_project_manager/database/migrations"

func InitDatabase() (*gorm.DB, error) {
    // ... 现有代码 ...

    // 执行AI3D表合并迁移
    if err := migrations.MergeAI3DTasks(db); err != nil {
        logger.Log.Errorf("AI3D表合并失败: %v", err)
        // 不返回错误，允许系统继续运行
    }

    return db, nil
}
```

#### 2. 在 `app.go` 中初始化AI3D服务

```go
import "go_wails_project_manager/bootstrap"

// 在 main 函数或初始化函数中添加
ai3dTaskService := bootstrap.InitAI3D(db)
```

#### 3. 在 `api/routes.go` 中注册新路由

```go
import "go_wails_project_manager/controllers"

func RegisterRoutes(router *gin.Engine, db *gorm.DB, ai3dTaskService *ai3dService.TaskService) {
    // ... 现有代码 ...

    // AI3D统一接口（新）
    ai3dUnifiedController := controllers.NewAI3DUnifiedController(ai3dTaskService)
    ai3dGroup := router.Group("/api/ai3d-v2") // 使用新路径避免冲突
    {
        ai3dGroup.POST("/tasks", ai3dUnifiedController.SubmitTask)
        ai3dGroup.GET("/tasks", ai3dUnifiedController.ListTasks)
        ai3dGroup.GET("/tasks/:id", ai3dUnifiedController.GetTask)
        ai3dGroup.POST("/tasks/:id/poll", ai3dUnifiedController.PollTask)
        ai3dGroup.DELETE("/tasks/:id", ai3dUnifiedController.DeleteTask)
    }
}
```

#### 4. 测试新系统

```bash
# 启动服务器
go run .

# 测试提交任务
curl -X POST http://localhost:23359/api/ai3d-v2/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "meshy",
    "inputType": "image",
    "imageBase64": "...",
    "generationParams": {
      "aiModel": "meshy-6",
      "enablePbr": true,
      "topology": "quad"
    }
  }'

# 测试查询列表
curl http://localhost:23359/api/ai3d-v2/tasks?page=1&pageSize=20
```

---

### 第二阶段：切换到新系统

#### 5. 更新路由（切换到新控制器）

在 `api/routes.go` 中：

```go
// 注释掉旧的路由
// ai3dGroup := router.Group("/api/ai3d")
// {
//     ai3dGroup.POST("/tasks", oldAI3DController.SubmitTask)
//     ...
// }

// 使用新控制器，路径保持不变
ai3dGroup := router.Group("/api/ai3d")
{
    ai3dGroup.POST("/tasks", ai3dUnifiedController.SubmitTask)
    ai3dGroup.GET("/tasks", ai3dUnifiedController.ListTasks)
    ai3dGroup.GET("/tasks/:id", ai3dUnifiedController.GetTask)
    ai3dGroup.POST("/tasks/:id/poll", ai3dUnifiedController.PollTask)
    ai3dGroup.DELETE("/tasks/:id", ai3dUnifiedController.DeleteTask)
}
```

#### 6. 停止旧的轮询器

在 `app.go` 中：

```go
// 注释掉旧的轮询器启动代码
// hunyuanPoller.Start()
// meshyPoller.Start()

// 新的轮询器已在 bootstrap.InitAI3D 中启动
```

#### 7. 验证功能

- ✅ 提交任务正常
- ✅ 查询列表正常
- ✅ 轮询更新正常
- ✅ 文件下载正常
- ✅ 前端显示正常

---

### 第三阶段：清理旧代码（可选）

#### 8. 删除或归档旧文件

可以删除或移动到 `_deprecated` 目录：

```
controllers/ai3d_controller.go (旧的)
services/hunyuan/poller.go
services/meshy/poller.go
```

保留但不再使用：

```
models/hunyuan/task.go (保留用于数据迁移)
models/meshy/task.go (保留用于数据迁移)
services/hunyuan/* (保留，适配器需要)
services/meshy/* (保留，适配器需要)
```

---

## 回滚方案

如果新系统出现问题，可以快速回滚：

### 1. 恢复旧表

```sql
-- 如果需要回滚
DROP TABLE IF EXISTS ai3d_tasks;
ALTER TABLE hunyuan_tasks_backup_20260205_xxx RENAME TO hunyuan_tasks;
ALTER TABLE meshy_tasks_backup_20260205_xxx RENAME TO meshy_tasks;
```

### 2. 恢复旧路由

在 `api/routes.go` 中恢复旧的路由配置

### 3. 重启旧轮询器

在 `app.go` 中恢复旧的轮询器启动代码

---

## 注意事项

1. **数据安全**
   - 迁移前自动备份旧表（重命名为 `*_backup_时间戳`）
   - 不会删除原始数据
   - 可以随时回滚

2. **兼容性**
   - 新系统API接口与旧系统完全兼容
   - 前端无需修改
   - 可以平滑切换

3. **性能**
   - 统一轮询器减少数据库查询
   - 单表查询比多表合并更快
   - 并发控制避免资源耗尽

4. **扩展性**
   - 新增平台只需实现适配器接口
   - 无需修改数据库结构
   - 无需修改控制器代码

---

## 验证清单

- [ ] 数据库迁移成功
- [ ] 旧数据已正确转换
- [ ] 新任务可以正常提交
- [ ] 轮询器正常工作
- [ ] 文件下载正常
- [ ] 前端显示正常
- [ ] 性能符合预期
- [ ] 日志输出正常

---

## 技术支持

如有问题，请检查：

1. 日志文件：查看详细错误信息
2. 数据库：确认表结构和数据
3. 配置文件：确认API密钥等配置正确
4. 网络：确认可以访问平台API

---

## 总结

这个迁移方案：

- ✅ 不影响现有系统运行
- ✅ 可以逐步测试和验证
- ✅ 支持快速回滚
- ✅ 数据安全有保障
- ✅ 性能和扩展性更好

按照步骤执行即可完成平滑迁移！
