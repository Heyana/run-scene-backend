# 导入方式 - 实施方案

## 概述

为文件夹添加配置功能，支持三种导入模式：
- **索引模式**（默认）：文件保留原位置
- **移动模式**：文件移动到管理目录
- **复制模式**：文件复制到管理目录

## 数据模型

### Folder 模型变更

```go
type Folder struct {
    // ... 现有字段
    Config *string `gorm:"type:text" json:"config"` // JSON配置
}
```

### Asset 模型变更

```go
type Asset struct {
    // ... 现有字段
    Path         string  `gorm:"size:512;not null" json:"path"`
    OriginalPath *string `gorm:"size:512" json:"originalPath"`
    ImportMode   string  `gorm:"size:20;not null;default:'index'" json:"importMode"`
}
```

### FolderConfig 结构

```go
type FolderConfig struct {
    ImportMode         string   `json:"importMode"`         // index/move/copy
    AutoProcess        bool     `json:"autoProcess"`        
    AllowedTypes       []string `json:"allowedTypes"`       
    MaxFileSize        *int64   `json:"maxFileSize"`        
    DefaultCategories  []string `json:"defaultCategories"`  
    StoragePath        *string  `json:"storagePath"`        
    PreviewQuality     string   `json:"previewQuality"`     
    CustomSettings     map[string]interface{} `json:"customSettings"`
}
```

## 架构设计

### 后端

#### 1. models/folder_config.go

```go
type FolderConfig struct { /* 配置结构 */ }

func DefaultFolderConfig() *FolderConfig
func ParseFolderConfig(jsonStr string) (*FolderConfig, error)
func (c *FolderConfig) ToJSON() (string, error)
```

#### 2. services/folder_service.go

```go
func (s *FolderService) GetFolderConfig(folderID uint) (*FolderConfig, error)
func (s *FolderService) UpdateFolderConfig(folderID uint, config *FolderConfig) error
func (s *FolderService) GetInheritedImportMode(folderID uint) (string, error)
```

#### 3. api/folder_controller.go

```go
func (ctrl *FolderController) GetFolderConfig(c *gin.Context)
func (ctrl *FolderController) UpdateFolderConfig(c *gin.Context)
```

### 前端

#### 1. types.ts

```typescript
interface FolderConfig {
    importMode?: 'index' | 'move' | 'copy'
    autoProcess?: boolean
    allowedTypes?: string[]
    storagePath?: string
    previewQuality?: 'low' | 'medium' | 'high'
    customSettings?: Record<string, any>
}
```

#### 2. FolderAdapter.ts

```typescript
class FolderAdapter {
    getConfig(id: number): Promise<FolderConfig>
    updateConfig(id: number, config: Partial<FolderConfig>): Promise<void>
    getImportMode(folderId: number): Promise<string>
}
```

#### 3. task.ts

```typescript
class TaskProcessor {
    async processFile(path: string, task: Task): Promise<Result>
    async getStorageDir(folderId?: number): Promise<string>
    async moveFile(source: string, targetDir: string): Promise<string>
    async copyFile(source: string, targetDir: string): Promise<string>
}
```

## 实施步骤

### 阶段1：数据模型 ✓ GORM 自动迁移

1. 添加 Folder.Config 字段
2. 添加 Asset.ImportMode、Asset.OriginalPath 字段
3. 创建 FolderConfig 结构定义

### 阶段2：后端服务

1. 实现 folder_config.go 工具函数
2. 扩展 FolderService 配置管理方法
3. 添加 FolderController API 路由

### 阶段3：前端适配

1. 更新类型定义
2. 扩展 FolderAdapter 配置方法
3. 修改任务处理逻辑，支持三种导入模式

### 阶段4：UI 组件

1. 创建文件夹配置对话框
2. 添加导入模式图标标识
3. 资产列表显示导入模式

## 核心逻辑

### 导入模式决策流程

```
拖入文件 → 获取目标文件夹ID → 读取文件夹配置 → 获取importMode
  ├─ index: 保持原位置 → 创建Asset(path=原路径, importMode='index')
  ├─ move:  移动文件 → 创建Asset(path=新路径, originalPath=原路径, importMode='move')
  └─ copy:  复制文件 → 创建Asset(path=新路径, originalPath=原路径, importMode='copy')
```

### 配置继承逻辑

```
获取文件夹配置 → 检查当前配置 → 存在则返回 → 不存在则向上查找父文件夹 → 最终返回默认值
```

## API 路由

```
GET    /api/folders/:id/config        获取文件夹配置
PUT    /api/folders/:id/config        更新文件夹配置
GET    /api/folders/:id/import-mode   获取继承的导入模式
```

## 注意事项

1. **向后兼容**：现有数据默认为索引模式
2. **路径处理**：移动/复制需确保目标目录存在
3. **错误处理**：文件操作失败时回滚数据库操作
4. **删除策略**：索引模式只删记录，移动/复制模式删除物理文件
5. **并发控制**：文件操作需加锁避免冲突

## 测试点

- [ ] 配置的增删改查
- [ ] 三种导入模式的文件处理
- [ ] 配置继承机制
- [ ] 文件移动/复制的原子性
- [ ] 删除时的正确处理
- [ ] UI配置界面交互

