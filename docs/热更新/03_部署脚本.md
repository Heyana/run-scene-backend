# 蓝绿部署脚本

## 目录结构

```
/root/project/
├── online_show_blue/       # 蓝环境 (:8001)
│   ├── online_show         # 可执行文件
│   ├── config.yaml
│   └── data/
├── online_show_green/      # 绿环境 (:8002)
│   ├── online_show
│   ├── config.yaml
│   └── data/               # 软链接到共享数据
├── shared/                 # 共享资源
│   └── data.db             # SQLite 数据库
└── deploy.sh               # 部署脚本
```

---

## 部署脚本

### deploy.sh

```bash
#!/bin/bash
set -e

# ==================== 配置 ====================
PROJECT_DIR="/root/project"
BLUE_DIR="$PROJECT_DIR/online_show_blue"
GREEN_DIR="$PROJECT_DIR/online_show_green"
NGINX_CONF="/etc/nginx/conf.d/online_show.conf"
NEW_BINARY="$1"  # 新版本二进制文件路径

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ==================== 检测当前活跃环境 ====================
get_active_env() {
    if grep -q "server 127.0.0.1:8001;" "$NGINX_CONF" | grep -v "#"; then
        echo "blue"
    else
        echo "green"
    fi
}

ACTIVE_ENV=$(get_active_env)
if [ "$ACTIVE_ENV" = "blue" ]; then
    CURRENT_DIR="$BLUE_DIR"
    CURRENT_PORT=8001
    TARGET_DIR="$GREEN_DIR"
    TARGET_PORT=8002
else
    CURRENT_DIR="$GREEN_DIR"
    CURRENT_PORT=8002
    TARGET_DIR="$BLUE_DIR"
    TARGET_PORT=8001
fi

echo -e "${GREEN}当前活跃: $ACTIVE_ENV (:$CURRENT_PORT)${NC}"
echo -e "${YELLOW}目标环境: $(basename $TARGET_DIR) (:$TARGET_PORT)${NC}"

# ==================== 1. 部署新版本 ====================
echo -e "\n${GREEN}[1/5] 部署新版本到 $TARGET_DIR${NC}"

if [ -n "$NEW_BINARY" ] && [ -f "$NEW_BINARY" ]; then
    cp "$NEW_BINARY" "$TARGET_DIR/online_show"
    chmod +x "$TARGET_DIR/online_show"
    echo -e "${GREEN}✓ 新版本已复制${NC}"
else
    echo -e "${YELLOW}⚠ 未指定新版本，使用现有文件${NC}"
fi

# ==================== 2. 启动新版本 ====================
echo -e "\n${GREEN}[2/5] 启动新版本 (:$TARGET_PORT)${NC}"

cd "$TARGET_DIR"
./online_show --port $TARGET_PORT &
NEW_PID=$!
echo -e "${GREEN}✓ 新版本已启动 (PID: $NEW_PID)${NC}"

# ==================== 3. 健康检查 ====================
echo -e "\n${GREEN}[3/5] 健康检查${NC}"

MAX_RETRY=30
for i in $(seq 1 $MAX_RETRY); do
    if curl -s "http://127.0.0.1:$TARGET_PORT/health" | grep -q "ok"; then
        echo -e "${GREEN}✓ 健康检查通过${NC}"
        break
    fi
    if [ $i -eq $MAX_RETRY ]; then
        echo -e "${RED}✗ 健康检查失败，回滚${NC}"
        kill $NEW_PID 2>/dev/null
        exit 1
    fi
    echo -e "${YELLOW}等待服务启动... ($i/$MAX_RETRY)${NC}"
    sleep 1
done

# ==================== 4. 切换流量 ====================
echo -e "\n${GREEN}[4/5] 切换 Nginx 流量${NC}"

# 切换上游服务器
sudo sed -i "s/server 127.0.0.1:$CURRENT_PORT;/# server 127.0.0.1:$CURRENT_PORT;/" "$NGINX_CONF"
sudo sed -i "s/# server 127.0.0.1:$TARGET_PORT;/server 127.0.0.1:$TARGET_PORT;/" "$NGINX_CONF"

# 热重载 Nginx
sudo nginx -t && sudo nginx -s reload
echo -e "${GREEN}✓ 流量已切换到 :$TARGET_PORT${NC}"

# ==================== 5. 关闭旧版本 ====================
echo -e "\n${GREEN}[5/5] 优雅关闭旧版本 (:$CURRENT_PORT)${NC}"

# 等待现有请求完成
sleep 5

# 发送 SIGTERM 优雅关闭
OLD_PID=$(lsof -t -i:$CURRENT_PORT 2>/dev/null)
if [ -n "$OLD_PID" ]; then
    kill -TERM $OLD_PID
    echo -e "${GREEN}✓ 旧版本已关闭 (PID: $OLD_PID)${NC}"
fi

# ==================== 完成 ====================
echo -e "\n${GREEN}========================================${NC}"
echo -e "${GREEN}  部署完成！${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "活跃环境: $(basename $TARGET_DIR) (:$TARGET_PORT)"
echo -e "新版本 PID: $NEW_PID"
```

---

## 使用方法

```bash
# 赋予执行权限
chmod +x /root/project/deploy.sh

# 部署新版本
sudo /root/project/deploy.sh /path/to/new/online_show

# 仅切换环境（不更新二进制）
sudo /root/project/deploy.sh
```

---

## Systemd 服务配置

### 蓝环境服务

```bash
# /etc/systemd/system/online_show_blue.service
[Unit]
Description=Online Show Blue
After=network.target

[Service]
Type=simple
WorkingDirectory=/root/project/online_show_blue
ExecStart=/root/project/online_show_blue/online_show --port 8001
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 绿环境服务

```bash
# /etc/systemd/system/online_show_green.service
# 同上，端口改为 8002，目录改为 green
```

### 启用服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable online_show_blue
sudo systemctl enable online_show_green
```

---

## 相关文档

- [概述](./01_概述.md)
- [Nginx 配置](./02_Nginx配置.md)
- [回滚流程](./04_回滚流程.md)
