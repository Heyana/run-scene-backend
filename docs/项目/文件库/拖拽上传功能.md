# 拖拽上传功能

## 功能概述

在文件库页面添加拖拽上传区域，支持拖拽文件或文件夹快速上传，无需点击按钮。

## 实现时间

2026年2月9日

## 功能特点

### 1. 拖拽上传区域

- 位置：面包屑导航下方
- 样式：虚线边框，悬停和拖拽时高亮
- 提示：清晰的文字说明

### 2. 支持多种上传方式

- **单个文件**: 拖拽单个文件直接上传
- **多个文件**: 拖拽多个文件批量上传
- **整个文件夹**: 拖拽文件夹保持结构上传

### 3. 智能识别

- 自动识别拖拽的是文件还是文件夹
- 文件夹自动遍历所有子文件
- 保持文件夹层级结构

### 4. 视觉反馈

- 拖拽进入时区域高亮
- 显示上传进度提示
- 上传完成后自动刷新列表

## 实现细节

### 1. 拖拽事件处理

#### dragenter - 拖拽进入

```typescript
const handleDragEnter = (e: DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  dragCounter.value++;
  if (dragCounter.value === 1) {
    isDragging.value = true;
  }
};
```

#### dragleave - 拖拽离开

```typescript
const handleDragLeave = (e: DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  dragCounter.value--;
  if (dragCounter.value === 0) {
    isDragging.value = false;
  }
};
```

#### dragover - 拖拽悬停

```typescript
const handleDragOver = (e: DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
};
```

#### drop - 放下文件

```typescript
const handleDrop = async (e: DragEvent) => {
  e.preventDefault();
  e.stopPropagation();
  isDragging.value = false;
  dragCounter.value = 0;

  const items = e.dataTransfer?.items;
  if (!items || items.length === 0) return;

  // 检查是否是文件夹
  const firstItem = items[0];
  const entry = firstItem.webkitGetAsEntry?.();

  if (entry?.isDirectory) {
    // 处理文件夹
    await handleFolderDrop(entry);
  } else {
    // 处理文件
    await handleFilesDrop(items);
  }
};
```

### 2. 文件夹遍历

使用 FileSystem API 递归遍历文件夹：

```typescript
const traverseDirectory = async (
  dirEntry: any,
  path: string = "",
): Promise<void> => {
  const reader = dirEntry.createReader();
  const entries = await new Promise<any[]>((resolve) => {
    reader.readEntries((entries: any[]) => resolve(entries));
  });

  for (const entry of entries) {
    const fullPath = path ? `${path}/${entry.name}` : entry.name;

    if (entry.isFile) {
      const file = await new Promise<File>((resolve) => {
        entry.file((file: File) => resolve(file));
      });
      files.push(file);
      filePaths.push(fullPath);
    } else if (entry.isDirectory) {
      await traverseDirectory(entry, fullPath);
    }
  }
};
```

### 3. 拖拽计数器

使用计数器解决嵌套元素的拖拽事件问题：

```typescript
// 拖拽进入时计数+1
dragCounter.value++;
if (dragCounter.value === 1) {
  isDragging.value = true;
}

// 拖拽离开时计数-1
dragCounter.value--;
if (dragCounter.value === 0) {
  isDragging.value = false;
}
```

这样可以避免在拖拽经过子元素时触发 dragleave 事件。

### 4. 样式设计

```less
.drag-upload-area {
  background: #fafafa;
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  padding: 32px;
  margin-bottom: 16px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;

  &:hover {
    border-color: #1890ff;
    background: #f0f7ff;
  }

  &.dragging {
    border-color: #1890ff;
    background: #e6f7ff;
    border-style: solid;
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(24, 144, 255, 0.2);
  }
}
```

## 使用方式

### 1. 上传单个文件

1. 从文件管理器拖拽一个文件
2. 拖到拖拽区域
3. 松开鼠标
4. 自动上传并刷新列表

### 2. 上传多个文件

1. 从文件管理器选中多个文件
2. 拖到拖拽区域
3. 松开鼠标
4. 批量上传所有文件

### 3. 上传文件夹

1. 从文件管理器拖拽一个文件夹
2. 拖到拖拽区域
3. 松开鼠标
4. 自动遍历文件夹并上传所有文件
5. 保持文件夹结构

## 技术要点

### 1. FileSystem API

使用 `webkitGetAsEntry()` 获取文件系统入口：

```typescript
const entry = item.webkitGetAsEntry();
if (entry.isDirectory) {
  // 是文件夹
} else if (entry.isFile) {
  // 是文件
}
```

### 2. 异步遍历

使用 Promise 包装异步读取操作：

```typescript
const entries = await new Promise<any[]>((resolve) => {
  reader.readEntries((entries: any[]) => resolve(entries));
});
```

### 3. 递归处理

递归遍历所有子文件夹：

```typescript
for (const entry of entries) {
  if (entry.isDirectory) {
    await traverseDirectory(entry, fullPath);
  }
}
```

### 4. 进度提示

使用 message 的 key 参数更新同一条消息：

```typescript
message.loading({ content: "正在读取文件夹...", key: "upload" });
// ...
message.loading({ content: "正在上传 50 个文件...", key: "upload" });
// ...
message.success({ content: "上传成功", key: "upload" });
```

## 浏览器兼容性

### FileSystem API 支持

- ✅ Chrome 21+
- ✅ Edge 79+
- ✅ Firefox 50+
- ✅ Safari 11.1+
- ❌ IE（不支持）

### 拖拽 API 支持

- ✅ 所有现代浏览器
- ✅ IE 9+

## 优势

### 1. 用户体验

- **快速**: 无需点击按钮，直接拖拽
- **直观**: 拖拽是最自然的文件操作方式
- **高效**: 支持批量上传和文件夹上传

### 2. 视觉反馈

- **悬停高亮**: 鼠标悬停时区域变色
- **拖拽高亮**: 拖拽时区域放大并高亮
- **进度提示**: 显示上传进度和结果

### 3. 智能处理

- **自动识别**: 自动识别文件或文件夹
- **保持结构**: 文件夹上传保持层级结构
- **错误处理**: 上传失败时显示详细错误

## 注意事项

### 1. 文件夹遍历限制

- 某些浏览器可能限制一次读取的文件数量
- 大型文件夹可能需要多次读取
- 建议单次上传不超过 1000 个文件

### 2. 安全限制

- 浏览器可能限制访问某些系统文件夹
- 隐藏文件可能无法访问
- 需要用户明确授权

### 3. 性能考虑

- 大量文件上传可能耗时较长
- 建议添加上传进度条
- 可以考虑并发上传优化

### 4. 错误处理

- 网络中断时需要重试机制
- 部分文件失败不影响其他文件
- 显示详细的错误信息

## 未来优化

### 1. 上传进度条

显示每个文件的上传进度：

```typescript
const [progress, setProgress] = useState(0);

await uploadDocument(formData, {
  onUploadProgress: (e) => {
    setProgress(Math.round((e.loaded * 100) / e.total));
  },
});
```

### 2. 并发上传

同时上传多个文件提高速度：

```typescript
const chunks = chunkArray(files, 5); // 每次上传5个
for (const chunk of chunks) {
  await Promise.all(chunk.map((file) => uploadFile(file)));
}
```

### 3. 断点续传

记录已上传的文件，失败后可以继续：

```typescript
const uploadedFiles = new Set();
// 上传成功后记录
uploadedFiles.add(file.name);
// 重试时跳过已上传的文件
if (uploadedFiles.has(file.name)) continue;
```

### 4. 拖拽预览

拖拽时显示文件列表预览：

```typescript
const handleDragOver = (e: DragEvent) => {
  const items = e.dataTransfer?.items;
  // 显示文件列表预览
  showFilePreview(items);
};
```

## 测试建议

### 1. 功能测试

- [x] 拖拽单个文件
- [x] 拖拽多个文件
- [x] 拖拽文件夹
- [x] 拖拽嵌套文件夹
- [ ] 拖拽空文件夹
- [ ] 拖拽大文件（100MB+）

### 2. 交互测试

- [x] 拖拽进入时高亮
- [x] 拖拽离开时恢复
- [x] 松开鼠标时上传
- [ ] 拖拽到其他区域时取消

### 3. 边界测试

- [ ] 拖拽非文件内容
- [ ] 拖拽系统文件夹
- [ ] 拖拽隐藏文件
- [ ] 拖拽快捷方式

### 4. 性能测试

- [ ] 拖拽大量文件（1000+）
- [ ] 拖拽大型文件夹（1GB+）
- [ ] 并发拖拽多个文件夹
- [ ] 内存占用测试

## 总结

拖拽上传功能已完成，主要特点：

✅ **快速上传**: 拖拽即可上传，无需点击按钮  
✅ **支持文件夹**: 自动遍历文件夹，保持结构  
✅ **视觉反馈**: 拖拽时高亮，上传时显示进度  
✅ **智能识别**: 自动识别文件或文件夹  
✅ **批量上传**: 支持多个文件同时上传

这个功能大大提升了文件库的易用性，让上传操作更加快捷和直观。
