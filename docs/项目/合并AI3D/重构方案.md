# AI3D 统一表重构方案

## 问题分析

### 当前架构问题

1. **ID 冲突**：`hunyuan_tasks` 和 `meshy_tasks` 各自维护 ID，导致统一列表中出现重复 ID
2. **数据分散**：两个表结构相似但分离，增加维护成本
3. **查询复杂**：需要分别查询两个表再合并，效率低
4. **扩展困难**：未来添加新平台需要创建新表，重复代码

### 目标架构

- **统一表**：`ai3d_tasks` 表存储所有平台的任务
- **适配器模式**：各平台通过适配器接口统一操作
- **唯一 ID**：全局唯一的任务 ID
- **易扩展**：新增平台只需实现适配器接口

---

## 数据库设计

### 统一任务表：ai3d_tasks

```sql
CREATE TABLE ai3d_tasks (
    -- 基础字段
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    deleted_at DATETIME,

    -- 平台信息
    provider VARCHAR(20) NOT NULL,              -- hunyuan | meshy | 未来平台
    provider_task_id VARCHAR(100) NOT NULL,     -- 平台的任务ID

    -- 任务状态（统一状态）
    status VARCHAR(20) NOT NULL,                -- WAIT | RUN | DONE | FAIL
    progress INTEGER DEFAULT 0,                 -- 0-100

    -- 输入参数（通用）
    input_type VARCHAR(20) NOT NULL,            -- text | image | multi_view
    prompt TEXT,                                -- 文本提示词
    image_url TEXT,                             -- 图片URL
    image_base64 TEXT,                          -- Base64图片（大字段，考虑单独存储）

    -- 生成参数（JSON存储平台特定参数）
    generation_params TEXT,                     -- JSON: {model, faceCount, enablePbr, topology, etc}

    -- 结果文件
    model_url TEXT,                             -- 平台返回的模型URL
    thumbnail_url TEXT,                         -- 平台返回的缩略图URL
    local_path TEXT,                            -- 本地存储路径
    nas_path TEXT,                              -- NAS存储路径
    thumbnail_path TEXT,                        -- 缩略图路径
    file_size INTEGER,                          -- 文件大小（字节）
    file_hash VARCHAR(32),                      -- MD5哈希

    -- 错误信息
    error_code VARCHAR(50),
    error_message TEXT,

    -- 元数据
    name VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(50) DEFAULT 'AI生成',
    tags TEXT,                                  -- JSON数组

    -- 用户信息
    created_by VARCHAR(100) NOT NULL,
    created_ip VARCHAR(50),

    -- 索引
    INDEX idx_provider (provider),
    INDEX idx_status (status),
    INDEX idx_created_by (created_by),
    INDEX idx_created_at (created_at),
    UNIQUE INDEX idx_provider_task (provider, provider_task_id)
);
```

---

## 代码架构

### 1. 统一模型：models/ai3d/task.go

```go
package ai3d

import (
    "database/sql/driver"
    "encoding/json"
    "time"
    "gorm.io/gorm"
)

// Task 统一AI3D任务模型
type Task struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"createdAt"`
    UpdatedAt time.Time      `json:"updatedAt"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    // 平台信息
    Provider       string `gorm:"index;not null" json:"provider"`
    ProviderTaskID string `gorm:"not null" json:"providerTaskId"`

    // 任务状态
    Status   string `gorm:"index;not null" json:"status"`
    Progress int    `json:"progress"`

    // 输入参数
    InputType    string  `gorm:"not null" json:"inputType"`
    Prompt       *string `json:"prompt,omitempty"`
    ImageURL     *string `json:"imageUrl,omitempty"`
    ImageBase64  *string `json:"-"` // 不返回给前端

    // 生成参数（JSON）
    GenerationParams GenerationParams `gorm:"type:text" json:"generationParams"`

    // 结果文件
    ModelURL      *string `json:"modelUrl,omitempty"`
    ThumbnailURL  *string `json:"thumbnailUrl,omitempty"`
    LocalPath     *string `json:"localPath,omitempty"`
    NASPath       *string `json:"nasPath,omitempty"`
    ThumbnailPath *string `json:"thumbnailPath,omitempty"`
    FileSize      *int64  `json:"fileSize,omitempty"`
    FileHash      *string `json:"fileHash,omitempty"`

    // 错误信息
    ErrorCode    *string `json:"errorCode,omitempty"`
    ErrorMessage *string `json:"errorMessage,omitempty"`

    // 元数据
    Name        string  `json:"name"`
    Description *string `json:"description,omitempty"`
    Category    string  `gorm:"index" json:"category"`
    Tags        *string `json:"tags,omitempty"`

    // 用户信息
    CreatedBy string `gorm:"index" json:"createdBy"`
    CreatedIP string `json:"createdIp"`
}

// GenerationParams 生成参数（平台特定）
type GenerationParams map[string]interface{}

// Scan 实现 sql.Scanner 接口
func (g *GenerationParams) Scan(value interface{}) error {
    if value == nil {
        *g = make(GenerationParams)
        return nil
    }
    bytes, ok := value.([]byte)
    if !ok {
        return fmt.Errorf("failed to unmarshal JSON value")
    }
    return json.Unmarshal(bytes, g)
}

// Value 实现 driver.Valuer 接口
func (g GenerationParams) Value() (driver.Value, error) {
    if g == nil {
        return "{}", nil
    }
    return json.Marshal(g)
}

// TableName 指定表名
func (Task) TableName() string {
    return "ai3d_tasks"
}
```

---

### 2. 适配器接口：services/ai3d/adapter.go

```go
package ai3d

import (
    "context"
    "go_wails_project_manager/models/ai3d"
)

// ProviderAdapter 平台适配器接口
type ProviderAdapter interface {
    // GetName 获取平台名称
    GetName() string

    // SubmitTask 提交任务到平台
    SubmitTask(ctx context.Context, task *ai3d.Task) (providerTaskID string, err error)

    // QueryTask 查询平台任务状态
    QueryTask(ctx context.Context, providerTaskID string) (*TaskStatus, error)

    // DownloadResult 下载任务结果
    DownloadResult(ctx context.Context, task *ai3d.Task) (*DownloadResult, error)

    // CancelTask 取消任务（可选）
    CancelTask(ctx context.Context, providerTaskID string) error
}

// TaskStatus 任务状态
type TaskStatus struct {
    Status        string  // WAIT | RUN | DONE | FAIL
    Progress      int     // 0-100
    ModelURL      string
    ThumbnailURL  string
    ErrorCode     string
    ErrorMessage  string
}

// DownloadResult 下载结果
type DownloadResult struct {
    LocalPath     string
    NASPath       string
    ThumbnailPath string
    FileSize      int64
    FileHash      string
}
```

---

### 3. 混元适配器：services/ai3d/adapters/hunyuan_adapter.go

```go
package adapters

import (
    "context"
    "go_wails_project_manager/models/ai3d"
    ai3dService "go_wails_project_manager/services/ai3d"
    hunyuanService "go_wails_project_manager/services/hunyuan"
)

type HunyuanAdapter struct {
    client  *hunyuanService.Client
    storage *hunyuanService.StorageService
}

func NewHunyuanAdapter(client *hunyuanService.Client, storage *hunyuanService.StorageService) *HunyuanAdapter {
    return &HunyuanAdapter{
        client:  client,
        storage: storage,
    }
}

func (a *HunyuanAdapter) GetName() string {
    return "hunyuan"
}

func (a *HunyuanAdapter) SubmitTask(ctx context.Context, task *ai3d.Task) (string, error) {
    // 从 task.GenerationParams 提取混元参数
    params := extractHunyuanParams(task)

    // 调用混元API
    resp, err := a.client.SubmitTask(params)
    if err != nil {
        return "", err
    }

    return resp.JobID, nil
}

func (a *HunyuanAdapter) QueryTask(ctx context.Context, providerTaskID string) (*ai3dService.TaskStatus, error) {
    // 调用混元API查询
    resp, err := a.client.QueryTask(providerTaskID)
    if err != nil {
        return nil, err
    }

    // 转换为统一状态
    return &ai3dService.TaskStatus{
        Status:       resp.Status, // 混元已经用统一状态
        Progress:     resp.Progress,
        ModelURL:     resp.ModelURL,
        ThumbnailURL: resp.ThumbnailURL,
        ErrorCode:    resp.ErrorCode,
        ErrorMessage: resp.ErrorMessage,
    }, nil
}

func (a *HunyuanAdapter) DownloadResult(ctx context.Context, task *ai3d.Task) (*ai3dService.DownloadResult, error) {
    // 调用存储服务下载
    return a.storage.DownloadAndSave(task)
}

func (a *HunyuanAdapter) CancelTask(ctx context.Context, providerTaskID string) error {
    return a.client.CancelTask(providerTaskID)
}
```

---

### 4. Meshy适配器：services/ai3d/adapters/meshy_adapter.go

```go
package adapters

import (
    "context"
    "go_wails_project_manager/models/ai3d"
    ai3dService "go_wails_project_manager/services/ai3d"
    meshyService "go_wails_project_manager/services/meshy"
)

type MeshyAdapter struct {
    client  *meshyService.Client
    storage *meshyService.StorageService
}

func NewMeshyAdapter(client *meshyService.Client, storage *meshyService.StorageService) *MeshyAdapter {
    return &MeshyAdapter{
        client:  client,
        storage: storage,
    }
}

func (a *MeshyAdapter) GetName() string {
    return "meshy"
}

func (a *MeshyAdapter) SubmitTask(ctx context.Context, task *ai3d.Task) (string, error) {
    // 从 task.GenerationParams 提取Meshy参数
    params := extractMeshyParams(task)

    // 调用Meshy API
    taskID, err := a.client.SubmitImageTo3D(params)
    if err != nil {
        return "", err
    }

    return taskID, nil
}

func (a *MeshyAdapter) QueryTask(ctx context.Context, providerTaskID string) (*ai3dService.TaskStatus, error) {
    // 调用Meshy API查询
    resp, err := a.client.GetTask(providerTaskID)
    if err != nil {
        return nil, err
    }

    // 转换Meshy状态为统一状态
    status := convertMeshyStatus(resp.Status)

    modelURL := ""
    if resp.ModelURLs != nil && resp.ModelURLs.GLB != "" {
        modelURL = resp.ModelURLs.GLB
    }

    return &ai3dService.TaskStatus{
        Status:       status,
        Progress:     resp.Progress,
        ModelURL:     modelURL,
        ThumbnailURL: resp.ThumbnailURL,
        ErrorMessage: getErrorMessage(resp.TaskError),
    }, nil
}

func (a *MeshyAdapter) DownloadResult(ctx context.Context, task *ai3d.Task) (*ai3dService.DownloadResult, error) {
    // 调用存储服务下载
    return a.storage.DownloadAndSave(task)
}

func (a *MeshyAdapter) CancelTask(ctx context.Context, providerTaskID string) error {
    return nil // Meshy不支持取消
}

// convertMeshyStatus 转换Meshy状态
func convertMeshyStatus(meshyStatus string) string {
    switch meshyStatus {
    case "PENDING":
        return "WAIT"
    case "IN_PROGRESS":
        return "RUN"
    case "SUCCEEDED":
        return "DONE"
    case "FAILED", "CANCELED":
        return "FAIL"
    default:
        return "WAIT"
    }
}
```

---

### 5. 统一任务服务：services/ai3d/task_service.go

```go
package ai3d

import (
    "context"
    "fmt"
    "go_wails_project_manager/models/ai3d"
    "gorm.io/gorm"
)

type TaskService struct {
    db       *gorm.DB
    adapters map[string]ProviderAdapter
}

func NewTaskService(db *gorm.DB) *TaskService {
    return &TaskService{
        db:       db,
        adapters: make(map[string]ProviderAdapter),
    }
}

// RegisterAdapter 注册平台适配器
func (s *TaskService) RegisterAdapter(adapter ProviderAdapter) {
    s.adapters[adapter.GetName()] = adapter
}

// CreateTask 创建任务
func (s *TaskService) CreateTask(ctx context.Context, task *ai3d.Task) error {
    // 获取适配器
    adapter, ok := s.adapters[task.Provider]
    if !ok {
        return fmt.Errorf("不支持的平台: %s", task.Provider)
    }

    // 提交到平台
    providerTaskID, err := adapter.SubmitTask(ctx, task)
    if err != nil {
        return fmt.Errorf("提交任务失败: %w", err)
    }

    // 保存到数据库
    task.ProviderTaskID = providerTaskID
    task.Status = "WAIT"
    task.Progress = 0

    return s.db.Create(task).Error
}

// GetTask 获取任务
func (s *TaskService) GetTask(id uint) (*ai3d.Task, error) {
    var task ai3d.Task
    err := s.db.First(&task, id).Error
    return &task, err
}

// ListTasks 任务列表
func (s *TaskService) ListTasks(page, pageSize int, filters map[string]string) ([]*ai3d.Task, int64, error) {
    query := s.db.Model(&ai3d.Task{})

    // 应用过滤器
    if provider := filters["provider"]; provider != "" {
        query = query.Where("provider = ?", provider)
    }
    if status := filters["status"]; status != "" {
        query = query.Where("status = ?", status)
    }
    if keyword := filters["keyword"]; keyword != "" {
        query = query.Where("name LIKE ?", "%"+keyword+"%")
    }

    // 统计总数
    var total int64
    query.Count(&total)

    // 分页查询
    var tasks []*ai3d.Task
    err := query.Order("created_at DESC").
        Offset((page - 1) * pageSize).
        Limit(pageSize).
        Find(&tasks).Error

    return tasks, total, err
}

// PollTask 轮询任务
func (s *TaskService) PollTask(ctx context.Context, id uint) error {
    task, err := s.GetTask(id)
    if err != nil {
        return err
    }

    // 已完成的任务不再轮询
    if task.Status == "DONE" || task.Status == "FAIL" {
        return nil
    }

    // 获取适配器
    adapter, ok := s.adapters[task.Provider]
    if !ok {
        return fmt.Errorf("不支持的平台: %s", task.Provider)
    }

    // 查询平台状态
    status, err := adapter.QueryTask(ctx, task.ProviderTaskID)
    if err != nil {
        return err
    }

    // 更新数据库
    updates := map[string]interface{}{
        "status":   status.Status,
        "progress": status.Progress,
    }

    if status.ModelURL != "" {
        updates["model_url"] = status.ModelURL
    }
    if status.ThumbnailURL != "" {
        updates["thumbnail_url"] = status.ThumbnailURL
    }
    if status.ErrorMessage != "" {
        updates["error_message"] = status.ErrorMessage
    }

    // 如果任务完成，下载文件
    if status.Status == "DONE" && status.ModelURL != "" {
        result, err := adapter.DownloadResult(ctx, task)
        if err == nil {
            updates["local_path"] = result.LocalPath
            updates["nas_path"] = result.NASPath
            updates["thumbnail_path"] = result.ThumbnailPath
            updates["file_size"] = result.FileSize
            updates["file_hash"] = result.FileHash
        }
    }

    return s.db.Model(task).Updates(updates).Error
}

// DeleteTask 删除任务
func (s *TaskService) DeleteTask(id uint) error {
    return s.db.Delete(&ai3d.Task{}, id).Error
}
```

---

### 6. 统一控制器：controllers/ai3d_controller.go

```go
package controllers

import (
    "net/http"
    "strconv"
    "github.com/gin-gonic/gin"
    "go_wails_project_manager/models/ai3d"
    ai3dService "go_wails_project_manager/services/ai3d"
    "go_wails_project_manager/response"
)

type AI3DController struct {
    taskService *ai3dService.TaskService
}

func NewAI3DController(taskService *ai3dService.TaskService) *AI3DController {
    return &AI3DController{
        taskService: taskService,
    }
}

// SubmitTask 提交任务
func (c *AI3DController) SubmitTask(ctx *gin.Context) {
    var req struct {
        Provider         string                 `json:"provider" binding:"required"`
        InputType        string                 `json:"inputType" binding:"required"`
        Prompt           *string                `json:"prompt"`
        ImageURL         *string                `json:"imageUrl"`
        ImageBase64      *string                `json:"imageBase64"`
        GenerationParams map[string]interface{} `json:"generationParams"`
        Name             *string                `json:"name"`
        Description      *string                `json:"description"`
    }

    if err := ctx.ShouldBindJSON(&req); err != nil {
        response.Error(ctx, http.StatusBadRequest, err.Error())
        return
    }

    // 构建任务
    task := &ai3d.Task{
        Provider:         req.Provider,
        InputType:        req.InputType,
        Prompt:           req.Prompt,
        ImageURL:         req.ImageURL,
        ImageBase64:      req.ImageBase64,
        GenerationParams: req.GenerationParams,
        Category:         "AI生成",
        CreatedBy:        ctx.GetString("username"),
        CreatedIP:        ctx.ClientIP(),
    }

    if req.Name != nil {
        task.Name = *req.Name
    } else {
        task.Name = fmt.Sprintf("任务_%s", time.Now().Format("20060102_150405"))
    }
    task.Description = req.Description

    // 创建任务
    if err := c.taskService.CreateTask(ctx, task); err != nil {
        response.Error(ctx, http.StatusInternalServerError, err.Error())
        return
    }

    response.Success(ctx, task)
}

// ListTasks 任务列表
func (c *AI3DController) ListTasks(ctx *gin.Context) {
    page, _ := strconv.Atoi(ctx.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(ctx.DefaultQuery("pageSize", "20"))

    filters := map[string]string{
        "provider": ctx.Query("provider"),
        "status":   ctx.Query("status"),
        "keyword":  ctx.Query("keyword"),
    }

    tasks, total, err := c.taskService.ListTasks(page, pageSize, filters)
    if err != nil {
        response.Error(ctx, http.StatusInternalServerError, "查询失败")
        return
    }

    response.Success(ctx, gin.H{
        "list":     tasks,
        "total":    total,
        "page":     page,
        "pageSize": pageSize,
    })
}

// GetTask 获取任务详情
func (c *AI3DController) GetTask(ctx *gin.Context) {
    id, _ := strconv.ParseUint(ctx.Param("id"), 10, 32)

    task, err := c.taskService.GetTask(uint(id))
    if err != nil {
        response.Error(ctx, http.StatusNotFound, "任务不存在")
        return
    }

    response.Success(ctx, task)
}

// PollTask 轮询任务
func (c *AI3DController) PollTask(ctx *gin.Context) {
    id, _ := strconv.ParseUint(ctx.Param("id"), 10, 32)

    if err := c.taskService.PollTask(ctx, uint(id)); err != nil {
        response.Error(ctx, http.StatusInternalServerError, err.Error())
        return
    }

    task, _ := c.taskService.GetTask(uint(id))
    response.Success(ctx, task)
}

// DeleteTask 删除任务
func (c *AI3DController) DeleteTask(ctx *gin.Context) {
    id, _ := strconv.ParseUint(ctx.Param("id"), 10, 32)

    if err := c.taskService.DeleteTask(uint(id)); err != nil {
        response.Error(ctx, http.StatusInternalServerError, "删除失败")
        return
    }

    response.Success(ctx, nil)
}
```

---

## 迁移步骤

### 1. 数据迁移脚本

```go
// database/migrations/merge_ai3d_tasks.go
func MergeAI3DTasks(db *gorm.DB) error {
    // 1. 创建新表
    if err := db.AutoMigrate(&ai3d.Task{}); err != nil {
        return err
    }

    // 2. 迁移混元任务
    var hunyuanTasks []hunyuan.Task
    db.Find(&hunyuanTasks)
    for _, ht := range hunyuanTasks {
        task := convertHunyuanTask(&ht)
        db.Create(task)
    }

    // 3. 迁移Meshy任务
    var meshyTasks []meshy.MeshyTask
    db.Find(&meshyTasks)
    for _, mt := range meshyTasks {
        task := convertMeshyTask(&mt)
        db.Create(task)
    }

    // 4. 备份旧表（不删除，以防需要回滚）
    // db.Exec("ALTER TABLE hunyuan_tasks RENAME TO hunyuan_tasks_backup")
    // db.Exec("ALTER TABLE meshy_tasks RENAME TO meshy_tasks_backup")

    return nil
}
```

### 2. 初始化适配器

```go
// bootstrap/ai3d.go
func InitAI3D(db *gorm.DB) *ai3dService.TaskService {
    taskService := ai3dService.NewTaskService(db)

    // 注册混元适配器
    hunyuanClient := hunyuanService.NewClient(...)
    hunyuanStorage := hunyuanService.NewStorageService(...)
    hunyuanAdapter := adapters.NewHunyuanAdapter(hunyuanClient, hunyuanStorage)
    taskService.RegisterAdapter(hunyuanAdapter)

    // 注册Meshy适配器
    meshyClient := meshyService.NewClient(...)
    meshyStorage := meshyService.NewStorageService(...)
    meshyAdapter := adapters.NewMeshyAdapter(meshyClient, meshyStorage)
    taskService.RegisterAdapter(meshyAdapter)

    return taskService
}
```

---

## 优势总结

### 1. 解决的问题

- ✅ **ID 唯一**：全局唯一 ID，不再冲突
- ✅ **查询简化**：单表查询，无需合并
- ✅ **易于扩展**：新平台只需实现适配器
- ✅ **代码复用**：通用逻辑统一处理

### 2. 架构优势

- **适配器模式**：隔离平台差异
- **单一职责**：每个适配器只负责一个平台
- **开闭原则**：对扩展开放，对修改关闭
- **依赖倒置**：依赖抽象接口，不依赖具体实现

### 3. 性能提升

- 单表查询，减少JOIN操作
- 统一索引，提高查询效率
- 减少数据转换开销

---

## 实施建议

1. **分阶段实施**
   - 第一阶段：创建新表和适配器，与旧系统并行
   - 第二阶段：迁移数据，验证功能
   - 第三阶段：切换到新系统，下线旧代码

2. **保持兼容**
   - 保留旧表作为备份
   - API 接口保持不变
   - 前端无需修改

3. **测试覆盖**
   - 单元测试：测试每个适配器
   - 集成测试：测试完整流程
   - 数据验证：确保迁移正确

---

## 文件清单

```
models/ai3d/
  └── task.go                          # 统一任务模型

services/ai3d/
  ├── adapter.go                       # 适配器接口
  ├── task_service.go                  # 统一任务服务
  └── adapters/
      ├── hunyuan_adapter.go           # 混元适配器
      └── meshy_adapter.go             # Meshy适配器

controllers/
  └── ai3d_controller.go               # 统一控制器（重写）

database/migrations/
  └── merge_ai3d_tasks.go              # 数据迁移脚本

bootstrap/
  └── ai3d.go                          # 初始化适配器
```

---

## 总结

这个方案通过**适配器模式**实现了平台无关的统一架构，解决了当前 ID 冲突、数据分散等问题，同时为未来扩展新平台提供了清晰的路径。实施后，系统将更加简洁、高效、易维护。
