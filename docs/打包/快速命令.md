# 快速打包命令参考

## 在服务器上一键打包部署

```bash
cd /root/project/online_show/后台 && bash docs/打包/build-on-linux.sh
```

---

## 完整流程（复制粘贴即可）

```bash
# 1. 进入项目目录
cd /root/project/online_show/后台

# 2. 更新代码（如果需要）
git pull

# 3. 运行打包脚本
sed -i 's/\r$//' docs/打包/build-on-linux.sh && bash docs/打包/build-on-linux.sh

# 4. 查看生成的文件
ls -lh release/*.tar.gz

# 5. 解压最新的包
cd release
tar -xzf online_show-linux-amd64-*.tar.gz

# 6. 热更新部署
cd ..
sudo bash hot-deploy.sh release/online_show/online_show

# 7. 验证
sudo systemctl status online_show.service

# 防止部分乱码

sed -i 's/\r$//' docs/打包/build-on-linux.sh && bash docs/打包/build-on-linux.sh
```



---
<!-- 查看实时打印 -->
sudo journalctl -u online_show -f

## 手动编译命令（如果脚本有问题）

```bash
cd /root/project/online_show/后台

# 1. 构建前端
cd frontend
npm install
npm run build
cd ..

# 2. 准备静态文件
cd dev
cp -r ../static ./static 2>/dev/null || true
cp -r ../website ./website 2>/dev/null || true
cd ..

# 3. 编译 Go
export CGO_ENABLED=0
export GOOS=linux
export GOARCH=amd64
go build -tags dev -trimpath -ldflags="-s -w" -o online_show ./dev/dev.go ./dev/dev_server.go

# 4. 查看文件
ls -lh online_show

# 5. 直接部署（不打包）
sudo bash hot-deploy.sh ./online_show
```

---

## 一键脚本（构建+部署）

创建文件 `quick-deploy.sh`：

```bash
#!/bin/bash
set -e

cd /root/project/online_show/后台

# 构建
bash docs/打包/build-on-linux.sh

# 部署
LATEST_TAR=$(ls -t release/online_show-linux-amd64-*.tar.gz | head -1)
TMP_DIR=$(mktemp -d)
tar -xzf "$LATEST_TAR" -C "$TMP_DIR"
sudo bash hot-deploy.sh "$TMP_DIR/online_show/online_show"
rm -rf "$TMP_DIR"

echo "✅ 构建并部署完成！"
```

使用：

```bash
chmod +x quick-deploy.sh
./quick-deploy.sh
```

---

## 只编译不打包（最快）

如果只需要可执行文件：

```bash
cd /root/project/online_show/后台

# 构建前端（首次或前端有改动时）
cd frontend && npm install && npm run build && cd ..

# 复制文件（首次）
cd dev && cp -r ../static ./static && cp -r ../website ./website && cd ..

# 编译
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -tags dev -trimpath -ldflags="-s -w" -o online_show ./dev/dev.go ./dev/dev_server.go

# 热部署
sudo bash hot-deploy.sh ./online_show
```

---

## 检查命令

```bash
# 查看服务状态
sudo systemctl status online_show.service

# 查看日志
sudo journalctl -u online_show.service -f

# 查看二进制文件信息
ls -lh /root/project/online_show/online_show
file /root/project/online_show/online_show

# 测试 API
curl http://localhost:23355/api/health
```

---

## 依赖说明

✨ **无需手动安装！**

脚本会自动检测并安装：
- Go 1.23.3
- Node.js 18.x  
- npm

支持系统：Ubuntu/Debian, CentOS/RHEL

如果自动安装失败，参考 `README.md` 中的手动安装说明。

---

## 清理构建缓存

```bash
cd /root/project/art-manager/后台

# 清理前端
cd frontend
rm -rf node_modules dist
npm install
npm run build
cd ..

# 清理 Go 缓存
go clean -cache -modcache -i -r

# 重新下载依赖
go mod download
```

---

## 回滚到旧版本

```bash
# 查看备份
ls -lh /root/project/online_show/backups/

# 使用备份回滚
sudo bash hot-deploy.sh /root/project/online_show/backups/online_show_YYYYMMDD_HHMMSS
```

---

## 故障排查

```bash
# 手动运行测试
cd /root/project/online_show
./online_show

# 查看端口占用
sudo netstat -tlnp | grep 23355

# 查看进程
ps aux | grep online_show

# 查看错误日志
cat /root/project/online_show/server_error.log
```

