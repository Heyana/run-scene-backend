# 快速参考

## 一键命令

### 首次部署

```bash
# 1. 安装 Nginx
sudo apt update && sudo apt install nginx -y

# 2. 创建目录
mkdir -p /root/project/{online_show_blue,online_show_green,shared}

# 3. 复制配置（见 02_Nginx配置.md）
sudo vim /etc/nginx/conf.d/online_show.conf

# 4. 部署并启动蓝环境
cp online_show /root/project/online_show_blue/
chmod +x /root/project/online_show_blue/online_show
cd /root/project/online_show_blue && ./online_show --port 8001 &

# 5. 启动 Nginx
sudo nginx -t && sudo systemctl start nginx
```

### 日常部署

```bash
# 完整部署（使用脚本）
sudo /root/project/deploy.sh /path/to/new/online_show

# 手动部署
cd /root/project/online_show_green
cp /path/to/new/online_show ./
./online_show --port 8002 &
# 健康检查通过后切换 Nginx
sudo sed -i 's/8001/8002/g' /etc/nginx/conf.d/online_show.conf  # 简化写法
sudo nginx -s reload
kill $(lsof -t -i:8001)
```

### 回滚

```bash
sudo /root/project/rollback.sh
```

---

## 常用命令速查

| 操作         | 命令                                                   |
| ------------ | ------------------------------------------------------ |
| 查看活跃端口 | `grep "server 127" /etc/nginx/conf.d/online_show.conf` |
| 检查 8001    | `curl http://127.0.0.1:8001/health`                    |
| 检查 8002    | `curl http://127.0.0.1:8002/health`                    |
| Nginx 状态   | `sudo systemctl status nginx`                          |
| Nginx 热重载 | `sudo nginx -s reload`                                 |
| 查看端口占用 | `lsof -i:8001`                                         |
| 优雅关闭进程 | `kill -TERM $(lsof -t -i:8001)`                        |
| 查看日志     | `tail -f /root/project/online_show_blue/app_log.txt`   |

---

## 端口约定

| 环境       | 端口   | 目录                              |
| ---------- | ------ | --------------------------------- |
| 蓝 (Blue)  | 8001   | `/root/project/online_show_blue`  |
| 绿 (Green) | 8002   | `/root/project/online_show_green` |
| Nginx      | 80/443 | -                                 |

---

## 注意事项

1. **数据库共享**: SQLite 文件放 `shared/`，两个环境软链接
2. **配置同步**: 修改 `config.yaml` 时两个目录都要改
3. **端口参数**: 服务需支持 `--port` 参数（需代码适配）
4. **健康检查**: 确保 `/health` 端点可用
