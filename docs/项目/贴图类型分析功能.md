# 贴图类型分析功能

## 功能概述

这个功能用于分析两个网站（PolyHaven 和 AmbientCG）的所有贴图类型，展示原始类型名称、数量、示例文件，以及建议的 Three.js 材质属性映射关系。

## 后端实现

### 1. 数据库分析模块

**文件**: `database/texture_type_analyzer.go`

主要功能：

- `AnalyzeAllTextureTypes()`: 分析所有贴图类型，按数据源分组统计
- `suggestThreeJSType()`: 根据原始类型名称自动推荐 Three.js 类型

返回数据结构：

```go
type TextureTypeAnalysis struct {
    OriginalType  string   // 原始类型名称（如 Diffuse_2k）
    Count         int      // 出现次数
    Source        string   // 数据源：polyhaven 或 ambientcg
    Examples      []string // 示例文件名（最多5个）
    SuggestedType string   // 建议的 Three.js 类型（如 map）
}
```

### 2. API 接口

**路由**: `GET /api/textures/analyze-types`

**控制器**: `TextureController.AnalyzeTextureTypes()`

**响应示例**:

```json
{
  "code": 200,
  "data": {
    "analysis": [
      {
        "original_type": "Diffuse",
        "count": 150,
        "source": "polyhaven",
        "examples": ["Diffuse_2k.jpg", "Diffuse_4k.jpg"],
        "suggested_type": "map"
      },
      {
        "original_type": "Metal058B_2K-JPG_Color",
        "count": 1,
        "source": "ambientcg",
        "examples": ["Metal058B_2K-JPG_Color.jpg"],
        "suggested_type": "map"
      }
    ],
    "total": 2
  }
}
```

### 3. 升级脚本集成

在 `database/migrations.go` 的 `RunOnceUpgrade()` 函数中添加了：

- `logTextureTypeAnalysis()`: 在升级时自动记录贴图类型分析到日志

## 前端实现

### 1. 页面组件

**文件**: `frontend/src/views/TextureTypeAnalysis.tsx`

**路由**: `/texture-analysis`

### 2. 功能特性

1. **数据源分离展示**
   - PolyHaven（网站1）
   - AmbientCG（网站2）

2. **统计信息**
   - 贴图类型总数
   - 文件总数
   - 已映射类型数量
   - 未映射类型数量

3. **详细表格**
   - 原始类型名称（带颜色标签）
   - 文件数量（支持排序）
   - 建议的 Three.js 类型（绿色=已映射，红色=未知）
   - 示例文件（可折叠查看）

4. **说明文档**
   - 常见映射关系说明
   - 使用指南

## 贴图类型映射规则

### PolyHaven 常见类型

| 原始类型     | Three.js 类型                   | 说明                               |
| ------------ | ------------------------------- | ---------------------------------- |
| Diffuse      | map                             | 基础颜色贴图                       |
| Rough        | roughnessMap                    | 粗糙度贴图                         |
| nor_gl       | normalMap                       | 法线贴图（OpenGL）                 |
| nor_dx       | normalMap                       | 法线贴图（DirectX）                |
| AO           | aoMap                           | 环境光遮蔽贴图                     |
| Displacement | displacementMap                 | 位移贴图                           |
| arm          | aoMap,roughnessMap,metalnessMap | 组合贴图（AO+Roughness+Metalness） |

### AmbientCG 常见类型

| 原始类型         | Three.js 类型   | 说明                |
| ---------------- | --------------- | ------------------- |
| Color            | map             | 基础颜色贴图        |
| Roughness        | roughnessMap    | 粗糙度贴图          |
| NormalGL         | normalMap       | 法线贴图（OpenGL）  |
| NormalDX         | normalMap       | 法线贴图（DirectX） |
| Metalness        | metalnessMap    | 金属度贴图          |
| Displacement     | displacementMap | 位移贴图            |
| AmbientOcclusion | aoMap           | 环境光遮蔽贴图      |
| Opacity          | alphaMap        | 透明度贴图          |
| Emission         | emissiveMap     | 自发光贴图          |

## 使用方法

### 1. 访问分析页面

在浏览器中访问：`http://localhost:23359/#/texture-analysis`

或从首页点击"贴图类型分析"按钮。

### 2. 查看分析结果

页面会自动加载并展示：

- 两个数据源的统计信息
- 详细的类型列表和映射关系
- 示例文件名

### 3. 查看日志分析

运行升级脚本后，可以在日志中查看分析结果：

```bash
# 查看日志
tail -f app_log.txt
```

日志会输出类似：

```
========== 贴图类型分析报告 ==========
共发现 15 种贴图类型

--- PolyHaven 数据源 ---
  Diffuse: 150 个文件 → 建议类型: map
  Rough: 150 个文件 → 建议类型: roughnessMap
  nor_gl: 150 个文件 → 建议类型: normalMap
  ...

--- AmbientCG 数据源 ---
  Color: 200 个文件 → 建议类型: map
  Roughness: 200 个文件 → 建议类型: roughnessMap
  NormalGL: 200 个文件 → 建议类型: normalMap
  ...

PolyHaven: 7 种类型, AmbientCG: 8 种类型
========================================
```

## 扩展映射规则

如果发现新的贴图类型需要映射，可以在 `database/texture_type_analyzer.go` 的 `suggestThreeJSType()` 函数中添加：

```go
mappings := map[string]string{
    // 添加新的映射规则
    "新类型名称": "对应的Three.js类型",
}
```

## 注意事项

1. 分析功能不会修改数据库，只是读取和展示
2. 建议的 Three.js 类型是自动推荐的，可能需要人工确认
3. 如果出现 "unknown" 类型，说明该类型还没有映射规则，需要手动添加
4. 页面支持按数量排序，方便找出最常见的类型

## 相关文件

- 后端分析模块: `database/texture_type_analyzer.go`
- 后端控制器: `controllers/texture_controller.go`
- 后端路由: `api/routes.go`
- 升级脚本: `database/migrations.go`
- 前端页面: `frontend/src/views/TextureTypeAnalysis.tsx`
- 前端路由: `frontend/src/router/index.ts`
