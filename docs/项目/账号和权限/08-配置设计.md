# 配置设计

## JWT 配置

### config/auth.yaml

```yaml
jwt:
  # JWT 密钥（生产环境必须修改）
  secret_key: "your-secret-key-change-in-production"

  # Token 过期时间
  access_token_expire: 24h # 访问令牌过期时间
  refresh_token_expire: 168h # 刷新令牌过期时间（7天）

  # Token 签发者
  issuer: "media-manager"

  # Token 查找位置
  token_lookup: "header:Authorization" # 或 "query:token" 或 "cookie:token"

  # Token 前缀
  token_head_name: "Bearer"

# 密码策略
password:
  # 最小长度
  min_length: 6

  # 是否要求包含数字
  require_number: false

  # 是否要求包含大写字母
  require_uppercase: false

  # 是否要求包含小写字母
  require_lowercase: false

  # 是否要求包含特殊字符
  require_special: false

  # 密码过期天数（0表示不过期）
  expire_days: 0

# 登录策略
login:
  # 最大失败次数
  max_fail_count: 5

  # 锁定时长（分钟）
  lock_duration: 30

  # 是否启用验证码
  enable_captcha: false

  # 失败多少次后启用验证码
  captcha_after_fails: 3

# 权限缓存
permission_cache:
  # 是否启用缓存
  enabled: true

  # 缓存过期时间
  expire: 300 # 5分钟

  # 缓存类型：memory, redis
  type: "memory"

  # Redis 配置（如果使用 redis）
  redis:
    host: "localhost"
    port: 6379
    password: ""
    db: 0

# 审计日志
audit:
  # 是否记录登录日志
  log_login: true

  # 是否记录权限变更
  log_permission_change: true

  # 是否记录用户操作
  log_user_action: true

# 默认角色
default_role: "viewer" # 新用户默认角色

# 是否允许自助注册
allow_register: false

# 是否启用权限系统
enable_auth: true
```

## 配置结构体

### config/auth_config.go

```go
type AuthConfig struct {
    JWT              JWTConfig              `yaml:"jwt"`
    Password         PasswordConfig         `yaml:"password"`
    Login            LoginConfig            `yaml:"login"`
    PermissionCache  PermissionCacheConfig  `yaml:"permission_cache"`
    Audit            AuditConfig            `yaml:"audit"`
    DefaultRole      string                 `yaml:"default_role"`
    AllowRegister    bool                   `yaml:"allow_register"`
    EnableAuth       bool                   `yaml:"enable_auth"`
}

type JWTConfig struct {
    SecretKey            string        `yaml:"secret_key"`
    AccessTokenExpire    time.Duration `yaml:"access_token_expire"`
    RefreshTokenExpire   time.Duration `yaml:"refresh_token_expire"`
    Issuer               string        `yaml:"issuer"`
    TokenLookup          string        `yaml:"token_lookup"`
    TokenHeadName        string        `yaml:"token_head_name"`
}

type PasswordConfig struct {
    MinLength        int  `yaml:"min_length"`
    RequireNumber    bool `yaml:"require_number"`
    RequireUppercase bool `yaml:"require_uppercase"`
    RequireLowercase bool `yaml:"require_lowercase"`
    RequireSpecial   bool `yaml:"require_special"`
    ExpireDays       int  `yaml:"expire_days"`
}

type LoginConfig struct {
    MaxFailCount      int  `yaml:"max_fail_count"`
    LockDuration      int  `yaml:"lock_duration"`
    EnableCaptcha     bool `yaml:"enable_captcha"`
    CaptchaAfterFails int  `yaml:"captcha_after_fails"`
}

type PermissionCacheConfig struct {
    Enabled bool          `yaml:"enabled"`
    Expire  int           `yaml:"expire"`
    Type    string        `yaml:"type"`
    Redis   RedisConfig   `yaml:"redis"`
}

type RedisConfig struct {
    Host     string `yaml:"host"`
    Port     int    `yaml:"port"`
    Password string `yaml:"password"`
    DB       int    `yaml:"db"`
}

type AuditConfig struct {
    LogLogin            bool `yaml:"log_login"`
    LogPermissionChange bool `yaml:"log_permission_change"`
    LogUserAction       bool `yaml:"log_user_action"`
}
```

## 加载配置

```go
var AuthAppConfig *AuthConfig

func LoadAuthConfig() (*AuthConfig, error) {
    configPath := "./config/auth.yaml"

    data, err := os.ReadFile(configPath)
    if err != nil {
        return nil, err
    }

    var config AuthConfig
    if err := yaml.Unmarshal(data, &config); err != nil {
        return nil, err
    }

    AuthAppConfig = &config
    return &config, nil
}

func GetAuthConfig() *AuthConfig {
    if AuthAppConfig == nil {
        config, err := LoadAuthConfig()
        if err != nil {
            logger.Log.Warnf("加载认证配置失败: %v，使用默认配置", err)
            return DefaultAuthConfig()
        }
        return config
    }
    return AuthAppConfig
}

func DefaultAuthConfig() *AuthConfig {
    return &AuthConfig{
        JWT: JWTConfig{
            SecretKey:          "default-secret-key",
            AccessTokenExpire:  24 * time.Hour,
            RefreshTokenExpire: 7 * 24 * time.Hour,
            Issuer:             "media-manager",
            TokenLookup:        "header:Authorization",
            TokenHeadName:      "Bearer",
        },
        Password: PasswordConfig{
            MinLength: 6,
        },
        Login: LoginConfig{
            MaxFailCount: 5,
            LockDuration: 30,
        },
        PermissionCache: PermissionCacheConfig{
            Enabled: true,
            Expire:  300,
            Type:    "memory",
        },
        DefaultRole:   "viewer",
        AllowRegister: false,
        EnableAuth:    true,
    }
}
```

## 环境变量支持

```go
func LoadAuthConfigWithEnv() (*AuthConfig, error) {
    config, err := LoadAuthConfig()
    if err != nil {
        config = DefaultAuthConfig()
    }

    // 从环境变量覆盖配置
    if secretKey := os.Getenv("JWT_SECRET_KEY"); secretKey != "" {
        config.JWT.SecretKey = secretKey
    }

    if issuer := os.Getenv("JWT_ISSUER"); issuer != "" {
        config.JWT.Issuer = issuer
    }

    if allowRegister := os.Getenv("ALLOW_REGISTER"); allowRegister != "" {
        config.AllowRegister = allowRegister == "true"
    }

    if enableAuth := os.Getenv("ENABLE_AUTH"); enableAuth != "" {
        config.EnableAuth = enableAuth == "true"
    }

    return config, nil
}
```

## 配置验证

```go
func (c *AuthConfig) Validate() error {
    if c.JWT.SecretKey == "" || c.JWT.SecretKey == "default-secret-key" {
        return fmt.Errorf("JWT密钥未配置或使用默认值，生产环境必须修改")
    }

    if c.Password.MinLength < 6 {
        return fmt.Errorf("密码最小长度不能小于6")
    }

    if c.Login.MaxFailCount < 1 {
        return fmt.Errorf("最大失败次数必须大于0")
    }

    if c.PermissionCache.Type != "memory" && c.PermissionCache.Type != "redis" {
        return fmt.Errorf("缓存类型只能是 memory 或 redis")
    }

    return nil
}
```

## 使用示例

```go
// 初始化时加载配置
func init() {
    config, err := config.LoadAuthConfigWithEnv()
    if err != nil {
        logger.Log.Fatalf("加载认证配置失败: %v", err)
    }

    if err := config.Validate(); err != nil {
        logger.Log.Fatalf("认证配置验证失败: %v", err)
    }

    logger.Log.Info("认证配置加载成功")
}

// 在代码中使用
func CreateJWTAuth() *middleware.JWTAuth {
    config := config.GetAuthConfig()

    return middleware.NewJWTAuth(middleware.JWTConfig{
        SecretKey:     config.JWT.SecretKey,
        ExpireTime:    config.JWT.AccessTokenExpire,
        RefreshTime:   config.JWT.RefreshTokenExpire,
        Issuer:        config.JWT.Issuer,
        TokenLookup:   config.JWT.TokenLookup,
        TokenHeadName: config.JWT.TokenHeadName,
    })
}
```

## 配置文件示例（生产环境）

```yaml
jwt:
  secret_key: "prod-secret-key-very-long-and-random-string-here"
  access_token_expire: 8h
  refresh_token_expire: 168h
  issuer: "media-manager-prod"
  token_lookup: "header:Authorization"
  token_head_name: "Bearer"

password:
  min_length: 8
  require_number: true
  require_uppercase: true
  require_lowercase: true
  require_special: false
  expire_days: 90

login:
  max_fail_count: 5
  lock_duration: 30
  enable_captcha: true
  captcha_after_fails: 3

permission_cache:
  enabled: true
  expire: 300
  type: "redis"
  redis:
    host: "redis.internal"
    port: 6379
    password: "redis-password"
    db: 0

audit:
  log_login: true
  log_permission_change: true
  log_user_action: true

default_role: "viewer"
allow_register: false
enable_auth: true
```
