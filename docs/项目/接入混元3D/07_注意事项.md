# 混元3D接入 - 注意事项

## API限制

### 并发限制

- 默认并发：3个任务
- 超出限制返回409错误
- 需在本地维护并发计数

### 任务有效期

- 任务ID有效期：24小时
- 超期任务无法查询
- 需定期清理过期记录

### 输入限制

- 提示词：≤1024字符
- 图片大小：base64 ≤6MB，URL ≤8MB
- 图片分辨率：128-5000像素
- 文本和图片不能同时存在

### 模型版本差异

- 3.0版本：支持LowPoly参数
- 3.1版本：不支持LowPoly，支持更多视角（top/bottom等）

## 安全性

### API密钥管理

- 密钥不要硬编码
- 使用环境变量或配置文件
- 响应中脱敏显示
- 日志中不记录完整密钥

### 权限控制

- 配置管理需要管理员权限
- 任务提交需要认证
- 任务查询需要权限验证
- 防止越权访问

### 输入验证

- 严格验证所有输入参数
- 防止SQL注入
- 防止路径遍历
- 限制文件大小

## 性能优化

### 数据库优化

- 为常用查询字段添加索引
- 定期清理过期数据
- 使用连接池
- 避免N+1查询

### 并发控制

- 使用数据库锁或Redis
- 避免竞态条件
- 合理设置超时时间
- 实现优雅降级

### 文件处理

- 异步下载文件
- 使用流式处理大文件
- 实现断点续传
- 定期清理临时文件

## 错误处理

### API调用失败

```go
// 实现重试机制
func (c *HunyuanClient) callWithRetry(fn func() error, maxRetries int) error {
    var err error
    for i := 0; i < maxRetries; i++ {
        err = fn()
        if err == nil {
            return nil
        }

        // 判断是否可重试
        if !isRetryableError(err) {
            return err
        }

        // 指数退避
        time.Sleep(time.Duration(math.Pow(2, float64(i))) * time.Second)
    }
    return err
}
```

### 任务超时

```go
// 定期检查超时任务
func (s *TaskService) CheckTimeoutTasks() {
    timeout := time.Now().Add(-24 * time.Hour)

    s.db.Model(&HunyuanTask{}).
        Where("status IN ?", []string{"WAIT", "RUN"}).
        Where("created_at < ?", timeout).
        Update("status", "FAIL").
        Update("error_message", "任务超时")
}
```

### 存储失败

```go
// 事务处理
func (s *StorageService) SaveTaskResult(task *HunyuanTask) error {
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 1. 下载文件
        files, err := s.downloadFiles(task.ResultFiles)
        if err != nil {
            return err
        }

        // 2. 保存到模型库
        modelID, err := s.saveToModelLibrary(files)
        if err != nil {
            // 清理已下载的文件
            s.cleanupFiles(files)
            return err
        }

        // 3. 更新任务记录
        return tx.Model(task).Update("model_id", modelID).Error
    })
}
```

## 监控告警

### 关键指标

- API调用成功率
- 任务完成率
- 平均处理时间
- 并发任务数
- 存储空间使用

### 告警规则

```yaml
alerts:
  - name: API调用失败率过高
    condition: failure_rate > 0.1
    duration: 5m

  - name: 任务积压
    condition: waiting_tasks > 10
    duration: 10m

  - name: 存储空间不足
    condition: disk_usage > 0.9
    duration: 5m
```

### 日志记录

```go
// 记录关键操作
logger.Info("提交任务",
    "jobId", jobID,
    "inputType", params.InputType,
    "user", userInfo.Username)

// 记录错误
logger.Error("任务失败",
    "jobId", task.JobID,
    "error", err.Error(),
    "errorCode", errorCode)
```

## 最佳实践

### 任务提交

- 提交前验证参数
- 检查并发限制
- 记录用户信息
- 返回任务ID供查询

### 任务轮询

- 使用合理的轮询间隔（5-10秒）
- 避免频繁查询
- 实现指数退避
- 设置最大轮询次数

### 结果存储

- 异步处理下载和保存
- 使用队列解耦
- 实现失败重试
- 记录详细日志

### 配置管理

- 提供合理的默认值
- 支持热更新
- 验证配置有效性
- 记录配置变更

## 常见问题

### Q1: 任务一直处于WAIT状态

**原因**：并发限制已满
**解决**：等待其他任务完成或增加并发限制

### Q2: 下载文件失败

**原因**：URL过期或网络问题
**解决**：实现重试机制，记录失败原因

### Q3: 保存到模型库失败

**原因**：存储空间不足或权限问题
**解决**：检查存储空间，验证文件权限

### Q4: API签名验证失败

**原因**：密钥错误或时间不同步
**解决**：检查密钥配置，同步系统时间

### Q5: 任务查询返回404

**原因**：任务已过期（>24小时）
**解决**：及时轮询任务，避免超时

## 维护建议

### 定期任务

- 每天清理过期任务记录
- 每周清理临时文件
- 每月统计使用情况
- 每季度审查配置

### 数据备份

- 定期备份任务记录
- 备份配置信息
- 备份生成的模型文件
- 制定恢复计划

### 版本升级

- 关注腾讯云API更新
- 测试新版本兼容性
- 平滑迁移数据
- 保留回滚方案

### 文档维护

- 更新API文档
- 记录问题和解决方案
- 维护操作手册
- 培训相关人员
