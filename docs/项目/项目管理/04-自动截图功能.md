# 项目管理系统 - 自动截图功能

## 功能概述

项目上传后，系统会自动生成预览截图，方便用户快速查看项目效果，无需打开完整页面。

## 技术实现

### 1. 使用的库

- **chromedp**: Go 语言的无头浏览器库，基于 Chrome DevTools Protocol
- 自动管理 Chrome/Chromium 浏览器
- 支持全屏截图、视口截图、PDF 导出等功能

### 2. 核心文件

#### `utils/screenshot.go`

提供截图相关的工具函数：

```go
// 生成网页截图（全屏）
GenerateScreenshot(url, outputPath, options)

// 生成缩略图（固定尺寸）
GenerateThumbnail(url, outputPath, width, height)

// 生成多种尺寸的预览图
GeneratePreviewScreenshots(url, outputDir)
```

**默认配置：**

- 视口尺寸: 1920x1080
- 图片质量: 90
- 页面加载等待: 60秒（1分钟，确保复杂页面完全加载）
- 超时时间: 90秒
- 智能等待: 先等待 body 元素加载，再等待固定时间

**默认配置：**

- 视口尺寸: 1920x1080
- 图片质量: 90
- 页面加载等待: 3秒
- 超时时间: 30秒

#### `services/project_service.go`

在 `UploadVersion` 方法中集成截图功能：

```go
// 10. 异步生成预览截图
go ps.generateScreenshotAsync(version)
```

**异步处理流程：**

1. 构建预览 URL（基于 BaseURL + 相对路径）
2. 检查 index.html 是否存在
3. 调用 chromedp 生成 1200x800 缩略图
4. 保存到 `{ExtractedPath}/thumbnail.png`
5. 更新数据库记录的 `thumbnail_path` 字段

### 3. 数据库变更

#### ProjectVersion 表新增字段

```go
ThumbnailPath string `gorm:"size:512" json:"thumbnail_path"`  // 缩略图路径
ThumbnailURL  string `gorm:"-" json:"thumbnail_url"`          // 缩略图URL（虚拟字段）
```

**迁移说明：**
系统启动时会自动添加新字段，无需手动迁移。

## 工作流程

```
上传版本
  ↓
解压文件
  ↓
创建版本记录
  ↓
【异步】生成截图
  ├─ 构建预览URL
  ├─ 启动无头浏览器
  ├─ 访问 index.html
  ├─ 等待页面加载（3秒）
  ├─ 截取 1200x800 缩略图
  ├─ 保存到 thumbnail.png
  └─ 更新数据库
```

## 配置要求

### 1. 必须配置 BaseURL

在 `configs/project_config.yaml` 中：

```yaml
base_url: "http://192.168.3.39:23359/projects"
```

**重要：** 截图功能需要通过 HTTP 访问页面，必须配置可访问的 BaseURL。

### 2. 系统要求

- **Windows**: 自动下载 Chrome
- **Linux**: 需要安装依赖

  ```bash
  # Ubuntu/Debian
  apt-get install -y chromium-browser

  # CentOS/RHEL
  yum install -y chromium
  ```

- **Docker**: 使用带 Chrome 的基础镜像
  ```dockerfile
  FROM golang:1.23-alpine
  RUN apk add --no-cache chromium
  ```

## API 响应变化

### 版本历史接口

`GET /api/projects/:id/versions`

**新增字段：**

```json
{
  "id": 1,
  "version": "1.0.1",
  "thumbnail_path": "\\\\192.168.3.10\\...\\v1.0.1\\thumbnail.png",
  "thumbnail_url": "http://192.168.3.39:23359/projects/123/v1.0.1/thumbnail.png",
  "preview_url": "http://192.168.3.39:23359/projects/123/v1.0.1/index.html"
}
```

## 前端集成建议

### 1. 显示缩略图

```tsx
{
  version.thumbnail_url && (
    <img
      src={version.thumbnail_url}
      alt="预览"
      style={{ width: "200px", cursor: "pointer" }}
      onClick={() => window.open(version.preview_url)}
    />
  );
}
```

### 2. 加载状态处理

```tsx
// 截图可能需要几秒钟生成
{
  !version.thumbnail_url && <Tag color="processing">截图生成中...</Tag>;
}
```

### 3. 图片懒加载

```tsx
<img
  src={version.thumbnail_url}
  loading="lazy"
  onError={(e) => {
    e.currentTarget.src = "/placeholder.png";
  }}
/>
```

## 性能优化

### 1. 异步处理

截图在后台异步执行，不阻塞上传响应，用户体验更好。

### 2. 超时控制

- 单次截图超时: 30秒
- 页面加载等待: 3秒
- 失败不影响版本上传

### 3. 资源管理

- 自动清理浏览器进程
- Context 超时自动取消
- 内存占用可控

## 故障排查

### 1. 截图失败

**日志位置：** 控制台输出

**常见原因：**

- BaseURL 未配置或无法访问
- index.html 不存在
- 页面加载超时
- Chrome 未安装或启动失败

**解决方法：**

```bash
# 查看日志
tail -f app_log.txt | grep "截图"

# 测试 URL 是否可访问
curl http://192.168.3.39:23359/projects/123/v1.0.1/index.html
```

### 2. 缩略图不显示

**检查清单：**

1. 数据库中 `thumbnail_path` 是否有值
2. 文件是否真实存在
3. 静态文件服务是否正常
4. URL 路径是否正确

### 3. 性能问题

**优化建议：**

- 减少页面加载等待时间（修改 `Delay`）
- 降低截图质量（修改 `Quality`）
- 减小缩略图尺寸（修改 width/height）

## 扩展功能

### 1. 多尺寸截图

```go
// 生成多种尺寸
screenshots, err := utils.GeneratePreviewScreenshots(url, outputDir)
// 返回: thumbnail (400x300), medium (800x600), large (1920x1080)
```

### 2. 自定义截图选项

```go
opts := &utils.ScreenshotOptions{
    Width:   1920,
    Height:  1080,
    Quality: 95,
    Delay:   5 * time.Second,
    Timeout: 60 * time.Second,
}
utils.GenerateScreenshot(url, output, opts)
```

### 3. PDF 导出

chromedp 也支持导出 PDF：

```go
chromedp.Run(ctx,
    chromedp.Navigate(url),
    chromedp.ActionFunc(func(ctx context.Context) error {
        buf, _, err := page.PrintToPDF().Do(ctx)
        if err != nil {
            return err
        }
        return ioutil.WriteFile("output.pdf", buf, 0644)
    }),
)
```

## 安全注意事项

1. **URL 验证**: 只截取内部项目 URL，防止 SSRF 攻击
2. **资源限制**: 控制并发截图数量，防止资源耗尽
3. **超时保护**: 设置合理超时，防止长时间阻塞
4. **错误处理**: 截图失败不影响主流程

## 总结

自动截图功能为项目管理系统增加了可视化预览能力，提升用户体验。通过异步处理和合理的超时控制，确保了系统的稳定性和性能。
