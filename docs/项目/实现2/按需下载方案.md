# AmbientCG æŒ‰éœ€ä¸‹è½½æ–¹æ¡ˆè®¾è®¡

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### å½“å‰é—®é¢˜

- PolyHaven æè´¨åº“ï¼šåŒæ­¥æ—¶ç›´æ¥ä¸‹è½½æ‰€æœ‰è´´å›¾ï¼ˆå ç”¨å¤§é‡å­˜å‚¨å’Œæ—¶é—´ï¼‰
- ç”¨æˆ·å¯èƒ½åªä½¿ç”¨å°‘é‡æè´¨ï¼Œé€ æˆèµ„æºæµªè´¹

### è§£å†³æ–¹æ¡ˆ

- **AmbientCG æè´¨åº“**ï¼šé‡‡ç”¨æŒ‰éœ€ä¸‹è½½æ¨¡å¼
- åˆå§‹åŒæ­¥ï¼šåªä¸‹è½½é¢„è§ˆå›¾ + å…ƒæ•°æ®
- è§¦å‘ä¸‹è½½ï¼šç”¨æˆ·ç‚¹å‡»ä½¿ç”¨æ—¶æ‰ä¸‹è½½å®é™…è´´å›¾

---

## ğŸ¯ å®ç°æµç¨‹

### é˜¶æ®µ 1ï¼šåˆå§‹åŒæ­¥ï¼ˆå…ƒæ•°æ® + é¢„è§ˆå›¾ï¼‰

```
1. è°ƒç”¨ AmbientCG API è·å–æè´¨åˆ—è¡¨
   GET /api/v2/full_json?type=Material&limit=100

2. éå†æ¯ä¸ªæè´¨ï¼š
   - ä¿å­˜å…ƒæ•°æ®åˆ° textures è¡¨
   - ä¸‹è½½é¢„è§ˆå›¾ï¼ˆ256-PNG æˆ– 512-PNGï¼‰
   - ä¿å­˜é¢„è§ˆå›¾åˆ° static/textures/{asset_id}/thumbnail.png
   - æ ‡è®°çŠ¶æ€ï¼šdownload_completed = false

3. ä¸ä¸‹è½½å®é™…è´´å›¾æ–‡ä»¶
```

**æ•°æ®åº“çŠ¶æ€**ï¼š

```go
Texture {
    AssetID: "Ground103"
    Name: "Ground 103"
    DownloadCompleted: false  // âš ï¸ å…³é”®å­—æ®µ
    SyncStatus: 2             // å·²åŒæ­¥ï¼ˆå…ƒæ•°æ®ï¼‰
    Files: [
        {
            FileType: "thumbnail"
            LocalPath: "static/textures/Ground103/thumbnail.png"
            Status: 1  // å·²ä¸‹è½½
        }
    ]
}
```

---

### é˜¶æ®µ 2ï¼šè§¦å‘ä¸‹è½½ï¼ˆç”¨æˆ·ç‚¹å‡»ä½¿ç”¨ï¼‰

#### å‰ç«¯æµç¨‹

```typescript
// ç”¨æˆ·å³é”®ç‚¹å‡» "ä½¿ç”¨" æ—¶
async click() {
    // 1. æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½
    if (!texture.download_completed) {
        // 2. æ˜¾ç¤ºä¸‹è½½æç¤º
        core.e.log('æ­£åœ¨ä¸‹è½½æè´¨åŒ…...', 'base')

        // 3. è°ƒç”¨ä¸‹è½½æ¥å£
        const result = await downloadTexture(texture.asset_id)

        // 4. ç­‰å¾…ä¸‹è½½å®Œæˆ
        if (result.success) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            texture.download_completed = true
            texture.files = result.files
        }
    }

    // 5. åº”ç”¨è´´å›¾åˆ°æè´¨
    await applyTexturesToMaterial(texture)
}
```

#### åç«¯æµç¨‹

```go
// POST /api/textures/download/:assetId
func DownloadTexture(c *gin.Context) {
    assetId := c.Param("assetId")

    // 1. æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½
    texture := GetTextureByAssetId(assetId)
    if texture.DownloadCompleted {
        return c.JSON(200, texture.Files)
    }

    // 2. è·å–ä¸‹è½½é“¾æ¥
    detail := ambientcg.GetMaterialDetail(assetId)
    downloadUrl := selectBestResolution(detail.Downloads) // é€‰æ‹© 2K-JPG

    // 3. ä¸‹è½½ ZIP åŒ…
    zipPath := downloadFile(downloadUrl)

    // 4. è§£å‹åˆ°ç›®æ ‡ç›®å½•
    extractPath := "static/textures/" + assetId
    extractZip(zipPath, extractPath)

    // 5. è§£ææ–‡ä»¶å¹¶ä¿å­˜åˆ°æ•°æ®åº“
    files := parseExtractedFiles(extractPath, assetId)
    saveFilesToDB(files)

    // 6. æ›´æ–°çŠ¶æ€
    texture.DownloadCompleted = true
    texture.Update()

    // 7. åˆ é™¤ä¸´æ—¶ ZIP
    os.Remove(zipPath)

    return c.JSON(200, files)
}
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡è°ƒæ•´

### 1. Texture è¡¨ï¼ˆå·²æœ‰å­—æ®µï¼‰

```go
type Texture struct {
    // ... ç°æœ‰å­—æ®µ
    DownloadCompleted bool `gorm:"default:false;index" json:"download_completed"` // âœ… å·²å­˜åœ¨
    Source            string `gorm:"size:20;index" json:"source"` // æ–°å¢ï¼šæ•°æ®æ¥æº
}
```

### 2. æ–°å¢å­—æ®µè¯´æ˜

| å­—æ®µ               | ç±»å‹   | è¯´æ˜                            | ç´¢å¼• |
| ------------------ | ------ | ------------------------------- | ---- |
| source             | string | æ•°æ®æ¥æºï¼špolyhaven / ambientcg | âœ…   |
| download_completed | bool   | æ˜¯å¦å·²ä¸‹è½½å®Œæ•´è´´å›¾              | âœ…   |

### 3. çŠ¶æ€ç»„åˆ

| source    | download_completed | sync_status | è¯´æ˜                           |
| --------- | ------------------ | ----------- | ------------------------------ |
| polyhaven | true               | 2           | PolyHaven æè´¨ï¼ˆå·²ä¸‹è½½ï¼‰       |
| ambientcg | false              | 2           | AmbientCG å…ƒæ•°æ®ï¼ˆæœªä¸‹è½½è´´å›¾ï¼‰ |
| ambientcg | true               | 2           | AmbientCG å®Œæ•´æè´¨ï¼ˆå·²ä¸‹è½½ï¼‰   |

---

## ğŸ”§ API æ¥å£è®¾è®¡

### 1. è§¦å‘ä¸‹è½½æ¥å£ï¼ˆæ–°å¢ï¼‰

```
POST /api/textures/download/:assetId
```

**è¯·æ±‚å‚æ•°**ï¼š

```json
{
  "resolution": "2K", // å¯é€‰ï¼š1K, 2K, 4K, 8Kï¼Œé»˜è®¤ 2K
  "format": "JPG" // å¯é€‰ï¼šJPG, PNGï¼Œé»˜è®¤ JPG
}
```

**å“åº”**ï¼š

```json
{
  "code": 200,
  "message": "ä¸‹è½½æˆåŠŸ",
  "data": {
    "asset_id": "Ground103",
    "download_completed": true,
    "files": [
      {
        "id": 1001,
        "file_type": "texture",
        "texture_type": "Diffuse",
        "file_name": "Ground103_2K-JPG_Color.jpg",
        "local_path": "static/textures/Ground103/Ground103_2K-JPG_Color.jpg",
        "full_url": "http://localhost:8080/textures/Ground103/Ground103_2K-JPG_Color.jpg",
        "file_size": 3456789,
        "resolution": "2K",
        "format": "jpg"
      }
      // ... å…¶ä»–è´´å›¾æ–‡ä»¶
    ]
  }
}
```

**é”™è¯¯å“åº”**ï¼š

```json
{
  "code": 500,
  "message": "ä¸‹è½½å¤±è´¥ï¼šç½‘ç»œé”™è¯¯",
  "data": null
}
```

### 2. æ£€æŸ¥ä¸‹è½½çŠ¶æ€æ¥å£ï¼ˆæ–°å¢ï¼‰

```
GET /api/textures/download-status/:assetId
```

**å“åº”**ï¼š

```json
{
  "code": 200,
  "data": {
    "asset_id": "Ground103",
    "download_completed": false,
    "has_preview": true,
    "estimated_size": "32.23 MB", // é¢„ä¼°ä¸‹è½½å¤§å°
    "available_resolutions": ["1K", "2K", "4K", "8K"]
  }
}
```

### 3. æ‰¹é‡ä¸‹è½½æ¥å£ï¼ˆå¯é€‰ï¼‰

```
POST /api/textures/batch-download
```

**è¯·æ±‚**ï¼š

```json
{
  "asset_ids": ["Ground103", "Wood094", "Grass005"],
  "resolution": "2K"
}
```

---

## ğŸ¨ å‰ç«¯ UI è°ƒæ•´

### 1. æè´¨å¡ç‰‡çŠ¶æ€æ˜¾ç¤º

```tsx
<div class="texture-card">
  {/* é¢„è§ˆå›¾ */}
  <div class="texture-preview">
    <img src={previewUrl} />

    {/* æœªä¸‹è½½æ ‡è¯† */}
    {!texture.download_completed && (
      <div class="download-badge">
        <span class="icon">â¬‡ï¸</span>
        <span>ç‚¹å‡»ä¸‹è½½</span>
      </div>
    )}

    {/* ä¸‹è½½ä¸­æ ‡è¯† */}
    {downloading && (
      <div class="downloading-overlay">
        <div class="spinner"></div>
        <span>ä¸‹è½½ä¸­...</span>
      </div>
    )}
  </div>

  {/* æè´¨ä¿¡æ¯ */}
  <div class="texture-info">
    <div class="texture-name">{texture.name}</div>
    <div class="texture-meta">
      {texture.download_completed ? (
        <span class="status-ready">âœ… å·²å°±ç»ª</span>
      ) : (
        <span class="status-pending">â³ å¾…ä¸‹è½½</span>
      )}
    </div>
  </div>
</div>
```

### 2. å³é”®èœå•è°ƒæ•´

```tsx
onContextmenu={(event) => {
  RightMenuMethods.set({
    components: [
      {
        name: texture.download_completed ? "ä½¿ç”¨" : "ä¸‹è½½å¹¶ä½¿ç”¨",
        async click() {
          // å¦‚æœæœªä¸‹è½½ï¼Œå…ˆä¸‹è½½
          if (!texture.download_completed) {
            setDownloading(true)
            try {
              const result = await downloadTexture(texture.asset_id, {
                resolution: "2K",
                format: "JPG"
              })

              // æ›´æ–°æœ¬åœ°æ•°æ®
              texture.download_completed = true
              texture.files = result.files

              core.e.log('æè´¨ä¸‹è½½å®Œæˆ', 'base')
            } catch (error) {
              core.e.log('ä¸‹è½½å¤±è´¥: ' + error.message, 'base')
              return
            } finally {
              setDownloading(false)
            }
          }

          // åº”ç”¨è´´å›¾
          await applyTexturesToMaterial(texture)
        }
      },
      // å¦‚æœæœªä¸‹è½½ï¼Œæ˜¾ç¤º"ä»…ä¸‹è½½"é€‰é¡¹
      ...(!texture.download_completed ? [{
        name: "ä»…ä¸‹è½½ï¼ˆä¸åº”ç”¨ï¼‰",
        async click() {
          await downloadTexture(texture.asset_id)
        }
      }] : [])
    ]
  })
}}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### ä¸‹è½½åçš„ç›®å½•ç»“æ„

```
static/
â””â”€â”€ textures/
    â””â”€â”€ Ground103/                          # Asset ID ä½œä¸ºæ–‡ä»¶å¤¹å
        â”œâ”€â”€ thumbnail.png                   # é¢„è§ˆå›¾ï¼ˆåˆå§‹åŒæ­¥æ—¶ä¸‹è½½ï¼‰
        â”œâ”€â”€ Ground103_2K-JPG_Color.jpg      # é¢œè‰²è´´å›¾
        â”œâ”€â”€ Ground103_2K-JPG_Normal.jpg     # æ³•çº¿è´´å›¾
        â”œâ”€â”€ Ground103_2K-JPG_Roughness.jpg  # ç²—ç³™åº¦è´´å›¾
        â”œâ”€â”€ Ground103_2K-JPG_Displacement.jpg
        â”œâ”€â”€ Ground103_2K-JPG_AO.jpg
        â””â”€â”€ Ground103_2K-JPG.blend          # æè´¨æ–‡ä»¶ï¼ˆå¯é€‰ä¿ç•™ï¼‰
```

---

## ğŸ”„ åŒæ­¥æœåŠ¡è°ƒæ•´

### 1. AmbientCG åŒæ­¥æœåŠ¡ï¼ˆæ–°å»ºï¼‰

```go
// services/ambientcg_sync.go
type AmbientCGSyncService struct {
    adapter *AmbientCGAdapter
}

// åŒæ­¥å…ƒæ•°æ®ï¼ˆä¸ä¸‹è½½è´´å›¾ï¼‰
func (s *AmbientCGSyncService) SyncMetadata() error {
    offset := 0
    limit := 100

    for {
        // 1. è·å–æè´¨åˆ—è¡¨
        materials, err := s.adapter.GetMaterialList(limit, offset)
        if err != nil {
            return err
        }

        if len(materials) == 0 {
            break
        }

        // 2. éå†å¤„ç†
        for _, material := range materials {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            existing := GetTextureByAssetId(material.AssetID)
            if existing != nil {
                continue // è·³è¿‡å·²å­˜åœ¨çš„
            }

            // 3. ä¿å­˜å…ƒæ•°æ®
            texture := &Texture{
                AssetID:           material.AssetID,
                Name:              material.DisplayName,
                Source:            "ambientcg",
                DownloadCompleted: false,  // âš ï¸ å…³é”®ï¼šæ ‡è®°æœªä¸‹è½½
                SyncStatus:        2,      // å·²åŒæ­¥å…ƒæ•°æ®
                // ... å…¶ä»–å­—æ®µ
            }
            texture.Create()

            // 4. ä¸‹è½½é¢„è§ˆå›¾
            previewUrl := material.PreviewImage["256-PNG"]
            if previewUrl != "" {
                s.downloadPreview(texture.AssetID, previewUrl)
            }
        }

        offset += limit
    }

    return nil
}

// ä¸‹è½½é¢„è§ˆå›¾
func (s *AmbientCGSyncService) downloadPreview(assetId, url string) error {
    // åˆ›å»ºç›®å½•
    dir := filepath.Join("static", "textures", assetId)
    os.MkdirAll(dir, 0755)

    // ä¸‹è½½æ–‡ä»¶
    savePath := filepath.Join(dir, "thumbnail.png")
    err := downloadFile(url, savePath)
    if err != nil {
        return err
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    file := &File{
        FileType:    "thumbnail",
        RelatedType: "Texture",
        LocalPath:   savePath,
        FileName:    "thumbnail.png",
        Status:      1,
    }
    file.Create()

    return nil
}
```

### 2. ä¸‹è½½æœåŠ¡ï¼ˆæ–°å»ºï¼‰

```go
// services/texture_download.go
type TextureDownloadService struct {
    adapter *AmbientCGAdapter
}

// ä¸‹è½½æè´¨åŒ…
func (s *TextureDownloadService) DownloadTexture(assetId string, opts DownloadOptions) error {
    // 1. è·å–æè´¨ä¿¡æ¯
    texture := GetTextureByAssetId(assetId)
    if texture == nil {
        return errors.New("æè´¨ä¸å­˜åœ¨")
    }

    if texture.DownloadCompleted {
        return nil // å·²ä¸‹è½½ï¼Œç›´æ¥è¿”å›
    }

    // 2. è·å–ä¸‹è½½é“¾æ¥
    detail, err := s.adapter.GetMaterialDetail(assetId)
    if err != nil {
        return err
    }

    // 3. é€‰æ‹©åˆé€‚çš„ä¸‹è½½åŒ…
    downloadUrl := s.selectDownload(detail.Downloads, opts)

    // 4. ä¸‹è½½ ZIP
    zipPath := filepath.Join("temp", assetId+".zip")
    err = downloadFile(downloadUrl, zipPath)
    if err != nil {
        return err
    }
    defer os.Remove(zipPath)

    // 5. è§£å‹
    extractPath := filepath.Join("static", "textures", assetId)
    err = extractZip(zipPath, extractPath)
    if err != nil {
        return err
    }

    // 6. è§£ææ–‡ä»¶
    files, err := s.parseFiles(extractPath, assetId)
    if err != nil {
        return err
    }

    // 7. ä¿å­˜åˆ°æ•°æ®åº“
    for _, file := range files {
        file.Create()
    }

    // 8. æ›´æ–°çŠ¶æ€
    texture.DownloadCompleted = true
    texture.Update()

    return nil
}

// é€‰æ‹©ä¸‹è½½åŒ…
func (s *TextureDownloadService) selectDownload(downloads []Download, opts DownloadOptions) string {
    resolution := opts.Resolution
    if resolution == "" {
        resolution = "2K" // é»˜è®¤ 2K
    }

    format := opts.Format
    if format == "" {
        format = "JPG" // é»˜è®¤ JPG
    }

    // æŸ¥æ‰¾åŒ¹é…çš„ä¸‹è½½åŒ…
    target := resolution + "-" + format
    for _, dl := range downloads {
        if dl.Attribute == target {
            return dl.DownloadLink
        }
    }

    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
    return downloads[0].DownloadLink
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘ä¸‹è½½æ§åˆ¶

```go
// ä½¿ç”¨ worker pool æ§åˆ¶å¹¶å‘
type DownloadWorkerPool struct {
    workers   int
    taskQueue chan DownloadTask
}

func (p *DownloadWorkerPool) Start() {
    for i := 0; i < p.workers; i++ {
        go p.worker()
    }
}

func (p *DownloadWorkerPool) worker() {
    for task := range p.taskQueue {
        task.Execute()
    }
}
```

### 2. ä¸‹è½½è¿›åº¦é€šçŸ¥

```go
// ä½¿ç”¨ WebSocket æ¨é€ä¸‹è½½è¿›åº¦
type DownloadProgress struct {
    AssetID     string  `json:"asset_id"`
    Status      string  `json:"status"` // downloading, extracting, completed
    Progress    float64 `json:"progress"` // 0-100
    CurrentFile string  `json:"current_file"`
}

// æ¨é€è¿›åº¦
func notifyProgress(assetId string, progress DownloadProgress) {
    wsManager.Broadcast("texture_download", progress)
}
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

- âœ… å…ƒæ•°æ®åŒæ­¥æµ‹è¯•
- âœ… é¢„è§ˆå›¾ä¸‹è½½æµ‹è¯•
- âœ… æè´¨åŒ…ä¸‹è½½æµ‹è¯•
- âœ… æ–‡ä»¶è§£ææµ‹è¯•

### 2. é›†æˆæµ‹è¯•

- âœ… å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆåŒæ­¥ â†’ ä¸‹è½½ â†’ åº”ç”¨ï¼‰
- âœ… å¹¶å‘ä¸‹è½½æµ‹è¯•
- âœ… é”™è¯¯é‡è¯•æµ‹è¯•

### 3. å‰ç«¯æµ‹è¯•

- âœ… UI çŠ¶æ€æ˜¾ç¤ºæµ‹è¯•
- âœ… ä¸‹è½½äº¤äº’æµ‹è¯•
- âœ… åº”ç”¨æè´¨æµ‹è¯•

---

## ğŸ“ å®ç°æ­¥éª¤

### Phase 1: æ•°æ®åº“è°ƒæ•´ âœ…

1. æ·»åŠ  `source` å­—æ®µåˆ° Texture è¡¨
2. ç¡®è®¤ `download_completed` å­—æ®µå­˜åœ¨
3. æ•°æ®åº“è¿ç§»

### Phase 2: åç«¯å®ç°

1. åˆ›å»º AmbientCG é€‚é…å™¨
2. å®ç°å…ƒæ•°æ®åŒæ­¥æœåŠ¡
3. å®ç°ä¸‹è½½æœåŠ¡
4. æ·»åŠ ä¸‹è½½ API æ¥å£

### Phase 3: å‰ç«¯è°ƒæ•´

1. ä¿®æ”¹æè´¨å¡ç‰‡ UIï¼ˆæ˜¾ç¤ºä¸‹è½½çŠ¶æ€ï¼‰
2. æ·»åŠ ä¸‹è½½é€»è¾‘
3. è°ƒæ•´å³é”®èœå•
4. æ·»åŠ ä¸‹è½½è¿›åº¦æç¤º

### Phase 4: æµ‹è¯•ä¸ä¼˜åŒ–

1. åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. é”™è¯¯å¤„ç†å®Œå–„

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### å­˜å‚¨èŠ‚çœ

- **åˆå§‹åŒæ­¥**ï¼š1957 ä¸ªæè´¨ Ã— 100KBï¼ˆé¢„è§ˆå›¾ï¼‰â‰ˆ 196 MB
- **æŒ‰éœ€ä¸‹è½½**ï¼šç”¨æˆ·åªä¸‹è½½ä½¿ç”¨çš„æè´¨
- **èŠ‚çœæ¯”ä¾‹**ï¼šå‡è®¾ç”¨æˆ·ä½¿ç”¨ 10% æè´¨ï¼ŒèŠ‚çœ 90% å­˜å‚¨ç©ºé—´

### åŒæ­¥é€Ÿåº¦

- **åˆå§‹åŒæ­¥**ï¼šåªä¸‹è½½é¢„è§ˆå›¾ï¼Œé€Ÿåº¦æå‡ 100 å€
- **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿæµè§ˆï¼ŒæŒ‰éœ€ä¸‹è½½ï¼Œå³ç”¨å³ä¸‹

### å¸¦å®½ä¼˜åŒ–

- **æœåŠ¡å™¨å¸¦å®½**ï¼šåˆå§‹åŒæ­¥å¸¦å®½éœ€æ±‚é™ä½ 99%
- **ç”¨æˆ·å¸¦å®½**ï¼šæŒ‰éœ€ä¸‹è½½ï¼Œé¿å…æµªè´¹
