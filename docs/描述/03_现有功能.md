# 现有功能

## 配置系统

| 文件                      | 说明                        |
| ------------------------- | --------------------------- |
| `config/config.go`        | YAML 配置加载、环境变量覆盖 |
| `config/backup_config.go` | 备份相关配置                |
| `config.yaml`             | 主配置文件                  |

**功能**:

- 支持 YAML + ENV + 环境变量三级优先级
- 开发/生产环境自动切换
- 安全配置动态调整

---

## 安全中间件

> 位置: `api/security_middleware.go`

| 中间件                               | 功能                      |
| ------------------------------------ | ------------------------- |
| `RateLimitMiddleware`                | 令牌桶速率限制            |
| `IPFilterMiddleware`                 | IP 黑白名单过滤           |
| `DDoSProtectionMiddleware`           | 并发连接限制              |
| `DetectSuspiciousActivityMiddleware` | SQL 注入/XSS/路径遍历检测 |
| `SecurityHeadersMiddleware`          | 安全响应头                |
| `CorsMiddleware`                     | 跨域配置                  |
| `RequestSizeLimitMiddleware`         | 请求体大小限制            |
| `ProtectSensitivePathsMiddleware`    | 敏感路径保护              |

---

## 备份系统

| 文件                             | 功能                   |
| -------------------------------- | ---------------------- |
| `services/backup_service.go`     | 数据库备份             |
| `services/backup_scheduler.go`   | 定时调度 (12:00/24:00) |
| `services/cdn_backup_service.go` | CDN 文件备份           |

**特性**: 定时备份、增量备份、腾讯云 COS 支持

---

## 数据库

| 文件                     | 功能              |
| ------------------------ | ----------------- |
| `database/database.go`   | GORM 连接、初始化 |
| `database/migrations.go` | 自动迁移          |

**模型** (`models/models.go`):

- `MediaLibrary` - 媒体库
- `MediaFile` - 媒体文件
- `MediaTag` - 标签
- `SystemConfig` - 系统配置
- `ResourceFile` - 通用资源

---

## 日志系统

> 位置: `logger/logger.go`

- logrus 多输出 (控制台+文件)
- 自动日志级别切换
- 时间戳格式化

---

## 响应封装

> 位置: `response/response.go`

```go
type Response struct {
    Code      ResponseCode
    Msg       string
    Data      interface{}
    Timestamp int64
}
```

**辅助函数**: `Success()`, `Error()`, `BadRequest()`, `NotFound()` 等

---

## API 路由

> 位置: `api/routes.go`

| 路由组             | 功能           |
| ------------------ | -------------- |
| `/api/ping`        | 健康检查       |
| `/api/extension/*` | 浏览器扩展对接 |
| `/api/library/*`   | 媒体库管理     |
| `/api/media/*`     | 媒体文件管理   |
| `/api/security/*`  | 安全管理       |
| `/api/backup/*`    | 备份管理       |

---

## JWT 认证

> 位置: `middleware/auth.go`

```go
type JWTAuth struct { ... }

func (j *JWTAuth) GenerateToken(userID, username, role) (string, error)
func (j *JWTAuth) ParseToken(tokenString) (*Claims, error)
func (j *JWTAuth) AuthMiddleware() gin.HandlerFunc
func (j *JWTAuth) RoleMiddleware(roles ...string) gin.HandlerFunc
```

**辅助函数**: `HashPassword()`, `CheckPassword()`, `GetUserID()`, `GetUsername()`

---

## 请求验证

> 位置: `utils/validator.go`

```go
func ValidateStruct(obj interface{}) error
func BindAndValidate(c *gin.Context, obj interface{}) bool
func BindQueryAndValidate(c *gin.Context, obj interface{}) bool
```

**自定义验证器**: `mobile`, `username`

---

## 分页工具

> 位置: `utils/pagination.go`

```go
type PageRequest struct { Page, PageSize, Sort, Order }
type PageResponse struct { List, Total, Page, PageSize, Pages }

func NewPageRequest(c *gin.Context) *PageRequest
func Paginate(req *PageRequest) func(db *gorm.DB) *gorm.DB
func PaginateQuery(db, req, dest) (*PageResponse, error)
```

---

## 优雅关闭

> 位置: `server/graceful.go`

```go
type GracefulShutdown struct { ... }

func NewGracefulShutdown(server *http.Server) *GracefulShutdown
func (g *GracefulShutdown) ListenForShutdown()
func (g *GracefulShutdown) Shutdown()
func WaitForShutdownSignal(server, cleanup...)
```

---

## Panic 恢复

> 位置: `middleware/recovery.go`

```go
func RecoveryMiddleware() gin.HandlerFunc
func RecoveryWithLog(isDev bool) gin.HandlerFunc
```

---

## 其他

- **静态文件服务**: embed.FS 嵌入
- **API 文档**: Swagger (开发环境)
- **热重载**: Air 支持

## 相关文档

- [项目概述](./01_项目概述.md)
- [项目架构](./02_项目架构.md)
- [缺失功能](./04_缺失功能.md)
