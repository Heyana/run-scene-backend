# 文件组功能 - 数据模型

## 核心表结构

### DocumentGroup - 文件组表

```go
type DocumentGroup struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    Name        string    `gorm:"size:200;index" json:"name"`
    Description string    `gorm:"type:text" json:"description"`
    Category    string    `gorm:"size:50;index" json:"category"`
    Tags        string    `gorm:"type:text" json:"tags"`

    // 嵌套支持
    ParentID    *uint     `gorm:"index" json:"parent_id"`           // 父组ID，null表示顶级组
    Level       int       `gorm:"default:0" json:"level"`           // 层级：0=顶级，1=一级子组...
    Path        string    `gorm:"size:500" json:"path"`             // 路径：/1/3/5（便于查询）

    // 权限
    Department  string    `gorm:"size:50;index" json:"department"`
    Project     string    `gorm:"size:100;index" json:"project"`
    IsPublic    bool      `gorm:"default:false" json:"is_public"`

    // 统计
    FileCount   int       `gorm:"default:0" json:"file_count"`      // 直接文件数
    TotalFiles  int       `gorm:"default:0" json:"total_files"`     // 包含子组的总文件数
    TotalSize   int64     `gorm:"default:0" json:"total_size"`      // 包含子组的总大小
    ChildCount  int       `gorm:"default:0" json:"child_count"`     // 子组数量
    ViewCount   int       `gorm:"default:0" json:"view_count"`

    // 创建信息
    CreatedBy   string    `gorm:"size:100" json:"created_by"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`

    // 关联（不存储到数据库）
    Children    []DocumentGroup `gorm:"foreignKey:ParentID" json:"children,omitempty"`
}
```

### DocumentGroupItem - 组文件关联表

```go
type DocumentGroupItem struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    GroupID     uint      `gorm:"index:idx_group_doc" json:"group_id"`
    DocumentID  uint      `gorm:"index:idx_group_doc" json:"document_id"`

    // 组内属性
    SortOrder   int       `gorm:"default:0" json:"sort_order"`
    IsPrimary   bool      `gorm:"default:false" json:"is_primary"` // 主文件标记
    Note        string    `gorm:"size:500" json:"note"`

    CreatedAt   time.Time `json:"created_at"`

    // 关联
    Document    *Document `gorm:"foreignKey:DocumentID" json:"document,omitempty"`
}
```

## 索引设计

```go
// DocumentGroup
gorm:"index:idx_name"           // 按名称查询
gorm:"index:idx_category"       // 按分类查询
gorm:"index:idx_department"     // 按部门查询
gorm:"index:idx_project"        // 按项目查询
gorm:"index:idx_parent_id"      // 按父组查询（嵌套）
gorm:"index:idx_path"           // 按路径查询（嵌套）

// DocumentGroupItem
gorm:"uniqueIndex:idx_group_doc" // 组+文件唯一索引
gorm:"index:idx_group_id"        // 按组查询
gorm:"index:idx_document_id"     // 按文件查询
```

## 关系说明

```
DocumentGroup (1) ----< (N) DocumentGroupItem (N) >---- (1) Document
DocumentGroup (1) ----< (N) DocumentGroup (子组)

一个文件组包含多个文件
一个文件可以属于多个组
一个文件组可以包含多个子组（嵌套）
```

## 数据约束

1. **唯一性** - 同一文件在同一组中只能出现一次
2. **级联删除** - 删除组时删除所有关联记录和子组
3. **自动解除** - 删除文件时自动解除所有组关联
4. **统计同步** - 添加/删除文件时自动更新组统计（包括父组）
5. **循环检测** - 创建子组时检测循环引用
6. **权限继承** - 子组自动继承父组的部门和项目权限

## 嵌套规则

1. **Path 字段** - 格式：`/1/3/5`，便于查询所有子孙组
2. **Level 字段** - 从 0 开始，便于限制嵌套深度
3. **统计传播** - 子组的文件变化会向上传播更新父组统计
4. **批量下载** - 下载时保持目录结构（父组/子组/文件）
