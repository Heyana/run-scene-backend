# 后端实现

## 功能

接收前端传来的用户需求和节点元数据，调用AI生成蓝图JSON并返回。

## 目录结构

```
run-scene-backend/
├── config/
│   ├── config.go
│   └── ai_config.go          # 新增
├── controllers/
│   └── blueprint_controller.go  # 新增
├── services/
│   └── ai/
│       ├── ai_client.go      # 新增
│       └── prompt_builder.go # 新增
└── models/
    └── blueprint.go          # 新增
```

## 实现步骤

### 1. 配置 (config/ai_config.go)

```go
package config

type AIConfig struct {
	Provider    string  // "openai" | "claude"
	APIKey      string
	Model       string
	Temperature float64
	MaxTokens   int
}

// 在 config.yaml 添加
ai:
  provider: "openai"
  api_key: "${OPENAI_API_KEY}"
  model: "gpt-4"
  temperature: 0.7
  max_tokens: 4000
```

### 2. 数据模型 (models/blueprint.go)

```go
package models

type GenerateRequest struct {
	UserRequest string                 `json:"userRequest" binding:"required"`
	Metadata    map[string]NodeMetadata `json:"metadata" binding:"required"`
}

type NodeMetadata struct {
	Type       string         `json:"type"`
	Category   string         `json:"category"`
	Inputs     []PortInfo     `json:"inputs"`
	Outputs    []PortInfo     `json:"outputs"`
	Properties []PropertyInfo `json:"properties"`
}

type PortInfo struct {
	Name string `json:"name"`
	Type string `json:"type"`
}

type PropertyInfo struct {
	Key   string `json:"key"`
	Label string `json:"label"`
	Type  string `json:"type"`
}

type GraphJSON struct {
	Nodes []NodeConfig `json:"nodes"`
	Links []LinkConfig `json:"links"`
}

type NodeConfig struct {
	ID         int                    `json:"id"`
	Type       string                 `json:"type"`
	Pos        [2]float64             `json:"pos"`
	Properties map[string]interface{} `json:"properties"`
	Title      string                 `json:"title,omitempty"`
}

type LinkConfig [6]interface{}
```

### 3. AI客户端 (services/ai/ai_client.go)

```go
package ai

import (
	"bytes"
	"encoding/json"
	"net/http"
)

type AIClient struct {
	apiKey  string
	model   string
	baseURL string
}

func NewAIClient(apiKey, model string) *AIClient {
	return &AIClient{
		apiKey:  apiKey,
		model:   model,
		baseURL: "https://api.openai.com/v1/chat/completions",
	}
}

func (c *AIClient) Generate(prompt string) (string, error) {
	reqBody := map[string]interface{}{
		"model": c.model,
		"messages": []map[string]string{
			{"role": "user", "content": prompt},
		},
		"temperature": 0.7,
	}

	body, _ := json.Marshal(reqBody)
	req, _ := http.NewRequest("POST", c.baseURL, bytes.NewBuffer(body))
	req.Header.Set("Authorization", "Bearer "+c.apiKey)
	req.Header.Set("Content-Type", "application/json")

	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		return "", err
	}
	defer resp.Body.Close()

	var result map[string]interface{}
	json.NewDecoder(resp.Body).Decode(&result)

	choices := result["choices"].([]interface{})
	message := choices[0].(map[string]interface{})["message"].(map[string]interface{})
	content := message["content"].(string)

	return content, nil
}
```

### 4. Prompt构建 (services/ai/prompt_builder.go)

```go
package ai

import (
	"fmt"
	"strings"
	"go_wails_project_manager/models"
)

func BuildPrompt(userRequest string, metadata map[string]models.NodeMetadata) string {
	nodeList := buildNodeList(metadata)

	return fmt.Sprintf(`你是3D场景蓝图生成专家。

用户需求：%s

可用节点：
%s

生成规则：
1. 节点从左到右排列，水平间距300px，垂直间距150px
2. event连event，models连models
3. 只返回JSON，格式：
{
  "nodes": [{"id":1,"type":"节点类型","pos":[x,y],"properties":{},"title":"标题"}],
  "links": [[linkId,originId,originSlot,targetId,targetSlot,"type"]]
}`, userRequest, nodeList)
}

func buildNodeList(metadata map[string]models.NodeMetadata) string {
	var lines []string
	for _, node := range metadata {
		inputs := []string{}
		for _, i := range node.Inputs {
			inputs = append(inputs, fmt.Sprintf("%s(%s)", i.Name, i.Type))
		}
		outputs := []string{}
		for _, o := range node.Outputs {
			outputs = append(outputs, fmt.Sprintf("%s(%s)", o.Name, o.Type))
		}

		line := fmt.Sprintf("- %s\n  输入:[%s] 输出:[%s]",
			node.Type,
			strings.Join(inputs, ","),
			strings.Join(outputs, ","))
		lines = append(lines, line)
	}
	return strings.Join(lines, "\n")
}
```

### 5. 控制器 (controllers/blueprint_controller.go)

````go
package controllers

import (
	"encoding/json"
	"net/http"
	"strings"

	"github.com/gin-gonic/gin"
	"go_wails_project_manager/config"
	"go_wails_project_manager/models"
	"go_wails_project_manager/response"
	"go_wails_project_manager/services/ai"
)

type BlueprintController struct {
	aiClient *ai.AIClient
}

func NewBlueprintController() *BlueprintController {
	client := ai.NewAIClient(
		config.AppConfig.AI.APIKey,
		config.AppConfig.AI.Model,
	)
	return &BlueprintController{aiClient: client}
}

func (c *BlueprintController) Generate(ctx *gin.Context) {
	var req models.GenerateRequest
	if err := ctx.ShouldBindJSON(&req); err != nil {
		response.Error(ctx, http.StatusBadRequest, "参数错误")
		return
	}

	// 构建Prompt
	prompt := ai.BuildPrompt(req.UserRequest, req.Metadata)

	// 调用AI
	aiResponse, err := c.aiClient.Generate(prompt)
	if err != nil {
		response.Error(ctx, http.StatusInternalServerError, "AI调用失败")
		return
	}

	// 提取JSON
	graphJSON := extractJSON(aiResponse)

	response.Success(ctx, gin.H{
		"graphJson": graphJSON,
	})
}

func extractJSON(text string) map[string]interface{} {
	// 提取```json...```或{...}
	start := strings.Index(text, "{")
	end := strings.LastIndex(text, "}")
	if start == -1 || end == -1 {
		return nil
	}

	jsonStr := text[start : end+1]
	var result map[string]interface{}
	json.Unmarshal([]byte(jsonStr), &result)
	return result
}
````

### 6. 路由注册 (api/routes.go)

```go
// 在 RegisterRoutes 中添加
blueprintController := controllers.NewBlueprintController()

blueprint := api.Group("/blueprint")
{
	blueprint.POST("/generate", blueprintController.Generate)
}
```

## 完成
