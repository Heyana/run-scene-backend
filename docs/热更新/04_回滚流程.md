# 回滚流程

## 快速回滚（秒级）

蓝绿部署的最大优势：旧版本仍在运行或刚关闭，可立即回滚。

### 情况 1：旧版本仍在运行

```bash
# 直接切换 Nginx 回旧端口
# 假设当前是 8002，回滚到 8001

sudo sed -i 's/server 127.0.0.1:8002;/# server 127.0.0.1:8002;/' /etc/nginx/conf.d/online_show.conf
sudo sed -i 's/# server 127.0.0.1:8001;/server 127.0.0.1:8001;/' /etc/nginx/conf.d/online_show.conf
sudo nginx -s reload

echo "已回滚到 :8001"
```

### 情况 2：旧版本已关闭

```bash
# 1. 重启旧版本
cd /root/project/online_show_blue
./online_show --port 8001 &

# 2. 等待启动
sleep 3
curl http://127.0.0.1:8001/health

# 3. 切换流量
sudo sed -i 's/server 127.0.0.1:8002;/# server 127.0.0.1:8002;/' /etc/nginx/conf.d/online_show.conf
sudo sed -i 's/# server 127.0.0.1:8001;/server 127.0.0.1:8001;/' /etc/nginx/conf.d/online_show.conf
sudo nginx -s reload

# 4. 关闭问题版本
kill $(lsof -t -i:8002)
```

---

## 回滚脚本

### rollback.sh

```bash
#!/bin/bash
set -e

NGINX_CONF="/etc/nginx/conf.d/online_show.conf"
BLUE_DIR="/root/project/online_show_blue"
GREEN_DIR="/root/project/online_show_green"

# 检测当前活跃端口
if grep -q "^[^#]*server 127.0.0.1:8001;" "$NGINX_CONF"; then
    CURRENT_PORT=8001
    ROLLBACK_PORT=8002
    ROLLBACK_DIR="$GREEN_DIR"
else
    CURRENT_PORT=8002
    ROLLBACK_PORT=8001
    ROLLBACK_DIR="$BLUE_DIR"
fi

echo "当前活跃: :$CURRENT_PORT"
echo "回滚目标: :$ROLLBACK_PORT"

# 检查回滚目标是否运行
if ! lsof -i:$ROLLBACK_PORT > /dev/null 2>&1; then
    echo "启动回滚目标..."
    cd "$ROLLBACK_DIR"
    ./online_show --port $ROLLBACK_PORT &
    sleep 3
fi

# 健康检查
if ! curl -s "http://127.0.0.1:$ROLLBACK_PORT/health" | grep -q "ok"; then
    echo "回滚目标健康检查失败！"
    exit 1
fi

# 切换流量
sudo sed -i "s/server 127.0.0.1:$CURRENT_PORT;/# server 127.0.0.1:$CURRENT_PORT;/" "$NGINX_CONF"
sudo sed -i "s/# server 127.0.0.1:$ROLLBACK_PORT;/server 127.0.0.1:$ROLLBACK_PORT;/" "$NGINX_CONF"
sudo nginx -s reload

echo "✓ 已回滚到 :$ROLLBACK_PORT"
```

---

## 故障排查

| 问题           | 检查命令                     | 解决方案      |
| -------------- | ---------------------------- | ------------- |
| Nginx 无法启动 | `nginx -t`                   | 检查配置语法  |
| 端口被占用     | `lsof -i:8001`               | kill 占用进程 |
| 服务无响应     | `curl localhost:8001/health` | 查看服务日志  |
| 权限不足       | -                            | 使用 sudo     |

---

## 相关文档

- [概述](./01_概述.md)
- [部署脚本](./03_部署脚本.md)
