# 审计系统设计

## 概述

审计系统用于记录用户操作历史，包括 IP、用户、时间、操作类型等信息，便于追溯和安全分析。

## 存储方案

采用同数据库存储方案，适用于中小规模应用（<10GB 数据，<500 用户）。

优势：

- 实现简单，无需额外数据库连接管理
- 事务一致性好，操作和审计日志原子性写入
- 查询方便，可直接关联业务表

劣势：

- 数据量大时影响主库性能
- 需要定期清理历史数据

## 数据模型

### AuditLog 审计日志表

```go
type AuditLog struct {
    ID           uint      `gorm:"primaryKey"`
    UserID       *uint     `gorm:"index"`                    // 用户ID（可为空，匿名操作）
    Username     string    `gorm:"size:100;index"`           // 用户名
    UserIP       string    `gorm:"size:50;index"`            // 客户端IP
    Action       string    `gorm:"size:50;index"`            // 操作类型
    Resource     string    `gorm:"size:100;index"`           // 资源类型
    ResourceID   *uint     `gorm:"index"`                    // 资源ID
    Method       string    `gorm:"size:10"`                  // HTTP方法
    Path         string    `gorm:"size:512"`                 // 请求路径
    StatusCode   int       `gorm:"index"`                    // 响应状态码
    Duration     int64     // 请求耗时（毫秒）
    RequestBody  string    `gorm:"type:text"`                // 请求体（敏感信息需脱敏）
    ResponseBody string    `gorm:"type:text"`                // 响应体（可选）
    ErrorMsg     string    `gorm:"type:text"`                // 错误信息
    UserAgent    string    `gorm:"size:512"`                 // 用户代理
    CreatedAt    time.Time `gorm:"index"`                    // 创建时间
}
```

### 操作类型定义

```go
const (
    ActionLogin          = "login"           // 登录
    ActionLogout         = "logout"          // 登出
    ActionCreate         = "create"          // 创建
    ActionUpdate         = "update"          // 更新
    ActionDelete         = "delete"          // 删除
    ActionView           = "view"            // 查看
    ActionDownload       = "download"        // 下载
    ActionUpload         = "upload"          // 上传
    ActionMove           = "move"            // 移动
    ActionRename         = "rename"          // 重命名
    ActionShare          = "share"           // 分享
    ActionExport         = "export"          // 导出
    ActionImport         = "import"          // 导入
)
```

### 资源类型定义

```go
const (
    ResourceDocument     = "document"        // 文档
    ResourceFolder       = "folder"          // 文件夹
    ResourceUser         = "user"            // 用户
    ResourceProject      = "project"         // 项目
    ResourceModel        = "model"           // 模型
    ResourceTexture      = "texture"         // 材质
)
```

## 中间件实现

### AuditMiddleware 审计中间件

```go
func AuditMiddleware() gin.HandlerFunc {
    shouldAudit(path string) bool
    extractUserInfo(c *gin.Context) (userID *uint, username string)
    sanitizeRequestBody(body string) string
    createAuditLog(c *gin.Context, startTime time.Time)
}
```

### 审计规则

- 记录所有 API 请求（排除静态资源）
- 敏感信息脱敏（密码、token）
- 异步写入，不阻塞主流程
- 失败重试机制

## 查询服务

### AuditQueryService 审计查询服务

```go
type AuditQueryService struct {
    List(filter AuditFilter) ([]AuditLog, int64, error)
    GetByID(id uint) (*AuditLog, error)
    GetByUser(userID uint, limit int) ([]AuditLog, error)
    GetByResource(resource string, resourceID uint) ([]AuditLog, error)
    GetByIP(ip string, limit int) ([]AuditLog, error)
    GetStatistics(startTime, endTime time.Time) (*AuditStatistics, error)
}

type AuditFilter struct {
    UserID     *uint
    Username   string
    UserIP     string
    Action     string
    Resource   string
    ResourceID *uint
    StartTime  *time.Time
    EndTime    *time.Time
    StatusCode *int
    Page       int
    PageSize   int
}

type AuditStatistics struct {
    TotalCount      int64
    ActionCount     map[string]int64
    ResourceCount   map[string]int64
    TopUsers        []UserActivity
    TopIPs          []IPActivity
}
```

## 数据清理策略

### 自动归档

- 保留最近 7 天热数据在数据库
- 每天凌晨 2 点执行归档任务
- 7 天前数据打包为 JSON 文件存储到 NAS
- 归档文件路径：`{nas_path}/audit_archives/{year}/{month}/{day}/audit_{timestamp}.json`
- 归档后从数据库删除原记录

### 归档服务

```go
type AuditArchiveService struct {
    ArchiveOldLogs(beforeDate time.Time) (int64, error)
    ExportToFile(logs []AuditLog, filePath string) error
    LoadFromArchive(filePath string) ([]AuditLog, error)
    ListArchiveFiles(startDate, endDate time.Time) ([]string, error)
}
```

### 归档文件格式

```json
{
  "archive_date": "2026-02-05",
  "record_count": 1523,
  "date_range": {
    "start": "2026-02-05T00:00:00Z",
    "end": "2026-02-05T23:59:59Z"
  },
  "logs": [
    {
      "id": 1,
      "user_id": 10,
      "username": "admin",
      "user_ip": "192.168.1.100",
      "action": "upload",
      "resource": "document",
      "resource_id": 123,
      "method": "POST",
      "path": "/api/documents/upload",
      "status_code": 200,
      "duration": 1250,
      "created_at": "2026-02-05T10:30:45Z"
    }
  ]
}
```

## 性能优化

### 索引策略

- user_id, username, user_ip, action, resource, created_at 建立索引
- 复合索引：(resource, resource_id), (user_id, created_at)

### 分区表（可选）

按月分区，提高查询和清理效率：

```sql
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at))
```

### 异步写入

使用 channel 缓冲队列，批量写入数据库。

## API 接口

### 查询审计日志

```
GET /api/audit/logs
Query: user_id, username, ip, action, resource, start_time, end_time, page, page_size
```

### 获取统计信息

```
GET /api/audit/statistics
Query: start_time, end_time
```

### 导出审计日志

```
POST /api/audit/export
Body: { filter, format: "csv" | "json" | "excel" }
```

## 安全考虑

- 审计日志只读，不允许修改或删除（除自动清理）
- 管理员权限才能查看完整审计日志
- 普通用户只能查看自己的操作历史
- 敏感字段脱敏（密码、token、身份证号等）
- 防止日志注入攻击

## 实施计划

1. 创建数据模型和迁移脚本
2. 实现审计中间件
3. 实现查询服务
4. 添加 API 接口
5. 实现数据清理任务
6. 前端展示页面（可选）
7. 性能测试和优化
