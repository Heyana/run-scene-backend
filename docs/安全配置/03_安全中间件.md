# 安全中间件 (P1)

## 🎯 目标

基于 art-manager 实践，创建生产级安全中间件，提供 IP 封禁、速率限制等自动化防护。

## 🏗️ 架构设计

### 中间件组件

```go
// middleware/security.go
type SecurityMiddleware struct {
    config     *config.SecurityConfig
    rateLimiter map[string]*rate.Limiter
    blockedIPs  sync.Map
    ipStats     sync.Map
}

func NewSecurityMiddleware(cfg *config.SecurityConfig) *SecurityMiddleware
func (sm *SecurityMiddleware) RateLimitMiddleware() gin.HandlerFunc
func (sm *SecurityMiddleware) IPBanMiddleware() gin.HandlerFunc
func (sm *SecurityMiddleware) SlowAttackDetector() gin.HandlerFunc
```

### IP 统计结构

```go
type IPStats struct {
    RequestCount    int64
    LastRequestTime time.Time
    SuspiciousCount int
    FirstSeen       time.Time
}

type BlockedIP struct {
    IP        string
    BlockedAt time.Time
    Duration  time.Duration
    Reason    string
}
```

## 📁 文件结构

```
middleware/
├── security.go         # 安全中间件主文件
├── rate_limiter.go     # 速率限制器
├── ip_ban.go          # IP封禁管理
└── security_test.go   # 单元测试

utils/
└── ip_utils.go        # IP工具函数
```

## 🔧 实现计划

### Step 1: 速率限制中间件

```go
func (sm *SecurityMiddleware) RateLimitMiddleware() gin.HandlerFunc {
    return gin.HandlerFunc(func(c *gin.Context) {
        clientIP := c.ClientIP()
        limiter := sm.getLimiter(clientIP)

        if !limiter.Allow() {
            sm.recordSuspiciousActivity(clientIP, "rate_limit_exceeded")
            c.JSON(429, gin.H{"error": "请求过于频繁"})
            c.Abort()
            return
        }

        c.Next()
    })
}
```

### Step 2: IP 封禁中间件

```go
func (sm *SecurityMiddleware) IPBanMiddleware() gin.HandlerFunc {
    return gin.HandlerFunc(func(c *gin.Context) {
        clientIP := c.ClientIP()

        if sm.isIPBlocked(clientIP) {
            c.JSON(403, gin.H{"error": "IP已被封禁"})
            c.Abort()
            return
        }

        c.Next()
    })
}
```

### Step 3: 自动封禁逻辑

```go
func (sm *SecurityMiddleware) recordSuspiciousActivity(ip, reason string) {
    stats := sm.getIPStats(ip)
    stats.SuspiciousCount++

    if stats.SuspiciousCount >= sm.config.AutoBlockThreshold {
        sm.blockIP(ip, sm.config.AutoBlockDuration, "auto_block")
    }
}
```

### Step 4: 清理机制

```go
func (sm *SecurityMiddleware) StartCleanupRoutine() {
    ticker := time.NewTicker(time.Hour)
    go func() {
        for range ticker.C {
            sm.cleanupExpiredBlocks()
            sm.cleanupOldStats()
        }
    }()
}
```

## 🔗 集成方式

### 在 main.go 中注册

```go
func main() {
    router := gin.Default()

    // 创建安全中间件
    securityMW := middleware.NewSecurityMiddleware(config.AppConfig.Security)

    // 注册中间件 (顺序很重要)
    router.Use(securityMW.IPBanMiddleware())      // 最先检查
    router.Use(securityMW.RateLimitMiddleware())  // 然后限流
    router.Use(securityMW.SlowAttackDetector())   // 最后检测慢攻击

    // 启动清理协程
    securityMW.StartCleanupRoutine()

    // 注册路由...
}
```

### 环境变量配置

```env
# 自动封禁配置
SECURITY_AUTO_BLOCK_THRESHOLD=50
SECURITY_AUTO_BLOCK_DURATION=86400
SECURITY_QUICK_BAN_THRESHOLD=1000
SECURITY_QUICK_BAN_DURATION=600

# 连接限制
SECURITY_MAX_CONNECTIONS_PER_IP=100
SECURITY_CONNECTION_RATE_LIMIT=300
```

## 🧪 功能特性

### 1. 分层防护

- **L1**: IP 黑名单 (毫秒级响应)
- **L2**: 速率限制 (令牌桶算法)
- **L3**: 行为分析 (可疑活动累计)

### 2. 自适应封禁

- 短期封禁: 10 分钟 (轻微违规)
- 中期封禁: 24 小时 (重复违规)
- 长期封禁: 7 天 (严重威胁)

### 3. 内存优化

- LRU 淘汰机制
- 定期清理过期数据
- IP 统计信息压缩

## 📊 监控指标

### 关键指标

- 当前封禁 IP 数量
- 每分钟触发限流次数
- 自动封禁触发次数
- 内存使用情况

### 日志格式

```go
logger.Warnf("IP封禁 - IP:%s, 原因:%s, 时长:%v", ip, reason, duration)
logger.Infof("速率限制 - IP:%s, QPS:%d, 限制:%d", ip, current, limit)
```

## ✅ 验收标准

- [ ] 速率限制准确性 >99%
- [ ] IP 封禁响应时间 <1ms
- [ ] 内存使用增长 <10MB/天
- [ ] 误封率 <0.1%
- [ ] 高并发稳定性测试通过

## 🚀 下一步

完成后续步骤: [权限系统模板](./04_权限系统模板.md)
