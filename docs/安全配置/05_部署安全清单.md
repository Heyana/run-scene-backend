# 部署安全清单 (P1)

## 🎯 目标

基于 art-manager 生产经验，提供 Go Web 应用部署前安全检查清单。

## 🔒 生产环境配置

### 环境变量安全

```bash
# ✅ 必须配置
APP_ENV=production
LOG_LEVEL=warn

# ✅ 安全配置
SECURITY_RATE_LIMIT=100
SECURITY_MAX_UPLOAD_SIZE=52428800
SECURITY_AUTO_BLOCK_THRESHOLD=50
SECURITY_LOGIN_LOCK_DURATION=1800

# ✅ 数据库安全
DB_PATH=/var/lib/app/data/app.db  # 非web目录
PRODUCT_DB_PATH=/var/lib/app/data/product.db

# ✅ 资源路径安全
RESOURCE_PATH=/var/lib/app/static/cdn  # 专用目录
CDN_BASE_PATH=https://cdn.yourdomain.com/  # 使用HTTPS
```

### 系统服务配置

```ini
# /etc/systemd/system/yourapp.service
[Unit]
Description=YourApp Service
After=network.target

[Service]
Type=simple
User=appuser  # ✅ 非root用户
Group=appgroup
WorkingDirectory=/opt/yourapp

# ✅ 从环境文件加载
EnvironmentFile=/opt/yourapp/.env

# ✅ 安全限制
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
NoNewPrivileges=true
ReadWritePaths=/var/lib/app

ExecStart=/opt/yourapp/yourapp
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

## 🛡️ Nginx 反向代理

### 基础配置

```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    # ✅ SSL配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    # ✅ 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # ✅ 请求大小限制
    client_max_body_size 100M;

    # ✅ 速率限制
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    location /api/ {
        limit_req zone=api burst=20 nodelay;

        proxy_pass http://127.0.0.1:23347;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ✅ 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ✅ 静态文件缓存
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

## 🔍 安全检查清单

### 部署前检查 (Pre-deployment)

#### 🔐 认证和授权

- [ ] 默认管理员账号已删除或更改密码
- [ ] JWT 密钥使用强随机生成 (>256 位)
- [ ] 会话超时配置合理 (≤8 小时)
- [ ] 启用双因子认证 (如适用)

#### 📁 文件和权限

- [ ] 应用以非 root 用户运行
- [ ] 数据库文件权限正确 (600)
- [ ] 上传目录在 webroot 外
- [ ] 临时文件定期清理
- [ ] 日志文件大小限制

#### 🌐 网络安全

- [ ] 禁用不必要的端口
- [ ] 启用防火墙规则
- [ ] 配置 SSL/TLS 证书
- [ ] 设置安全 HTTP 头
- [ ] IP 白名单 (如适用)

#### 🛡️ 应用安全

- [ ] 速率限制已启用
- [ ] 文件上传验证完整
- [ ] SQL 注入防护
- [ ] XSS 防护
- [ ] CSRF 保护

### 运行时监控 (Runtime)

#### 📊 性能监控

```bash
# CPU和内存使用
top -p $(pgrep yourapp)

# 网络连接数
ss -tuln | grep :23347

# 磁盘空间
df -h /var/lib/app
```

#### 🚨 安全事件监控

```bash
# 检查封禁IP数量
grep "IP封禁" /var/log/yourapp/app.log | tail -10

# 监控登录失败
grep "登录失败" /var/log/yourapp/app.log | wc -l

# 检查异常请求
grep "429\|403" /var/log/nginx/access.log | tail -10
```

#### 📈 关键指标阈值

| 指标       | 正常范围 | 警告阈值 | 告警阈值 |
| ---------- | -------- | -------- | -------- |
| CPU 使用率 | <50%     | >70%     | >90%     |
| 内存使用   | <70%     | >80%     | >95%     |
| 磁盘使用   | <80%     | >90%     | >95%     |
| 封禁 IP 数 | <100     | >500     | >1000    |
| 4xx 错误率 | <1%      | >5%      | >10%     |

## 🔄 定期维护

### 日常任务 (Daily)

```bash
#!/bin/bash
# daily_security_check.sh

# 清理过期日志
find /var/log/yourapp -name "*.log" -mtime +7 -delete

# 检查磁盘空间
disk_usage=$(df /var/lib/app | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $disk_usage -gt 90 ]; then
    echo "警告: 磁盘使用率 ${disk_usage}%" | mail -s "磁盘空间告警" admin@yourdomain.com
fi

# 检查异常IP
suspicious_ips=$(grep "自动封禁" /var/log/yourapp/app.log | grep "$(date +%Y-%m-%d)" | wc -l)
if [ $suspicious_ips -gt 50 ]; then
    echo "检测到异常IP活动: ${suspicious_ips}次封禁" | mail -s "安全告警" admin@yourdomain.com
fi
```

### 周期任务 (Weekly)

- [ ] 更新系统安全补丁
- [ ] 审查访问日志
- [ ] 检查 SSL 证书有效期
- [ ] 备份验证
- [ ] 性能基线更新

### 月度任务 (Monthly)

- [ ] 安全配置审计
- [ ] 用户权限清理
- [ ] 密码策略检查
- [ ] 依赖库安全更新
- [ ] 灾难恢复演练

## 🚨 应急响应

### 安全事件处理

```bash
# 紧急封禁IP
curl -X POST http://localhost:23347/admin/block-ip \
     -H "Authorization: Bearer $ADMIN_TOKEN" \
     -d '{"ip":"攻击者IP","duration":3600,"reason":"security_incident"}'

# 临时提高安全级别
export SECURITY_RATE_LIMIT=10
export SECURITY_AUTO_BLOCK_THRESHOLD=5
systemctl restart yourapp

# 导出安全事件日志
grep -E "(封禁|攻击|异常)" /var/log/yourapp/app.log > security_incident_$(date +%Y%m%d).log
```

### 常见威胁响应

| 威胁类型     | 检测方法       | 响应措施               |
| ------------ | -------------- | ---------------------- |
| DDoS 攻击    | QPS 异常       | 提升限流阈值，CDN 防护 |
| 暴力破解     | 登录失败激增   | 降低封禁阈值，延长锁定 |
| 文件上传攻击 | 异常文件类型   | 加强文件验证，隔离处理 |
| SQL 注入     | 异常数据库查询 | 封禁 IP，检查注入点    |

## ✅ 部署验证

### 自动化检查脚本

```bash
#!/bin/bash
# deployment_verification.sh

echo "🔍 开始部署安全验证..."

# 检查服务状态
systemctl is-active --quiet yourapp && echo "✅ 服务运行正常" || echo "❌ 服务异常"

# 检查端口监听
ss -tuln | grep -q ":23347" && echo "✅ 端口监听正常" || echo "❌ 端口未监听"

# 检查安全配置
curl -s http://localhost:23347/health | grep -q "ok" && echo "✅ 健康检查通过" || echo "❌ 健康检查失败"

# 验证速率限制
for i in {1..20}; do
    curl -s http://localhost:23347/api/test >/dev/null
done
curl -s http://localhost:23347/api/test | grep -q "429" && echo "✅ 速率限制生效" || echo "❌ 速率限制无效"

echo "🎉 部署验证完成"
```

## 📚 相关文档

- [核心安全配置](./02_核心安全配置.md) - 配置详情
- [安全中间件](./03_安全中间件.md) - 中间件实现
- [权限系统](./04_权限系统模板.md) - 权限管理

## 🔄 持续改进

定期回顾和更新安全策略，关注最新威胁情报，调整防护措施。
