# 宝塔 + Debian 蓝绿部署执行计划

## 环境信息

- 系统: Debian
- 面板: 宝塔
- 当前服务端口: 23347
- 蓝环境端口: 8001
- 绿环境端口: 8002

---

## 第一阶段：准备工作（一次性）

### 1.1 创建目录结构

```bash
# SSH登录服务器执行
mkdir -p /root/project/online_show_blue
mkdir -p /root/project/online_show_green
mkdir -p /root/project/shared
```

### 1.2 迁移现有服务

```bash
# 假设当前服务在 /root/project/online_show
cd /root/project

# 复制到蓝环境
cp -r online_show/* online_show_blue/

# 创建共享数据目录软链接（数据库共享）
ln -sf /root/project/shared/data online_show_blue/data
ln -sf /root/project/shared/data online_show_green/data

# 移动数据到共享目录
mv online_show/data /root/project/shared/
```

### 1.3 宝塔安装 Nginx（如未安装）

1. 登录宝塔面板
2. 软件商店 → 搜索 `Nginx` → 安装

---

## 第二阶段：配置 Nginx 反向代理

### 2.1 宝塔添加网站

1. 网站 → 添加站点
2. 域名: 你的域名或 IP
3. PHP 版本: 纯静态
4. 创建后点击 **设置**

### 2.2 配置反向代理

**方式 A：宝塔面板操作**

1. 网站设置 → 反向代理 → 添加反向代理
2. 名称: `online_show`
3. 目标 URL: `http://127.0.0.1:8001`
4. 开启代理

**方式 B：手动编辑配置（推荐，更灵活）**

1. 网站设置 → 配置文件
2. 在 `server` 块内添加:

```nginx
# 上游服务器（蓝绿切换核心）
upstream online_show_backend {
    server 127.0.0.1:8001;  # 蓝 (当前活跃)
    # server 127.0.0.1:8002;  # 绿 (备用)
}

location / {
    proxy_pass http://online_show_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

3. 保存

### 2.3 测试配置

```bash
# 检查配置语法
nginx -t

# 重载配置
nginx -s reload
```

---

## 第三阶段：创建 Systemd 服务

### 3.1 蓝环境服务

```bash
cat > /etc/systemd/system/online_show_blue.service << 'EOF'
[Unit]
Description=Online Show Blue
After=network.target

[Service]
Type=simple
WorkingDirectory=/root/project/online_show_blue
ExecStart=/root/project/online_show_blue/online_show --port 8001
Restart=on-failure
RestartSec=5
TimeoutStopSec=35
KillMode=mixed

[Install]
WantedBy=multi-user.target
EOF
```

### 3.2 绿环境服务

```bash
cat > /etc/systemd/system/online_show_green.service << 'EOF'
[Unit]
Description=Online Show Green
After=network.target

[Service]
Type=simple
WorkingDirectory=/root/project/online_show_green
ExecStart=/root/project/online_show_green/online_show --port 8002
Restart=on-failure
RestartSec=5
TimeoutStopSec=35
KillMode=mixed

[Install]
WantedBy=multi-user.target
EOF
```

### 3.3 启用服务

```bash
systemctl daemon-reload
systemctl enable online_show_blue
systemctl start online_show_blue

# 绿环境暂不启动
systemctl enable online_show_green
```

### 3.4 停止旧服务（如有）

```bash
systemctl stop online_show
systemctl disable online_show
```

---

## 第四阶段：部署脚本

### 4.1 创建部署脚本

```bash
cat > /root/project/deploy.sh << 'EOF'
#!/bin/bash
set -e

# 配置
NGINX_CONF="/www/server/panel/vhost/nginx/你的站点.conf"  # 修改为实际路径
BLUE_DIR="/root/project/online_show_blue"
GREEN_DIR="/root/project/online_show_green"
NEW_BINARY="$1"

# 颜色
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 检测当前活跃环境
if grep -q "^[^#]*server 127.0.0.1:8001;" "$NGINX_CONF"; then
    ACTIVE="blue"
    CURRENT_PORT=8001
    TARGET="green"
    TARGET_PORT=8002
    TARGET_DIR="$GREEN_DIR"
    TARGET_SERVICE="online_show_green"
    CURRENT_SERVICE="online_show_blue"
else
    ACTIVE="green"
    CURRENT_PORT=8002
    TARGET="blue"
    TARGET_PORT=8001
    TARGET_DIR="$BLUE_DIR"
    TARGET_SERVICE="online_show_blue"
    CURRENT_SERVICE="online_show_green"
fi

echo -e "${GREEN}当前活跃: $ACTIVE (:$CURRENT_PORT)${NC}"
echo -e "${YELLOW}部署目标: $TARGET (:$TARGET_PORT)${NC}"

# 1. 部署新版本
if [ -n "$NEW_BINARY" ] && [ -f "$NEW_BINARY" ]; then
    echo "复制新版本..."
    cp "$NEW_BINARY" "$TARGET_DIR/online_show"
    chmod +x "$TARGET_DIR/online_show"
fi

# 2. 启动新版本
echo "启动新版本..."
systemctl restart $TARGET_SERVICE
sleep 3

# 3. 健康检查
for i in {1..30}; do
    if curl -s "http://127.0.0.1:$TARGET_PORT/health" | grep -q "ok"; then
        echo -e "${GREEN}✓ 健康检查通过${NC}"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "健康检查失败！"
        systemctl stop $TARGET_SERVICE
        exit 1
    fi
    echo "等待启动... ($i/30)"
    sleep 1
done

# 4. 切换 Nginx
echo "切换流量..."
sed -i "s/server 127.0.0.1:$CURRENT_PORT;/# server 127.0.0.1:$CURRENT_PORT;/" "$NGINX_CONF"
sed -i "s/# server 127.0.0.1:$TARGET_PORT;/server 127.0.0.1:$TARGET_PORT;/" "$NGINX_CONF"
nginx -s reload

# 5. 停止旧版本
echo "停止旧版本..."
sleep 5
systemctl stop $CURRENT_SERVICE

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  部署完成！当前活跃: $TARGET (:$TARGET_PORT)${NC}"
echo -e "${GREEN}========================================${NC}"
EOF

chmod +x /root/project/deploy.sh
```

### 4.2 创建回滚脚本

```bash
cat > /root/project/rollback.sh << 'EOF'
#!/bin/bash
set -e

NGINX_CONF="/www/server/panel/vhost/nginx/你的站点.conf"

# 检测并切换
if grep -q "^[^#]*server 127.0.0.1:8001;" "$NGINX_CONF"; then
    FROM=8001; TO=8002
    FROM_SVC="online_show_blue"; TO_SVC="online_show_green"
else
    FROM=8002; TO=8001
    FROM_SVC="online_show_green"; TO_SVC="online_show_blue"
fi

echo "回滚: :$FROM -> :$TO"

# 启动目标
systemctl start $TO_SVC
sleep 3

# 健康检查
curl -s "http://127.0.0.1:$TO/health" | grep -q "ok" || { echo "目标不健康！"; exit 1; }

# 切换
sed -i "s/server 127.0.0.1:$FROM;/# server 127.0.0.1:$FROM;/" "$NGINX_CONF"
sed -i "s/# server 127.0.0.1:$TO;/server 127.0.0.1:$TO;/" "$NGINX_CONF"
nginx -s reload

echo "✓ 已回滚到 :$TO"
EOF

chmod +x /root/project/rollback.sh
```

---

## 第五阶段：日常部署流程

### 方式 A：使用脚本部署

```bash
# 上传新版本到 /root/project/new_online_show
# 然后执行
/root/project/deploy.sh /root/project/new_online_show
```

### 方式 B：配合现有打包脚本

修改 `build-on-linux.sh` 最后部分，调用蓝绿部署脚本：

```bash
# 替换原来的 systemctl stop/start 逻辑
/root/project/deploy.sh "$RELEASE_DIR/online_show/online_show"
```

---

## 检查清单

| 步骤       | 命令                                 | 预期结果           |
| ---------- | ------------------------------------ | ------------------ |
| Nginx 状态 | `systemctl status nginx`             | active             |
| 蓝服务状态 | `systemctl status online_show_blue`  | active 或 inactive |
| 绿服务状态 | `systemctl status online_show_green` | active 或 inactive |
| 蓝健康检查 | `curl http://127.0.0.1:8001/health`  | ok                 |
| 绿健康检查 | `curl http://127.0.0.1:8002/health`  | ok                 |
| 外部访问   | `curl http://你的域名/health`        | ok                 |

---

## 宝塔特殊说明

1. **Nginx 配置路径**: `/www/server/panel/vhost/nginx/站点名.conf`
2. **重载 Nginx**: 宝塔面板或 `nginx -s reload`
3. **防火墙**: 8001/8002 端口无需开放（仅本地访问）
4. **SSL**: 在宝塔面板配置即可，不影响后端

---

## 相关文档

- [概述](./01_概述.md)
- [Nginx 配置](./02_Nginx配置.md)
- [回滚流程](./04_回滚流程.md)
