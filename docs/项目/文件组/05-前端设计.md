# 文件组功能 - 前端设计

## 页面结构

```
/document-groups          文件组列表页（树形+卡片）
/document-groups/:id      文件组详情页
```

## 组件复用

### 1. 列表页 - 树形 + 卡片混合视图

```tsx
// 左侧：树形导航
<Tree
  treeData={groupTree}
  onSelect={handleSelectGroup}
  draggable
  onDrop={handleMoveGroup}
/>

// 右侧：当前组的子组和文件
<ResourceGrid
  items={currentGroup.children}
  onCardClick={handleViewGroup}
/>

<ResourceGrid
  items={currentGroup.files}
  onCardClick={handlePreview}
/>
```

### 2. 详情页 - 文件列表（支持拖拽）

```tsx
<DragDropContext onDragEnd={handleDragEnd}>
  <Droppable droppableId="files">
    {items.map((item, index) => (
      <Draggable key={item.id} draggableId={item.id} index={index}>
        <FileItem
          document={item.document}
          isPrimary={item.is_primary}
          onRemove={() => handleRemove(item.id)}
          onSetPrimary={() => handleSetPrimary(item.id)}
        />
      </Draggable>
    ))}
  </Droppable>
</DragDropContext>
```

## 核心功能

### 1. 创建文件组（支持创建子组）

```tsx
const handleCreate = async (values) => {
  await createDocumentGroup({
    ...values,
    parent_id: currentGroupId, // 当前选中的组作为父组
  });
  message.success("创建成功");
  refresh();
};
```

### 2. 树形导航

```tsx
const [groupTree, setGroupTree] = useState([]);

useEffect(() => {
  const loadTree = async () => {
    const tree = await getDocumentGroupTree();
    setGroupTree(tree);
  };
  loadTree();
}, []);

// 树节点渲染
const renderTreeNode = (node) => ({
  title: (
    <span>
      {node.name}
      <Badge count={node.file_count} />
    </span>
  ),
  key: node.id,
  children: node.children?.map(renderTreeNode),
});
```

### 3. 拖拽移动组

```tsx
const handleMoveGroup = async (info) => {
  const dragId = info.dragNode.key;
  const dropId = info.node.key;

  await moveDocumentGroup(dragId, dropId);
  message.success("移动成功");
  refreshTree();
};
```

### 4. 面包屑导航

```tsx
const [breadcrumb, setBreadcrumb] = useState([]);

// 根据 path 生成面包屑
const buildBreadcrumb = (group) => {
  const ids = group.path.split("/").filter(Boolean);
  // 查询每个 ID 的组信息
  const crumbs = await Promise.all(ids.map((id) => getDocumentGroupDetail(id)));
  setBreadcrumb(crumbs);
};
```

### 5. 批量下载（包含子组）

```tsx
const handleDownload = (includeChildren = false) => {
  const url = `/api/document-groups/${groupId}/download?include_children=${includeChildren}`;
  window.open(url);
};

// UI
<Dropdown
  menu={{
    items: [
      { key: "1", label: "仅下载当前组", onClick: () => handleDownload(false) },
      { key: "2", label: "包含所有子组", onClick: () => handleDownload(true) },
    ],
  }}
>
  <Button>下载</Button>
</Dropdown>;
```

### 6. 级联删除

```tsx
const handleDelete = (groupId, hasChildren) => {
  if (hasChildren) {
    Modal.confirm({
      title: "删除确认",
      content: "该组包含子组，是否级联删除？",
      okText: "级联删除",
      cancelText: "仅删除当前组",
      onOk: () => deleteDocumentGroup(groupId, true),
      onCancel: () => deleteDocumentGroup(groupId, false),
    });
  } else {
    deleteDocumentGroup(groupId, false);
  }
};
```

## API 调用

```typescript
// api/documentGroups.ts
import http from "./http";

export function getDocumentGroups(params) {
  return http.get("/api/document-groups", { params });
}

export function getDocumentGroupTree(rootId?: number) {
  return http.get("/api/document-groups/tree", {
    params: { root_id: rootId },
  });
}

export function getDocumentGroupDetail(id: number, withChildren = false) {
  return http.get(`/api/document-groups/${id}`, {
    params: { with_children: withChildren },
  });
}

export function createDocumentGroup(data) {
  return http.post("/api/document-groups", data);
}

export function updateDocumentGroup(id: number, data) {
  return http.put(`/api/document-groups/${id}`, data);
}

export function deleteDocumentGroup(id: number, cascade = false) {
  return http.delete(`/api/document-groups/${id}`, {
    params: { cascade },
  });
}

export function moveDocumentGroup(id: number, parentId: number | null) {
  return http.put(`/api/document-groups/${id}/move`, { parent_id: parentId });
}

export function addDocumentToGroup(
  groupId: number,
  documentIds: number[],
  note?: string,
) {
  return http.post(`/api/document-groups/${groupId}/items`, {
    document_ids: documentIds,
    note,
  });
}

export function removeDocumentFromGroup(groupId: number, documentId: number) {
  return http.delete(`/api/document-groups/${groupId}/items/${documentId}`);
}

export function sortGroupItems(groupId: number, items) {
  return http.put(`/api/document-groups/${groupId}/items/sort`, { items });
}

export function setPrimaryDocument(groupId: number, itemId: number) {
  return http.put(`/api/document-groups/${groupId}/items/${itemId}/primary`);
}
```

## 交互细节

### 1. 列表页（树形+卡片混合）

**布局**：

- 左侧：树形导航（30%宽度）
- 右侧：内容区域（70%宽度）
  - 面包屑导航
  - 子组卡片列表
  - 文件卡片列表

**树形导航**：

- 显示所有组的层级结构
- 支持拖拽移动组
- 显示文件数量徽章
- 右键菜单：新建子组、重命名、删除

**卡片显示**：

- 子组卡片：文件夹图标、名称、文件数、子组数
- 文件卡片：缩略图、名称、大小、类型

### 2. 详情页

**顶部**：

- 面包屑导航（可点击跳转）
- 组信息（名称、描述、统计）
- 操作栏：添加文件、创建子组、批量下载、编辑、删除

**子组列表**：

- 卡片展示
- 点击进入子组

**文件列表**：

- 支持拖拽排序
- 文件项：主文件标记、预览、下载、移除
- 批量操作：批量移除、批量下载

### 3. 创建/编辑对话框

```tsx
<Modal title={parentId ? "创建子组" : "创建文件组"}>
  <Form>
    <Form.Item label="名称" name="name" required />
    <Form.Item label="描述" name="description" />
    <Form.Item label="分类" name="category" />
    {parentId && <Alert message={`将创建在「${parentName}」下`} type="info" />}
  </Form>
</Modal>
```

### 4. 拖拽交互

**拖拽组**：

- 在树形导航中拖拽
- 拖拽时显示目标位置
- 松开后移动组

**拖拽文件**：

- 在文件列表中拖拽
- 拖拽时显示占位符
- 松开后自动保存顺序

### 5. 下载交互

**单组下载**：

- 点击下载按钮
- 选择是否包含子组
- 下载 ZIP 文件

**ZIP 结构**：

```
项目交付.zip
├── 设计稿/
│   ├── UI设计.psd
│   └── 切图.zip
├── 开发文档/
│   ├── 需求文档.docx
│   └── API文档.pdf
└── 测试报告/
    ├── 测试用例.xlsx
    └── Bug报告.pdf
```

## 状态管理

```tsx
// 使用 Context 或 Redux 管理全局状态
interface DocumentGroupState {
  tree: DocumentGroup[]; // 树形结构
  currentGroup: DocumentGroup; // 当前组
  breadcrumb: DocumentGroup[]; // 面包屑
  selectedFiles: number[]; // 选中的文件
}
```

## 性能优化

1. **虚拟滚动** - 文件列表使用虚拟滚动
2. **懒加载** - 树节点按需加载子节点
3. **缓存** - 缓存已加载的组数据
4. **防抖** - 搜索、拖拽等操作防抖处理
