# 文件处理器使用示例

## API 使用示例

### 1. 获取支持的文件格式

```bash
curl http://localhost:23347/api/fileprocessor/formats
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "video": [
      "mp4",
      "avi",
      "mov",
      "webm",
      "mkv",
      "flv",
      "wmv",
      "m4v",
      "mpg",
      "mpeg"
    ],
    "image": [
      "jpg",
      "jpeg",
      "png",
      "gif",
      "webp",
      "bmp",
      "tiff",
      "tif",
      "svg",
      "ico"
    ],
    "document": [
      "pdf",
      "doc",
      "docx",
      "ppt",
      "pptx",
      "xls",
      "xlsx",
      "txt",
      "md"
    ]
  }
}
```

### 2. 提取文件元数据

#### 提取视频元数据

```bash
curl -X POST http://localhost:23347/api/fileprocessor/metadata \
  -H "Content-Type: application/json" \
  -d '{
    "file_path": "/path/to/video.mp4",
    "format": "mp4"
  }'
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "file_name": "video.mp4",
    "format": ".mp4",
    "width": 1920,
    "height": 1080,
    "duration": 120,
    "bitrate": 5000000,
    "codec": "h264",
    "frame_rate": 30.0,
    "file_size": 75000000,
    "extra": {
      "audio_codec": "aac",
      "audio_bitrate": 128000
    }
  }
}
```

#### 提取图片元数据

```bash
curl -X POST http://localhost:23347/api/fileprocessor/metadata \
  -H "Content-Type: application/json" \
  -d '{
    "file_path": "/path/to/image.jpg",
    "format": "jpg"
  }'
```

### 3. 生成缩略图

```bash
curl -X POST http://localhost:23347/api/fileprocessor/thumbnail \
  -H "Content-Type: application/json" \
  -d '{
    "file_path": "/path/to/image.jpg",
    "format": "jpg",
    "output_path": "/path/to/thumbnail.jpg",
    "size": 200,
    "quality": 85
  }'
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "thumbnail_path": "/path/to/thumbnail.jpg"
  }
}
```

### 4. 创建异步任务

#### 创建视频预览任务

```bash
curl -X POST http://localhost:23347/api/fileprocessor/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "type": "video_preview",
    "input_file": "/path/to/video.mp4",
    "output_file": "/path/to/preview.jpg",
    "priority": 5,
    "max_retries": 3
  }'
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "type": "video_preview",
    "status": "pending",
    "priority": 5,
    "input_file": "/path/to/video.mp4",
    "output_file": "/path/to/preview.jpg",
    "progress": 0,
    "message": "",
    "created_at": "2026-02-10T10:00:00Z"
  }
}
```

### 5. 查询任务状态

```bash
curl http://localhost:23347/api/fileprocessor/tasks/1
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "type": "video_preview",
    "status": "running",
    "priority": 5,
    "input_file": "/path/to/video.mp4",
    "output_file": "/path/to/preview.jpg",
    "progress": 50.5,
    "message": "生成视频预览图...",
    "started_at": "2026-02-10T10:00:05Z"
  }
}
```

### 6. 列出任务

```bash
# 列出所有任务
curl http://localhost:23347/api/fileprocessor/tasks

# 按状态过滤
curl http://localhost:23347/api/fileprocessor/tasks?status=running

# 按类型过滤
curl http://localhost:23347/api/fileprocessor/tasks?type=video_preview

# 分页
curl http://localhost:23347/api/fileprocessor/tasks?page=1&page_size=10
```

### 7. 取消任务

```bash
curl -X POST http://localhost:23347/api/fileprocessor/tasks/1/cancel
```

### 8. 重试失败任务

```bash
curl -X POST http://localhost:23347/api/fileprocessor/tasks/1/retry
```

## Go 代码使用示例

### 同步使用（简单场景）

```go
package main

import (
    "fmt"
    "go_wails_project_manager/services/fileprocessor"
)

func main() {
    // 创建配置
    config := fileprocessor.DefaultConfig()

    // 创建服务
    service := fileprocessor.NewFileProcessorService(config)

    // 提取视频元数据
    metadata, err := service.ExtractMetadata("/path/to/video.mp4", "mp4")
    if err != nil {
        panic(err)
    }

    fmt.Printf("分辨率: %dx%d\n", metadata.Width, metadata.Height)
    fmt.Printf("时长: %d秒\n", metadata.Duration)
    fmt.Printf("编码: %s\n", metadata.Codec)

    // 生成缩略图
    options := fileprocessor.ThumbnailOptions{
        Size:       200,
        Quality:    85,
        OutputPath: "/path/to/thumbnail.jpg",
    }

    thumbnailPath, err := service.GenerateThumbnail("/path/to/image.jpg", "jpg", options)
    if err != nil {
        panic(err)
    }

    fmt.Printf("缩略图: %s\n", thumbnailPath)
}
```

### 异步使用（长时间任务）

```go
package main

import (
    "fmt"
    "go_wails_project_manager/models"
    "go_wails_project_manager/services/task"
    "gorm.io/gorm"
)

func main() {
    // 假设已有数据库连接
    var db *gorm.DB

    // 创建任务服务
    taskService := task.NewTaskService(db)

    // 创建视频转换任务
    task := &models.Task{
        Type:       models.TaskTypeVideoConvert,
        InputFile:  "/path/to/input.mp4",
        OutputFile: "/path/to/output.webm",
        Priority:   5,
        MaxRetries: 3,
        Options:    `{"codec":"libvpx-vp9","quality":30}`,
    }

    // 提交任务
    if err := taskService.CreateTask(task); err != nil {
        panic(err)
    }

    fmt.Printf("任务已创建: ID=%d\n", task.ID)

    // 查询任务进度
    progress, message, err := taskService.GetTaskProgress(task.ID)
    if err != nil {
        panic(err)
    }

    fmt.Printf("进度: %.2f%%, 消息: %s\n", progress, message)
}
```

## 任务类型说明

### 视频任务

- `video_preview` - 生成视频预览图（多个时间点）
- `video_thumbnail` - 生成视频缩略图（单帧）
- `video_convert` - 视频格式转换

### 图片任务

- `image_thumbnail` - 生成图片缩略图
- `image_convert` - 图片格式转换

### 文档任务

- `document_preview` - 生成文档预览图（PDF等）

## 任务状态说明

- `pending` - 等待中
- `running` - 运行中
- `completed` - 已完成
- `failed` - 失败
- `cancelled` - 已取消
- `retrying` - 重试中

## 配置说明

配置文件位于 `configs/fileprocessor.yaml`：

```yaml
fileprocessor:
  # FFmpeg配置
  ffmpeg:
    bin_path: "ffmpeg" # FFmpeg可执行文件路径
    timeout: 300 # 超时时间（秒）

  # ImageMagick配置
  imagemagick:
    bin_path: "convert" # ImageMagick可执行文件路径
    timeout: 60 # 超时时间（秒）

  # PDF工具配置
  pdf:
    bin_path: "pdftoppm" # PDF工具可执行文件路径
    timeout: 120 # 超时时间（秒）

  # 任务配置
  task:
    max_concurrent: 5 # 最大并发任务数
    max_retries: 3 # 最大重试次数
    retry_delay: 60 # 重试延迟（秒）
    cleanup_after: 86400 # 清理时间（秒，24小时）

  # 资源限制
  resource:
    max_memory_per_task: 2147483648 # 单个任务最大内存（2GB）
    max_cpu_percent: 80.0 # 最大CPU使用率
    max_temp_size: 10737418240 # 最大临时文件大小（10GB）
```

## 依赖安装

### Ubuntu/Debian

```bash
sudo apt-get update
sudo apt-get install ffmpeg imagemagick poppler-utils
```

### macOS

```bash
brew install ffmpeg imagemagick poppler
```

### Windows

1. 下载并安装 [FFmpeg](https://ffmpeg.org/download.html)
2. 下载并安装 [ImageMagick](https://imagemagick.org/script/download.php)
3. 下载并安装 [Poppler](http://blog.alivate.com.au/poppler-windows/)

确保将这些工具添加到系统 PATH 环境变量中。

## 注意事项

1. **文件路径**: 确保文件路径正确且有读写权限
2. **工具安装**: 确保 FFmpeg、ImageMagick 等工具已正确安装
3. **资源限制**: 注意配置合理的并发数和资源限制
4. **错误处理**: 任务失败会自动重试，可通过 `max_retries` 配置
5. **临时文件**: 系统会自动清理过期的临时文件
