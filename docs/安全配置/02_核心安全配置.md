# 核心安全配置 (P0)

## 🎯 目标

扩展现有 `config.go` 添加通用安全配置，提供生产级安全防护基础。

## 🏗️ 架构设计

### SecurityConfig 结构扩展

```go
type SecurityConfig struct {
    // 速率限制
    RateLimitPerSecond int
    RateLimitBurst     int

    // 文件上传
    MaxUploadSize      int64
    MaxRequestBodySize int64

    // 登录安全
    MaxLoginAttempts   int
    LoginLockDuration  int64
    SessionTimeout     int64

    // 连接限制
    MaxConnectionsPerIP int
    QuickBanThreshold   int
    QuickBanDuration    int64
}
```

### 环境变量映射

| 配置项               | 环境变量                       | 默认值 | 说明         |
| -------------------- | ------------------------------ | ------ | ------------ |
| `RateLimitPerSecond` | `SECURITY_RATE_LIMIT`          | 100    | 每秒请求限制 |
| `MaxUploadSize`      | `SECURITY_MAX_UPLOAD_SIZE`     | 50MB   | 文件上传限制 |
| `MaxLoginAttempts`   | `SECURITY_MAX_LOGIN_ATTEMPTS`  | 5      | 登录失败限制 |
| `LoginLockDuration`  | `SECURITY_LOGIN_LOCK_DURATION` | 1800   | 锁定时长(秒) |

## 📁 文件结构

```
config/
├── config.go           # 主配置 (已存在)
└── security.go         # 安全配置 (新增)

utils/
├── file_validator.go   # 文件验证器 (新增)
└── security_helper.go  # 安全工具函数 (新增)
```

## 🔧 实现计划

### Step 1: 创建 config/security.go

```go
type SecurityConfig struct {
    // 核心配置项...
}

func NewSecurityConfig() *SecurityConfig
func (s *SecurityConfig) LoadFromEnv()
func (s *SecurityConfig) Validate() error
```

### Step 2: 创建 utils/file_validator.go

```go
type FileValidator struct {
    maxSize      int64
    allowedTypes []string
    checkMagic   bool
}

func (fv *FileValidator) ValidateFile(file *multipart.FileHeader) error
func (fv *FileValidator) CheckMagicNumber(file io.Reader, mimeType string) error
func (fv *FileValidator) SanitizeFilename(filename string) string
```

### Step 3: 更新 config.go

```go
type Config struct {
    // 现有字段...
    Security *SecurityConfig  // 新增
}

func LoadConfig() error {
    // 现有逻辑...
    AppConfig.Security = NewSecurityConfig()
    AppConfig.Security.LoadFromEnv()
}
```

### Step 4: 更新 .env 模板

```env
# 安全配置
SECURITY_RATE_LIMIT=100
SECURITY_MAX_UPLOAD_SIZE=52428800
SECURITY_MAX_LOGIN_ATTEMPTS=5
SECURITY_LOGIN_LOCK_DURATION=1800
SECURITY_SESSION_TIMEOUT=7200
```

## 🧪 使用示例

### 配置使用

```go
// 获取安全配置
secConfig := config.AppConfig.Security

// 检查上传限制
if file.Size > secConfig.MaxUploadSize {
    return errors.New("文件过大")
}

// 检查登录失败次数
if attempts >= secConfig.MaxLoginAttempts {
    return errors.New("登录次数超限")
}
```

### 文件验证

```go
validator := utils.NewFileValidator(config.AppConfig.Security)

if err := validator.ValidateFile(fileHeader); err != nil {
    return err
}
```

## ✅ 验收标准

- [ ] SecurityConfig 结构定义完整
- [ ] 所有配置项支持环境变量
- [ ] 文件验证器支持魔数检查
- [ ] 默认配置适合生产环境
- [ ] 配置验证逻辑完善
- [ ] 单元测试覆盖率 >80%

## 🚀 下一步

完成后续步骤: [安全中间件](./03_安全中间件.md)
