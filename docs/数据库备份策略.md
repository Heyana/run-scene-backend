# 企业名片后台系统数据库备份策略

## 项目概述

本文档为企业名片后台管理系统在CentOS 8环境下的数据库备份策略和实施方案。

### 系统架构
- **数据库类型**: SQLite
- **主数据库文件**: `./data/app.db`
- **框架**: Go + Wails + GORM
- **部署环境**: CentOS 8

## 备份策略

### 1. 备份内容规划

#### 1.1 核心数据文件
- **主数据库**: `./data/app.db`
- **数据库密钥**: `./data/db_key.txt`
- **CDN资源文件**: `./static/cdn/` 目录

#### 1.2 配置文件
- `config/config.go`
- `wails.json`
- 环境变量配置

#### 1.3 应用数据
- 上传的图片和文档
- 企业Logo资源
- 富文本内容

### 2. 备份频率策略

| 备份类型 | 频率 | 时间点 | 保留期限 |
|---------|------|-------|----------|
| 数据库增量备份 | 每4小时 | 02:00, 06:00, 10:00, 14:00, 18:00, 22:00 | 7天 |
| 数据库完整备份 | 每日 | 凌晨02:00 | 30天 |
| CDN资源备份 | 每日 | 凌晨03:00 | 30天 |
| 完整系统备份 | 每周 | 周日凌晨01:00 | 12周 |
| 月度归档备份 | 每月 | 月末最后一天 | 永久保存 |

### 3. 备份实施方案

#### 3.1 SQLite数据库备份方法

**方法一：文件复制备份（推荐）**
```bash
# 停止应用服务
systemctl stop crop-card-backend

# 复制数据库文件
cp ./data/app.db ./backups/daily/app_$(date +%Y%m%d_%H%M%S).db

# 重启应用服务
systemctl start crop-card-backend
```

**方法二：SQLite在线备份**
```bash
# 无需停服的在线备份
sqlite3 ./data/app.db ".backup ./backups/daily/app_backup_$(date +%Y%m%d_%H%M%S).db"
```

**方法三：SQL导出备份**
```bash
# 导出为SQL文件（便于迁移）
sqlite3 ./data/app.db ".dump" > ./backups/sql/app_dump_$(date +%Y%m%d_%H%M%S).sql
```

#### 3.2 资源文件备份方法

```bash
# 增量同步CDN资源
rsync -av --delete ./static/cdn/ ./backups/cdn/$(date +%Y%m%d)/

# 压缩归档
tar -czf ./backups/archive/cdn_$(date +%Y%m%d_%H%M%S).tar.gz ./static/cdn/
```

### 4. CentOS 8 系统配置

#### 4.1 系统工具安装

```bash
# 安装基础工具
yum update -y
yum install -y sqlite rsync tar gzip crontabs

# 安装云存储工具（阿里云OSS）
wget http://gosspublic.alicdn.com/ossutil/1.7.0/ossutil64
chmod +x ossutil64
sudo mv ossutil64 /usr/local/bin/ossutil

# 配置OSS
ossutil config
```

#### 4.2 目录结构创建

```bash
# 创建备份目录结构
mkdir -p /opt/crop-card-backups/{daily,weekly,monthly,archive,logs,scripts}
mkdir -p /opt/crop-card-backups/daily/{db,cdn,config}
mkdir -p /opt/crop-card-backups/weekly/{full-backup}
mkdir -p /opt/crop-card-backups/monthly/{archive}

# 设置权限
chown -R backup:backup /opt/crop-card-backups
chmod -R 750 /opt/crop-card-backups
```

#### 4.3 备份脚本示例

**主备份脚本** (`/opt/crop-card-backups/scripts/backup.sh`)
```bash
#!/bin/bash

# 备份配置
APP_DIR="/opt/crop-card"
BACKUP_DIR="/opt/crop-card-backups"
LOG_FILE="${BACKUP_DIR}/logs/backup_$(date +%Y%m).log"
DATE=$(date +%Y%m%d_%H%M%S)

# 日志函数
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# 数据库备份
backup_database() {
    log "开始数据库备份"
    
    # 在线备份SQLite
    sqlite3 ${APP_DIR}/data/app.db ".backup ${BACKUP_DIR}/daily/db/app_${DATE}.db"
    
    if [ $? -eq 0 ]; then
        log "数据库备份成功: app_${DATE}.db"
        
        # 计算文件哈希
        md5sum ${BACKUP_DIR}/daily/db/app_${DATE}.db > ${BACKUP_DIR}/daily/db/app_${DATE}.db.md5
        
        # 上传到云存储
        ossutil cp ${BACKUP_DIR}/daily/db/app_${DATE}.db oss://crop-card-backup/daily/db/
        ossutil cp ${BACKUP_DIR}/daily/db/app_${DATE}.db.md5 oss://crop-card-backup/daily/db/
        
    else
        log "数据库备份失败"
        exit 1
    fi
}

# CDN资源备份
backup_cdn() {
    log "开始CDN资源备份"
    
    # 增量同步
    rsync -av --delete ${APP_DIR}/static/cdn/ ${BACKUP_DIR}/daily/cdn/${DATE}/
    
    if [ $? -eq 0 ]; then
        log "CDN资源备份成功"
        
        # 压缩并上传
        tar -czf ${BACKUP_DIR}/daily/cdn/cdn_${DATE}.tar.gz -C ${BACKUP_DIR}/daily/cdn/ ${DATE}/
        ossutil cp ${BACKUP_DIR}/daily/cdn/cdn_${DATE}.tar.gz oss://crop-card-backup/daily/cdn/
        
    else
        log "CDN资源备份失败"
    fi
}

# 清理旧备份
cleanup_old_backups() {
    log "开始清理旧备份"
    
    # 删除30天前的日备份
    find ${BACKUP_DIR}/daily/db/ -name "app_*.db" -mtime +30 -delete
    find ${BACKUP_DIR}/daily/cdn/ -name "cdn_*.tar.gz" -mtime +30 -delete
    
    log "旧备份清理完成"
}

# 主执行流程
main() {
    log "=== 开始备份任务 ==="
    
    backup_database
    backup_cdn
    cleanup_old_backups
    
    log "=== 备份任务完成 ==="
}

# 执行主函数
main "$@"
```

#### 4.4 定时任务配置

```bash
# 编辑crontab
crontab -e

# 添加备份定时任务
# 每日凌晨2点执行完整备份
0 2 * * * /opt/crop-card-backups/scripts/backup.sh daily >> /opt/crop-card-backups/logs/cron.log 2>&1

# 每4小时执行增量备份
0 */4 * * * /opt/crop-card-backups/scripts/backup.sh incremental >> /opt/crop-card-backups/logs/cron.log 2>&1

# 每周日凌晨1点执行完整系统备份
0 1 * * 0 /opt/crop-card-backups/scripts/backup.sh weekly >> /opt/crop-card-backups/logs/cron.log 2>&1

# 每月最后一天执行归档备份
0 1 28-31 * * [ $(date -d tomorrow +\%d) -eq 1 ] && /opt/crop-card-backups/scripts/backup.sh monthly >> /opt/crop-card-backups/logs/cron.log 2>&1
```

### 5. 监控和告警

#### 5.1 备份状态监控

**监控脚本** (`/opt/crop-card-backups/scripts/monitor.sh`)
```bash
#!/bin/bash

# 检查备份文件是否存在
check_backup_files() {
    today=$(date +%Y%m%d)
    
    # 检查今日数据库备份
    if ! ls /opt/crop-card-backups/daily/db/app_${today}_*.db 1> /dev/null 2>&1; then
        echo "警告: 今日数据库备份文件不存在"
        return 1
    fi
    
    # 检查磁盘空间
    disk_usage=$(df /opt/crop-card-backups | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $disk_usage -gt 80 ]; then
        echo "警告: 备份磁盘空间不足，当前使用率: ${disk_usage}%"
        return 1
    fi
    
    echo "备份状态正常"
    return 0
}

# 邮件通知
send_alert() {
    message="$1"
    echo "$message" | mail -s "企业名片系统备份告警" admin@company.com
}

# 执行检查
if ! check_backup_files; then
    send_alert "企业名片系统备份异常，请及时检查"
fi
```

#### 5.2 恢复验证

**恢复测试脚本** (`/opt/crop-card-backups/scripts/recovery_test.sh`)
```bash
#!/bin/bash

# 恢复测试环境
TEST_DIR="/tmp/crop-card-recovery-test"
mkdir -p $TEST_DIR

# 获取最新备份文件
latest_backup=$(ls -t /opt/crop-card-backups/daily/db/app_*.db | head -1)

# 复制到测试目录
cp $latest_backup $TEST_DIR/test_app.db

# 验证数据库完整性
sqlite3 $TEST_DIR/test_app.db "PRAGMA integrity_check;" > $TEST_DIR/integrity_result.txt

# 检查结果
if grep -q "ok" $TEST_DIR/integrity_result.txt; then
    echo "数据库完整性验证通过"
    exit 0
else
    echo "数据库完整性验证失败"
    cat $TEST_DIR/integrity_result.txt
    exit 1
fi
```

### 6. 灾难恢复方案

#### 6.1 系统恢复步骤

1. **环境准备**
   ```bash
   # 安装系统依赖
   yum install -y sqlite
   
   # 创建应用目录
   mkdir -p /opt/crop-card/data
   ```

2. **数据恢复**
   ```bash
   # 从云存储下载最新备份
   ossutil cp oss://crop-card-backup/daily/db/app_latest.db /opt/crop-card/data/app.db
   
   # 验证数据库完整性
   sqlite3 /opt/crop-card/data/app.db "PRAGMA integrity_check;"
   ```

3. **资源恢复**
   ```bash
   # 恢复CDN资源
   ossutil sync oss://crop-card-backup/daily/cdn/ /opt/crop-card/static/cdn/
   ```

4. **服务启动**
   ```bash
   # 启动应用服务
   systemctl start crop-card-backend
   systemctl enable crop-card-backend
   ```

#### 6.2 恢复时间目标(RTO)和恢复点目标(RPO)

- **RTO**: 1小时（系统完全恢复运行时间）
- **RPO**: 4小时（最大数据丢失时间）

### 7. 安全性措施

#### 7.1 备份文件加密

```bash
# 使用GPG加密敏感备份
gpg --cipher-algo AES256 --compress-algo 1 --symmetric --output app_${DATE}.db.gpg app_${DATE}.db
```

#### 7.2 访问权限控制

```bash
# 设置备份目录权限
chmod 700 /opt/crop-card-backups
chown backup:backup /opt/crop-card-backups

# 设置脚本权限
chmod 750 /opt/crop-card-backups/scripts/*.sh
```

### 8. 备份测试计划

#### 8.1 月度恢复测试

- **测试时间**: 每月第二个周六
- **测试内容**: 完整的数据库恢复和功能验证
- **测试环境**: 独立的测试服务器
- **测试报告**: 记录恢复时间和发现的问题

#### 8.2 季度演练

- **演练时间**: 每季度末
- **演练内容**: 模拟灾难场景的完整系统恢复
- **参与人员**: 运维团队、开发团队
- **演练总结**: 优化恢复流程和备份策略

### 9. 维护清单

#### 9.1 日常检查项
- [ ] 备份任务执行状态
- [ ] 备份文件生成情况
- [ ] 磁盘空间使用率
- [ ] 云存储同步状态

#### 9.2 周度检查项
- [ ] 备份文件完整性验证
- [ ] 日志文件分析
- [ ] 监控告警测试
- [ ] 恢复脚本功能测试

#### 9.3 月度检查项
- [ ] 完整恢复测试
- [ ] 备份策略评估
- [ ] 存储容量规划
- [ ] 文档更新维护

### 10. 联系信息

- **系统管理员**: [管理员姓名] - [邮箱] - [电话]
- **开发负责人**: [开发者姓名] - [邮箱] - [电话]
- **紧急联系人**: [联系人姓名] - [邮箱] - [电话]

### 11. 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0 | 2025-09-30 | 初始版本 | System Admin |

---

**注意事项**:
1. 定期更新备份策略以适应业务变化
2. 确保备份存储的安全性和可靠性
3. 定期进行恢复演练验证备份有效性
4. 保持备份文档的时效性和准确性
