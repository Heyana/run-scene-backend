# 项目管理系统 - 交互设计

## 概述

定义前后端交互的API接口、数据流转和通信协议。

## API接口定义

### 1. 获取项目列表

```
GET /api/projects

Query参数:
- page: number (默认1)
- page_size: number (默认20)
- keyword: string (可选，搜索关键词)

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "data": [
      {
        "id": 1,
        "name": "项目名称",
        "description": "项目描述",
        "current_version": "1.2.3",
        "latest_version_id": 5,
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-02T00:00:00Z"
      }
    ]
  }
}
```

### 2. 创建项目

```
POST /api/projects

Request Body:
{
  "name": "项目名称",
  "description": "项目描述"
}

Response:
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 1,
    "name": "项目名称",
    "description": "项目描述",
    "current_version": "1.0.0",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 3. 上传版本

```
POST /api/projects/:id/versions

Content-Type: multipart/form-data

Form Data:
- project_id: number
- username: string
- description: string
- version_type: "major" | "minor" | "patch"
- files: File[] (文件夹中的所有文件)

Response:
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "id": 1,
    "project_id": 1,
    "version": "1.1.0",
    "username": "张三",
    "description": "更新描述",
    "file_path": "projects/project1/v1.1.0.zip",
    "file_size": 1024000,
    "file_hash": "abc123...",
    "file_count": 150,
    "file_url": "http://192.168.3.39:23359/projects/project1/v1.1.0.zip",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 4. 获取版本历史

```
GET /api/projects/:id/versions

Response:
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 3,
      "project_id": 1,
      "version": "1.2.0",
      "username": "李四",
      "description": "修复bug",
      "file_path": "projects/project1/v1.2.0.zip",
      "file_size": 1024000,
      "file_hash": "def456...",
      "file_count": 155,
      "file_url": "http://192.168.3.39:23359/projects/project1/v1.2.0.zip",
      "created_at": "2024-01-03T00:00:00Z"
    },
    {
      "id": 2,
      "project_id": 1,
      "version": "1.1.0",
      "username": "张三",
      "description": "新增功能",
      "file_path": "projects/project1/v1.1.0.zip",
      "file_size": 1020000,
      "file_hash": "abc123...",
      "file_count": 150,
      "file_url": "http://192.168.3.39:23359/projects/project1/v1.1.0.zip",
      "created_at": "2024-01-02T00:00:00Z"
    }
  ]
}
```

### 5. 删除项目

```
DELETE /api/projects/:id

Response:
{
  "code": 200,
  "message": "删除成功"
}
```

### 6. 下载版本

```
GET /api/projects/versions/:id/download

Response:
文件流下载，Content-Type: application/zip
```

### 7. 回滚版本

```
POST /api/projects/versions/:id/rollback

Response:
{
  "code": 200,
  "message": "回滚成功",
  "data": {
    "project_id": 1,
    "current_version": "1.1.0"
  }
}
```

## 数据流转

### 创建项目流程

```
前端 -> 后端
1. 用户填写表单
2. 前端验证数据
3. POST /api/projects
4. 后端创建项目记录
5. 返回项目信息
6. 前端更新列表
```

### 上传版本流程

```
前端 -> 后端
1. 用户选择文件夹
2. 前端收集所有文件
3. 用户填写用户名、描述、版本类型
4. 前端打包FormData
5. POST /api/projects/:id/versions
6. 后端接收文件
7. 后端压缩文件夹
8. 后端计算版本号
9. 后端保存到NAS/本地
10. 后端创建版本记录
11. 后端更新项目当前版本
12. 返回版本信息
13. 前端显示成功提示
```

### 查看历史流程

```
前端 -> 后端
1. 用户点击"版本历史"
2. GET /api/projects/:id/versions
3. 后端查询版本列表
4. 返回版本数据
5. 前端展示版本列表
```

## 错误码定义

```typescript
enum ErrorCode {
  SUCCESS = 200,
  BAD_REQUEST = 400,
  UNAUTHORIZED = 401,
  FORBIDDEN = 403,
  NOT_FOUND = 404,
  CONFLICT = 409, // 项目名称重复
  PAYLOAD_TOO_LARGE = 413, // 文件过大
  INTERNAL_ERROR = 500,
  STORAGE_ERROR = 501, // 存储失败
}
```

## 错误响应格式

```json
{
  "code": 409,
  "message": "项目名称已存在",
  "error": "duplicate_project_name"
}
```

## 文件上传处理

### 前端处理

```typescript
// 1. 选择文件夹
const handleFolderSelect = (e: Event) => {
  const files = (e.target as HTMLInputElement).files;
  // 收集所有文件
};

// 2. 构建FormData
const formData = new FormData();
formData.append("project_id", projectId);
formData.append("username", username);
formData.append("description", description);
formData.append("version_type", versionType);

// 添加所有文件
for (let i = 0; i < files.length; i++) {
  formData.append("files", files[i], files[i].webkitRelativePath);
}

// 3. 上传
await axios.post("/api/projects/:id/versions", formData, {
  headers: { "Content-Type": "multipart/form-data" },
  onUploadProgress: (e) => {
    // 显示上传进度
  },
});
```

### 后端处理

```go
// 1. 接收文件
form, _ := c.MultipartForm()
files := form.File["files"]

// 2. 创建临时目录
tempDir := filepath.Join(os.TempDir(), uuid.New().String())
os.MkdirAll(tempDir, 0755)

// 3. 保存文件到临时目录（保持目录结构）
for _, file := range files {
  relativePath := file.Filename
  destPath := filepath.Join(tempDir, relativePath)
  // 创建目录并保存文件
}

// 4. 压缩临时目录
zipPath := CompressFolder(tempDir)

// 5. 上传到NAS/本地
finalPath := SaveToStorage(zipPath)

// 6. 清理临时文件
os.RemoveAll(tempDir)
```

## 版本号计算规则

```go
// 语义化版本号: major.minor.patch
func CalculateNextVersion(current string, versionType string) string {
  parts := strings.Split(current, ".")
  major, _ := strconv.Atoi(parts[0])
  minor, _ := strconv.Atoi(parts[1])
  patch, _ := strconv.Atoi(parts[2])

  switch versionType {
  case "major":
    return fmt.Sprintf("%d.0.0", major+1)
  case "minor":
    return fmt.Sprintf("%d.%d.0", major, minor+1)
  case "patch":
    return fmt.Sprintf("%d.%d.%d", major, minor, patch+1)
  }
}
```

## 并发控制

- 同一项目同时只能有一个版本上传
- 使用分布式锁或数据库锁
- 上传超时时间：10分钟

## 安全考虑

- 文件类型白名单验证
- 文件大小限制
- 路径遍历攻击防护
- 用户身份验证（如需要）
- 上传频率限制

## 性能优化

- 大文件分片上传（可选）
- 上传进度实时反馈
- 异步压缩处理
- CDN加速下载
- 缓存版本列表

## WebSocket通知（可选）

用于实时通知上传进度和处理状态：

```typescript
// 前端
const ws = new WebSocket('ws://localhost:23359/ws/upload')
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  // 更新进度条
}

// 后端
type UploadProgress struct {
  Stage    string  // "uploading" | "compressing" | "saving" | "done"
  Progress float64 // 0-100
  Message  string
}
```
