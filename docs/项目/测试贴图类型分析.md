# 测试贴图类型分析功能

## 问题修复

### 原始错误

```
SQL logic error: no such table: files (1)
```

### 原因

在数据库迁移过程中，`RunOnceUpgrade()` 函数在表创建之前就被调用了，导致查询失败。

### 解决方案

1. **使用 GORM 的 Table() 方法**：替换原生 SQL，使用 GORM 的查询构建器
2. **添加表存在检查**：在分析前检查表是否存在
3. **优雅降级**：如果表不存在，跳过分析而不是报错

## 修改内容

### 1. texture_type_analyzer.go

**修改前**（使用原生 SQL）：

```go
err := db.Raw(`
    SELECT
        f.texture_type,
        COUNT(*) as count,
        'polyhaven' as source
    FROM files f
    INNER JOIN textures t ON f.related_id = t.id AND f.related_type = 'Texture'
    WHERE f.file_type = 'texture'
        AND f.texture_type != ''
        AND t.source = 'polyhaven'
    GROUP BY f.texture_type
`).Scan(&results).Error
```

**修改后**（使用 GORM）：

```go
// 检查表是否存在
if !db.Migrator().HasTable(&models.File{}) {
    logger.Log.Warn("File 表不存在，跳过分析")
    return []TextureTypeAnalysis{}, nil
}

// 使用 GORM 的方式查询
err := db.Table("files as f").
    Select("f.texture_type, COUNT(*) as count, 'polyhaven' as source").
    Joins("INNER JOIN textures t ON f.related_id = t.id AND f.related_type = ?", "Texture").
    Where("f.file_type = ? AND f.texture_type != ? AND t.source = ?", "texture", "", "polyhaven").
    Group("f.texture_type").
    Scan(&results).Error
```

### 2. migrations.go

添加了表存在检查：

```go
func logTextureTypeAnalysis(db *gorm.DB) error {
    // 检查表是否存在
    if !db.Migrator().HasTable(&models.File{}) || !db.Migrator().HasTable(&models.Texture{}) {
        logger.Log.Info("相关表不存在，跳过贴图类型分析")
        return nil
    }

    // ... 继续分析
}
```

## 测试步骤

### 1. 重启后端服务

```bash
# Windows
cd run-scene-backend
.\app.exe

# Linux
cd run-scene-backend
./app-linux
```

### 2. 查看启动日志

应该看到类似输出：

```
time="2026-01-26 13:30:00" level=info msg="开始记录贴图类型分析..."
time="2026-01-26 13:30:00" level=info msg="开始分析所有贴图类型..."
time="2026-01-26 13:30:01" level=info msg="分析完成，共发现 15 种贴图类型"
time="2026-01-26 13:30:01" level=info msg="========== 贴图类型分析报告 =========="
time="2026-01-26 13:30:01" level=info msg="共发现 15 种贴图类型"
time="2026-01-26 13:30:01" level=info msg="\n--- PolyHaven 数据源 ---"
time="2026-01-26 13:30:01" level=info msg="  Diffuse: 150 个文件 → 建议类型: map"
time="2026-01-26 13:30:01" level=info msg="  Rough: 150 个文件 → 建议类型: roughnessMap"
...
```

### 3. 测试前端页面

1. 打开浏览器访问：`http://localhost:23359`
2. 点击"贴图类型分析"按钮
3. 应该看到两个数据源的分析结果

### 4. 测试 API 接口

```bash
# 使用 curl 测试
curl http://localhost:23359/api/textures/analyze-types

# 或使用浏览器直接访问
http://localhost:23359/api/textures/analyze-types
```

预期响应：

```json
{
  "code": 200,
  "data": {
    "analysis": [
      {
        "original_type": "Diffuse",
        "count": 150,
        "source": "polyhaven",
        "examples": ["Diffuse_2k.jpg", "Diffuse_4k.jpg"],
        "suggested_type": "map"
      },
      ...
    ],
    "total": 15
  },
  "message": "success"
}
```

## 预期结果

### PolyHaven 常见类型

- Diffuse → map
- Rough → roughnessMap
- nor_gl → normalMap
- nor_dx → normalMap
- AO → aoMap
- Displacement → displacementMap
- arm → aoMap,roughnessMap,metalnessMap

### AmbientCG 常见类型

- Color → map
- Roughness → roughnessMap
- NormalGL → normalMap
- NormalDX → normalMap
- Metalness → metalnessMap
- Displacement → displacementMap
- AmbientOcclusion → aoMap

## 故障排查

### 如果仍然报错 "no such table"

1. 检查数据库文件是否存在
2. 删除数据库文件，让系统重新创建
3. 查看完整的启动日志

### 如果前端页面空白

1. 检查浏览器控制台是否有错误
2. 检查 API 是否正常响应
3. 检查前端是否正确编译

### 如果分析结果为空

1. 确认数据库中有贴图数据
2. 检查 texture_type 字段是否有值
3. 运行 `analyzeTextureTypes()` 升级任务填充 texture_type

## 下一步

如果测试成功，可以：

1. 根据分析结果完善映射规则
2. 添加更多贴图类型的支持
3. 优化前端展示效果
