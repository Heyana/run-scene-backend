# 前端实现

## 功能

前端负责导出节点元数据JSON，调用后端API生成蓝图，并应用到画布。

## 实现步骤

### 1. 导出节点元数据

```typescript
// src/Graph/AI/exportNodeMetadata.ts
export function exportNodeMetadata(graph: Graph): NodeMetadataJSON {
  const metadata = {};
  const allTypes = graph.getAllTypes();

  Object.keys(allTypes).forEach((type) => {
    const nodeClass = LiteGraph.registered_node_types[type];
    const instance = new nodeClass();

    metadata[type] = {
      type,
      category: type.split("/")[0],
      inputs:
        instance.inputs?.map((i) => ({
          name: i.name,
          type: i.type,
        })) || [],
      outputs:
        instance.outputs?.map((o) => ({
          name: o.name,
          type: o.type,
        })) || [],
      properties:
        instance.widgets?.map((w) => ({
          key: w.key,
          label: w.label,
          type: w.type,
        })) || [],
    };
  });

  return metadata;
}
```

### 2. 调用后端API

```typescript
// src/Graph/AI/generateBlueprint.ts
export async function generateBlueprint(
  userRequest: string,
  metadata: NodeMetadataJSON,
): Promise<GraphJSON> {
  const response = await fetch("/api/blueprint/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userRequest,
      metadata,
    }),
  });

  if (!response.ok) throw new Error("生成失败");

  const data = await response.json();
  return data.data.graphJson;
}
```

### 3. UI集成

```typescript
// GraphCore.tsx 添加右键菜单
{
  name: "AI 生成蓝图",
  click: async () => {
    const input = await pop.input({
      title: "描述你想要的功能",
      tip: "例如：创建一个点击按钮播放动画"
    })

    if (!input) return

    pop.loading("生成中...")

    try {
      // 1. 导出元数据
      const metadata = exportNodeMetadata(this.core.graph.api.getGraph())

      // 2. 调用API
      const graphJson = await generateBlueprint(input, metadata)

      // 3. 应用到画布
      const pos = this.core.graph.api.getGraph().getMousePos()
      this.core.graph.api.parseJSON({
        type: "graph",
        version: "0.0.1",
        data: graphJson
      }, { local: pos })

      pop.tip("生成成功")
    } catch (error) {
      pop.error("生成失败: " + error.message)
    }
  }
}
```

## 数据结构

```typescript
interface NodeMetadataJSON {
  [nodeType: string]: {
    type: string;
    category: string;
    inputs: Array<{ name: string; type: string }>;
    outputs: Array<{ name: string; type: string }>;
    properties: Array<{ key: string; label: string; type: string }>;
  };
}

interface GraphJSON {
  nodes: Array<{
    id: number;
    type: string;
    pos: [number, number];
    properties: Record<string, any>;
    title?: string;
  }>;
  links: Array<[number, number, number, number, number, string]>;
}
```

## 完成
