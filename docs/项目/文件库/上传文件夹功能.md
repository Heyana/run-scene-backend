# 上传文件夹功能

## 功能概述

支持上传整个文件夹，自动保持文件夹结构，类似项目库的版本上传功能。

## 实现时间

2026年2月9日

## 功能特点

### 1. 保持文件夹结构

- 自动识别文件夹层级关系
- 递归创建所有子文件夹
- 文件自动归属到对应的文件夹中

### 2. 批量上传

- 一次性上传整个文件夹的所有文件
- 支持任意深度的文件夹嵌套
- 自动处理文件路径

### 3. 智能处理

- 自动去除根文件夹前缀
- 文件名自动清洗（去除特殊字符）
- MD5 重复检测（跳过重复文件）

### 4. 详细反馈

- 显示上传进度
- 统计上传成功/失败的文件数
- 列出所有错误信息

## API 接口

### 上传文件夹

```
POST /api/documents/upload-folder
Content-Type: multipart/form-data

files: <文件数组>
file_paths: <JSON数组，包含所有文件的相对路径>
parent_id: <可选，父文件夹ID>
description: <可选，描述>
category: <可选，分类>
department: <可选，部门>
project: <可选，项目>
```

### 请求示例

```typescript
const formData = new FormData();

// 添加所有文件
files.forEach((file) => {
  formData.append("files", file);
});

// 添加文件路径列表
const filePaths = files.map((file) => file.webkitRelativePath);
formData.append("file_paths", JSON.stringify(filePaths));

// 添加元数据
formData.append("description", "项目文档");
formData.append("category", "技术文档");
formData.append("parent_id", "1");

await uploadFolder(formData);
```

### 响应示例

```json
{
  "code": 200,
  "msg": "上传成功",
  "data": {
    "root_folder_id": 123,
    "root_folder_name": "my-project",
    "uploaded_files": 45,
    "created_folders": 8,
    "skipped_files": 2,
    "total_files": 47,
    "errors": [
      "上传文件 duplicate.txt 失败: 文件已存在",
      "上传文件 invalid#name.doc 失败: 文件名包含非法字符"
    ]
  }
}
```

## 前端实现

### 1. 文件夹选择

使用 HTML5 的 `webkitdirectory` 属性：

```html
<input
  type="file"
  webkitdirectory=""
  directory=""
  multiple
  onChange="{handleFolderChange}"
/>
```

### 2. 获取文件路径

通过 `file.webkitRelativePath` 获取文件的相对路径：

```typescript
const handleFolderChange = (e: Event) => {
  const input = e.target as HTMLInputElement;
  if (input.files && input.files.length > 0) {
    const files = Array.from(input.files);
    const filePaths = files.map((file) => file.webkitRelativePath);
    // 使用 files 和 filePaths 上传
  }
};
```

### 3. 上传文件夹

```typescript
const handleUploadFolder = async () => {
  const formData = new FormData();

  // 添加所有文件
  files.forEach((file) => {
    formData.append("files", file);
  });

  // 添加文件路径
  const filePaths = files.map((file) => file.webkitRelativePath);
  formData.append("file_paths", JSON.stringify(filePaths));

  // 添加元数据
  formData.append("description", description);
  formData.append("category", category);

  // 如果在子文件夹中上传
  if (currentFolderId !== 0) {
    formData.append("parent_id", String(currentFolderId));
  }

  await uploadFolder(formData);
};
```

## 后端实现

### 1. 解析文件路径

```go
// 解析文件路径列表
filePathsJSON := ctx.PostForm("file_paths")
var filePaths []string
json.Unmarshal([]byte(filePathsJSON), &filePaths)

// 获取上传的文件
form, _ := ctx.MultipartForm()
files := form.File["files"]
```

### 2. 提取根文件夹

```go
// 提取根文件夹名（第一层目录）
var rootFolderName string
if len(filePaths) > 0 {
    parts := strings.Split(filePaths[0], "/")
    if len(parts) > 1 {
        rootFolderName = parts[0]
    }
}

// 创建根文件夹
rootFolder, err := s.CreateFolder(rootFolderName, ...)
```

### 3. 递归创建子文件夹

```go
// 文件夹映射：路径 -> Document ID
folderMap := make(map[string]uint)
folderMap[rootFolderName] = rootFolder.ID

// 遍历所有文件
for i, file := range files {
    originalPath := filePaths[i]

    // 去掉根文件夹前缀
    relativePath := strings.TrimPrefix(originalPath, rootFolderName + "/")

    // 解析路径，创建必要的文件夹
    parts := strings.Split(relativePath, "/")
    fileName := parts[len(parts)-1]

    // 逐层创建文件夹
    var parentFolderID uint = rootFolder.ID
    for j := 0; j < len(parts)-1; j++ {
        folderName := parts[j]
        currentPath := rootFolderName + "/" + strings.Join(parts[:j+1], "/")

        // 检查文件夹是否已创建
        if folderID, exists := folderMap[currentPath]; exists {
            parentFolderID = folderID
        } else {
            // 创建新文件夹
            newFolder, _ := s.CreateFolder(folderName, "", &parentFolderID, ...)
            folderMap[currentPath] = newFolder.ID
            parentFolderID = newFolder.ID
        }
    }

    // 上传文件到对应文件夹
    s.Upload(file, UploadMetadata{
        Name: fileName,
        ParentID: &parentFolderID,
        ...
    })
}
```

## 使用场景

### 1. 项目文档上传

```
project-docs/
├── README.md
├── api/
│   ├── user.md
│   └── product.md
├── design/
│   ├── ui.png
│   └── flow.png
└── code/
    ├── backend/
    │   └── main.go
    └── frontend/
        └── App.tsx
```

上传后在文件库中保持相同结构：

```
文件库/
└── project-docs/  (文件夹)
    ├── README.md  (文件)
    ├── api/  (文件夹)
    │   ├── user.md  (文件)
    │   └── product.md  (文件)
    ├── design/  (文件夹)
    │   ├── ui.png  (文件)
    │   └── flow.png  (文件)
    └── code/  (文件夹)
        ├── backend/  (文件夹)
        │   └── main.go  (文件)
        └── frontend/  (文件夹)
            └── App.tsx  (文件)
```

### 2. 培训资料上传

```
training-2024/
├── videos/
│   ├── lesson1.mp4
│   └── lesson2.mp4
├── slides/
│   ├── intro.pdf
│   └── advanced.pdf
└── exercises/
    ├── exercise1.docx
    └── exercise2.docx
```

### 3. 设计素材上传

```
design-assets/
├── icons/
│   ├── home.svg
│   └── user.svg
├── images/
│   ├── banner.jpg
│   └── logo.png
└── fonts/
    ├── regular.ttf
    └── bold.ttf
```

## 注意事项

### 1. 浏览器兼容性

- `webkitdirectory` 属性在现代浏览器中都支持
- Chrome、Edge、Firefox、Safari 都支持
- IE 不支持（但已停止维护）

### 2. 文件数量限制

- 建议单次上传不超过 1000 个文件
- 大量文件可能导致上传时间较长
- 可以考虑添加进度条显示

### 3. 文件大小限制

- 遵循单个文件的大小限制
- 总大小受服务器配置限制
- 建议分批上传大型文件夹

### 4. 重复文件处理

- 通过 MD5 检测重复文件
- 重复文件会被跳过
- 在响应中列出跳过的文件

### 5. 错误处理

- 部分文件上传失败不影响其他文件
- 所有错误都会在响应中列出
- 前端显示详细的错误信息

## 优化建议

### 1. 添加进度条

```typescript
const [uploadProgress, setUploadProgress] = useState(0);

await uploadFolder(formData, {
  onUploadProgress: (progressEvent) => {
    const progress = Math.round(
      (progressEvent.loaded * 100) / progressEvent.total,
    );
    setUploadProgress(progress);
  },
});
```

### 2. 支持拖拽上传

```typescript
const handleDrop = (e: DragEvent) => {
  e.preventDefault();
  const items = e.dataTransfer.items;

  for (let i = 0; i < items.length; i++) {
    const item = items[i].webkitGetAsEntry();
    if (item.isDirectory) {
      // 处理文件夹
      traverseDirectory(item);
    }
  }
};
```

### 3. 支持断点续传

- 记录已上传的文件
- 失败后可以继续上传
- 避免重复上传

### 4. 压缩上传

- 前端压缩文件夹为 ZIP
- 后端解压并创建结构
- 减少网络传输时间

## 测试建议

### 1. 基础功能测试

- [x] 上传单层文件夹
- [x] 上传多层嵌套文件夹
- [x] 上传到根目录
- [x] 上传到子文件夹

### 2. 边界测试

- [ ] 上传空文件夹
- [ ] 上传大量文件（1000+）
- [ ] 上传大文件（100MB+）
- [ ] 上传特殊字符文件名

### 3. 错误测试

- [ ] 网络中断
- [ ] 磁盘空间不足
- [ ] 权限不足
- [ ] 重复文件

### 4. 性能测试

- [ ] 上传速度
- [ ] 内存占用
- [ ] 并发上传

## 总结

上传文件夹功能已完成，主要特点：

✅ **保持结构**: 自动创建文件夹层级，文件归属正确  
✅ **批量上传**: 一次性上传整个文件夹  
✅ **智能处理**: 自动清洗文件名，检测重复文件  
✅ **详细反馈**: 显示上传统计和错误信息  
✅ **易于使用**: 前端一键选择文件夹，后端自动处理

这个功能让文件库更加实用，特别适合上传项目文档、培训资料、设计素材等场景。
