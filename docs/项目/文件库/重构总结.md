# 文件库重构总结

## 重构完成时间

2026年2月9日

## 重构原因

用户指出文件库和文件组不应该是两个独立的系统，应该像云盘一样统一管理。文件和文件夹应该在同一个表/视图中，而不是分开的两套东西。

## 重构前的问题

1. **两套系统**: DocumentGroup（文件组）和 Document（文件）是两个独立的系统
2. **复杂的关联**: 需要通过 DocumentGroupItem 中间表关联文件和文件组
3. **用户体验差**: 文件和文件夹分开显示，不符合云盘使用习惯
4. **维护困难**: 两套 API、两套前端页面、两套数据模型

## 重构后的优势

1. **统一模型**: 文件和文件夹在同一个 `documents` 表中
2. **简化关联**: 通过 `parent_id` 直接建立层级关系
3. **云盘体验**: 文件和文件夹统一显示，点击文件夹进入，面包屑导航
4. **易于维护**: 一套 API、一个前端页面、一个数据模型

## 已删除的文件

### 后端

- `models/document_group.go` - 文件组模型
- `services/document_group/*.go` - 文件组服务
- `controllers/document_group_controller.go` - 文件组控制器

### 前端

- `frontend/src/api/documentGroups.ts` - 文件组 API
- `frontend/src/views/DocumentGroups.tsx` - 文件组列表页面
- `frontend/src/views/DocumentGroupDetail.tsx` - 文件组详情页面
- `frontend/src/views/DocumentGroups.less` - 文件组样式

### 路由

- 删除了所有 `/api/document-groups` 相关路由

## 已修改的文件

### 后端

1. **models/document.go**
   - 添加 `is_folder` 字段
   - 添加 `parent_id` 字段
   - 添加 `child_count` 字段
   - 实现 `AfterCreate`、`AfterDelete` 钩子自动维护 `child_count`

2. **services/document/upload_service.go**
   - 添加 `CreateFolder` 方法
   - `Upload` 方法支持 `parent_id` 参数

3. **services/document/query_service.go**
   - `List` 方法支持 `parent_id` 过滤

4. **controllers/document_controller.go**
   - 添加 `CreateFolder` 端点
   - 删除 `RegisterDocumentGroupRoutes` 函数

5. **api/routes.go**
   - 添加 `POST /api/documents/folder` 路由
   - 删除所有 `/api/document-groups` 路由

6. **database/database.go**
   - 删除 `DocumentGroup` 和 `DocumentGroupItem` 表的迁移

### 前端

1. **frontend/src/api/documents.ts**
   - 更新 `Document` 接口，添加 `is_folder`、`parent_id`、`child_count` 字段
   - 添加 `createFolder` 函数

2. **frontend/src/views/Documents.tsx**
   - 完全重写，使用统一模型
   - 删除 `folders` 状态
   - `currentFolderId` 改为数字类型（0 表示根目录）
   - 统一处理文件和文件夹的显示、删除、导航

## 核心功能

### 1. 创建文件夹

```typescript
createFolder({
  name: "新文件夹",
  description: "描述",
  parent_id: 0, // 0 表示根目录
});
```

### 2. 上传文件到文件夹

```typescript
const formData = new FormData();
formData.append("file", file);
formData.append("parent_id", String(currentFolderId));
uploadDocument(formData);
```

### 3. 查询文件夹内容

```typescript
getDocuments({
  parent_id: folderId, // 0 表示根目录
  page: 1,
  pageSize: 24,
});
```

### 4. 文件夹导航

- 点击文件夹进入子目录
- 面包屑导航显示完整路径
- 返回按钮返回上级目录

### 5. 级联删除

- 删除文件夹时自动删除所有子项
- 前端提示用户确认
- 自动更新父文件夹的 `child_count`

## 数据库变化

### 新增字段

```sql
ALTER TABLE documents ADD COLUMN is_folder BOOLEAN DEFAULT FALSE;
ALTER TABLE documents ADD COLUMN parent_id INTEGER;
ALTER TABLE documents ADD COLUMN child_count INTEGER DEFAULT 0;
```

### 删除表

```sql
DROP TABLE document_group_items;
DROP TABLE document_groups;
```

## API 变化

### 新增接口

- `POST /api/documents/folder` - 创建文件夹

### 修改接口

- `POST /api/documents/upload` - 支持 `parent_id` 参数
- `GET /api/documents` - 支持 `parent_id` 查询参数
- `DELETE /api/documents/:id` - 支持级联删除文件夹

### 删除接口

- 所有 `/api/document-groups` 相关接口

## 测试建议

### 1. 基础功能测试

- [x] 创建根目录文件夹
- [x] 创建子文件夹
- [x] 上传文件到根目录
- [x] 上传文件到子文件夹
- [x] 删除空文件夹
- [x] 删除包含文件的文件夹

### 2. 导航测试

- [x] 点击文件夹进入
- [x] 面包屑导航返回
- [x] 返回按钮返回上级

### 3. 预览测试

- [x] 图片预览
- [x] 视频播放
- [x] 文件下载

### 4. 统计测试

- [x] 文件夹数量统计
- [x] 文件数量统计
- [x] `child_count` 自动更新

## 注意事项

1. **parent_id 的含义**
   - `0` 或 `NULL`: 根目录
   - 其他数字: 指定文件夹的 ID

2. **child_count 维护**
   - 由 GORM 钩子自动维护
   - 创建/删除子项时自动更新
   - 不要手动修改此字段

3. **级联删除**
   - 删除文件夹会删除所有子项（文件和子文件夹）
   - 前端会提示用户确认
   - 后端通过 GORM 的 `AfterDelete` 钩子实现

4. **文件路径**
   - 存储相对路径（基于 `static` 目录）
   - `AfterFind` 钩子自动拼接完整 URL
   - 仅文件有 `file_url`，文件夹没有

## 迁移指南

如果生产环境已有旧数据，需要执行以下迁移：

### 1. 备份数据

```bash
# 备份数据库
cp data.db data.db.backup
```

### 2. 迁移文件组到文件夹

```sql
-- 将 document_groups 迁移为文件夹
INSERT INTO documents (name, description, parent_id, is_folder, type, created_at, updated_at)
SELECT name, description, parent_id, 1, 'folder', created_at, updated_at
FROM document_groups;
```

### 3. 更新文件的 parent_id

```sql
-- 更新现有文件的 parent_id
UPDATE documents d
SET parent_id = (
  SELECT new_d.id
  FROM documents new_d
  JOIN document_groups dg ON new_d.name = dg.name AND new_d.is_folder = 1
  JOIN document_group_items dgi ON dgi.group_id = dg.id
  WHERE dgi.document_id = d.id
  LIMIT 1
)
WHERE EXISTS (
  SELECT 1 FROM document_group_items dgi WHERE dgi.document_id = d.id
);
```

### 4. 更新 child_count

```sql
-- 更新所有文件夹的 child_count
UPDATE documents
SET child_count = (
  SELECT COUNT(*) FROM documents d2 WHERE d2.parent_id = documents.id
)
WHERE is_folder = 1;
```

### 5. 删除旧表

```sql
DROP TABLE document_group_items;
DROP TABLE document_groups;
```

### 6. 验证数据

```sql
-- 检查文件夹数量
SELECT COUNT(*) FROM documents WHERE is_folder = 1;

-- 检查文件数量
SELECT COUNT(*) FROM documents WHERE is_folder = 0;

-- 检查 child_count 是否正确
SELECT id, name, child_count,
       (SELECT COUNT(*) FROM documents d2 WHERE d2.parent_id = documents.id) as actual_count
FROM documents
WHERE is_folder = 1;
```

## 总结

重构成功完成！文件库现在是一个统一的云盘式文件管理系统：

✅ **简化架构**: 从两套系统简化为一套统一系统  
✅ **云盘体验**: 文件和文件夹统一显示，符合用户习惯  
✅ **易于维护**: 代码量减少，逻辑更清晰  
✅ **功能完整**: 支持无限嵌套、级联删除、自动统计  
✅ **向后兼容**: 提供了完整的数据迁移方案

系统现在更加简洁、高效、易用！
