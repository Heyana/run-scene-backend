# æƒé™ç³»ç»Ÿæ¨¡æ¿ (P2)

## ğŸ¯ ç›®æ ‡

æä¾›é€šç”¨ RBAC (åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶) æ¡†æ¶æ¨¡æ¿ï¼Œç®€åŒ–ä¼ä¸šçº§æƒé™ç³»ç»Ÿå¼€å‘ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```go
// permissions/types.go
type Permission string
type Role string
type Subject interface {
    GetRoles() []Role
    GetID() string
}

// permissions/rbac.go
type RBAC struct {
    rolePermissions map[Role][]Permission
    userRoles      map[string][]Role
}

func (r *RBAC) HasPermission(subject Subject, permission Permission) bool
func (r *RBAC) HasAnyPermission(subject Subject, permissions ...Permission) bool
func (r *RBAC) AssignRole(userID string, role Role)
```

### æƒé™ä¸­é—´ä»¶

```go
// middleware/auth.go
func RequirePermission(permission Permission) gin.HandlerFunc
func RequireAnyPermission(permissions ...Permission) gin.HandlerFunc
func RequireRole(role Role) gin.HandlerFunc
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
permissions/
â”œâ”€â”€ types.go           # åŸºç¡€ç±»å‹å®šä¹‰
â”œâ”€â”€ rbac.go           # RBACæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ constants.go      # æƒé™å¸¸é‡ (ä¸šåŠ¡è‡ªå®šä¹‰)
â””â”€â”€ middleware.go     # æƒé™ä¸­é—´ä»¶

models/
â””â”€â”€ user.go          # ç”¨æˆ·æ¨¡å‹ (å®ç°Subjectæ¥å£)
```

## ğŸ”§ å®ç°è®¡åˆ’

### Step 1: åŸºç¡€ç±»å‹ç³»ç»Ÿ

```go
// permissions/types.go
type Permission string
type Role string

const (
    // é€šç”¨æƒé™æ¨¡æ¿
    PermissionRead   Permission = "read"
    PermissionWrite  Permission = "write"
    PermissionDelete Permission = "delete"
    PermissionAdmin  Permission = "admin"
)

const (
    // é€šç”¨è§’è‰²æ¨¡æ¿
    RoleGuest  Role = "guest"
    RoleUser   Role = "user"
    RoleAdmin  Role = "admin"
    RoleSuper  Role = "super"
)
```

### Step 2: RBAC æ ¸å¿ƒå®ç°

```go
// permissions/rbac.go
type RBAC struct {
    mu              sync.RWMutex
    rolePermissions map[Role][]Permission
    inheritance     map[Role][]Role  // è§’è‰²ç»§æ‰¿
}

func NewRBAC() *RBAC
func (r *RBAC) DefineRole(role Role, permissions []Permission)
func (r *RBAC) SetRoleInheritance(child Role, parents []Role)
```

### Step 3: æƒé™æ£€æŸ¥ä¸­é—´ä»¶

```go
// middleware/auth.go
func RequirePermission(permission Permission) gin.HandlerFunc {
    return gin.HandlerFunc(func(c *gin.Context) {
        user := getCurrentUser(c)  // ä»contextè·å–ç”¨æˆ·

        rbac := GetRBAC()
        if !rbac.HasPermission(user, permission) {
            c.JSON(403, gin.H{"error": "æƒé™ä¸è¶³"})
            c.Abort()
            return
        }

        c.Next()
    })
}
```

### Step 4: ç”¨æˆ·æ¨¡å‹é›†æˆ

```go
// models/user.go
type User struct {
    ID    string
    Name  string
    Roles []Role
}

func (u *User) GetRoles() []Role { return u.Roles }
func (u *User) GetID() string    { return u.ID }
func (u *User) HasRole(role Role) bool
```

## ğŸ¨ ä½¿ç”¨æ¨¡æ¿

### ä¸šåŠ¡æƒé™å®šä¹‰

```go
// å¤åˆ¶å¹¶è‡ªå®šä¹‰ permissions/constants.go
const (
    // ç”¨æˆ·ç®¡ç†æƒé™
    PermissionUserView   Permission = "user:view"
    PermissionUserCreate Permission = "user:create"
    PermissionUserUpdate Permission = "user:update"
    PermissionUserDelete Permission = "user:delete"

    // å†…å®¹ç®¡ç†æƒé™
    PermissionPostView   Permission = "post:view"
    PermissionPostCreate Permission = "post:create"
    // ...æ›´å¤šä¸šåŠ¡æƒé™
)

const (
    // ä¸šåŠ¡è§’è‰²å®šä¹‰
    RoleEditor    Role = "editor"
    RoleModerator Role = "moderator"
    RoleManager   Role = "manager"
    // ...æ›´å¤šä¸šåŠ¡è§’è‰²
)
```

### è·¯ç”±æƒé™é…ç½®

```go
// api/routes.go
func RegisterRoutes(router *gin.Engine) {
    auth := router.Group("/api")

    // å…¬å¼€æ¥å£
    auth.POST("/login", loginHandler)

    // éœ€è¦ç™»å½•
    protected := auth.Use(middleware.RequireAuth())
    protected.GET("/profile", profileHandler)

    // éœ€è¦ç‰¹å®šæƒé™
    admin := protected.Use(middleware.RequireRole(permissions.RoleAdmin))
    admin.GET("/users", middleware.RequirePermission(permissions.PermissionUserView), listUsersHandler)
    admin.POST("/users", middleware.RequirePermission(permissions.PermissionUserCreate), createUserHandler)
}
```

### åˆå§‹åŒ–é…ç½®

```go
// main.go æˆ– bootstrap/permissions.go
func InitPermissions() {
    rbac := permissions.NewRBAC()

    // å®šä¹‰è§’è‰²æƒé™
    rbac.DefineRole(permissions.RoleUser, []Permission{
        permissions.PermissionRead,
    })

    rbac.DefineRole(permissions.RoleAdmin, []Permission{
        permissions.PermissionRead,
        permissions.PermissionWrite,
        permissions.PermissionDelete,
    })

    // è®¾ç½®è§’è‰²ç»§æ‰¿ (Adminç»§æ‰¿Useræƒé™)
    rbac.SetRoleInheritance(permissions.RoleAdmin, []Role{permissions.RoleUser})

    permissions.SetGlobalRBAC(rbac)
}
```

## ğŸ§ª æ‰©å±•ç¤ºä¾‹

### åŠ¨æ€æƒé™åŠ è½½

```go
// ä»æ•°æ®åº“åŠ è½½æƒé™é…ç½®
func LoadPermissionsFromDB() {
    var roles []models.RolePermission
    db.Find(&roles)

    rbac := permissions.GetRBAC()
    for _, rp := range roles {
        rbac.AssignPermissionToRole(rp.Role, rp.Permission)
    }
}
```

### èµ„æºçº§æƒé™

```go
// æ”¯æŒèµ„æºçº§ç»†ç²’åº¦æ§åˆ¶
type ResourcePermission struct {
    Permission Permission
    ResourceType string
    ResourceID   string
}

func (r *RBAC) HasResourcePermission(user Subject, permission Permission, resourceType, resourceID string) bool
```

## ğŸ“‹ æƒé™è®¾è®¡æŒ‡å—

### 1. æƒé™ç²’åº¦è®¾è®¡

- **ç²—ç²’åº¦**: `user:*`, `post:*` (ç®¡ç†å‘˜ä½¿ç”¨)
- **ä¸­ç²’åº¦**: `user:read`, `user:write` (å¸¸ç”¨)
- **ç»†ç²’åº¦**: `user:view_email`, `user:edit_profile` (ç‰¹æ®Šéœ€æ±‚)

### 2. è§’è‰²å±‚æ¬¡è®¾è®¡

```
Super Admin (æ‰€æœ‰æƒé™)
    â”œâ”€â”€ Admin (ç®¡ç†æƒé™)
    â”œâ”€â”€ Manager (ä¸šåŠ¡ç®¡ç†)
    â””â”€â”€ User (åŸºç¡€æƒé™)
        â””â”€â”€ Guest (åªè¯»æƒé™)
```

### 3. æƒé™å‘½åè§„èŒƒ

- æ ¼å¼: `{èµ„æº}:{æ“ä½œ}:{èŒƒå›´?}`
- ç¤ºä¾‹: `user:read:own`, `post:delete:any`

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] RBAC æ ¸å¿ƒé€»è¾‘æ­£ç¡®
- [ ] è§’è‰²ç»§æ‰¿åŠŸèƒ½å®Œæ•´
- [ ] ä¸­é—´ä»¶é›†æˆç®€å•
- [ ] æ”¯æŒåŠ¨æ€æƒé™åŠ è½½
- [ ] æƒé™æ£€æŸ¥æ€§èƒ½ <1ms
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹å®Œæ•´

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ€åæ­¥éª¤: [éƒ¨ç½²å®‰å…¨æ¸…å•](./05_éƒ¨ç½²å®‰å…¨æ¸…å•.md)
