# 允许所有格式配置

## 功能概述

添加 `allow_all_formats` 配置选项，开启后允许上传所有类型的文件，不进行格式验证。

## 实现时间

2026年2月9日

## 配置说明

### 配置文件位置

`configs/document.yaml`

### 配置项

```yaml
document:
  # 允许的文件格式
  allow_all_formats: true # 是否允许所有文件格式（开启后不验证文件类型）
  allowed_formats:
    document:
      - pdf
      - doc
      - docx
      # ...
    video:
      - mp4
      - webm
      # ...
```

### 配置说明

#### allow_all_formats

- **类型**: `boolean`
- **默认值**: `true`
- **说明**: 是否允许所有文件格式
  - `true`: 允许上传任何格式的文件，不进行格式验证
  - `false`: 只允许上传 `allowed_formats` 中配置的格式

#### allowed_formats

- **类型**: `map[string][]string`
- **说明**: 当 `allow_all_formats = false` 时生效，定义允许的文件格式
- **分类**:
  - `document`: 文档类型（PDF、Word、Excel、PPT、TXT等）
  - `video`: 视频类型（MP4、WebM、AVI、MOV等）
  - `archive`: 压缩包类型（ZIP、RAR、7Z等）
  - `other`: 其他类型（图片、音频等）

## 使用场景

### 场景 1: 允许所有格式（默认）

```yaml
document:
  allow_all_formats: true
```

**效果**:

- ✅ 可以上传任何格式的文件
- ✅ 不进行格式验证
- ✅ 适合内部使用，灵活性高

**示例**:

```
✅ file.pdf
✅ file.docx
✅ file.mp4
✅ file.zip
✅ file.exe
✅ file.dll
✅ file.sh
✅ file.py
✅ file.anything
```

### 场景 2: 限制特定格式

```yaml
document:
  allow_all_formats: false
  allowed_formats:
    document:
      - pdf
      - docx
    video:
      - mp4
```

**效果**:

- ✅ 只能上传 PDF、DOCX、MP4 格式
- ❌ 其他格式会被拒绝
- ✅ 适合对外服务，安全性高

**示例**:

```
✅ file.pdf
✅ file.docx
✅ file.mp4
❌ file.exe (不支持的文件格式: exe)
❌ file.zip (不支持的文件格式: zip)
❌ file.sh (不支持的文件格式: sh)
```

## 实现细节

### 1. 配置结构

#### YAML 配置

```go
type DocumentYAMLConfig struct {
    Document struct {
        AllowAllFormats bool                `yaml:"allow_all_formats"`
        AllowedFormats  map[string][]string `yaml:"allowed_formats"`
        // ...
    } `yaml:"document"`
}
```

#### 运行时配置

```go
type DocumentConfig struct {
    AllowAllFormats bool                // 是否允许所有格式
    AllowedFormats  map[string][]string // 允许的格式列表
    // ...
}
```

### 2. 默认配置

```go
func getDefaultDocumentConfig() *DocumentConfig {
    return &DocumentConfig{
        AllowAllFormats: true, // 默认允许所有格式
        AllowedFormats: map[string][]string{
            "document": {"pdf", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "txt", "md"},
            "video":    {"mp4", "webm", "avi", "mov"},
            "archive":  {"zip", "rar", "7z"},
            "other":    {"jpg", "png", "gif", "mp3", "wav"},
        },
        // ...
    }
}
```

### 3. 上传验证逻辑

```go
func (s *UploadService) Upload(file *multipart.FileHeader, metadata UploadMetadata) (*models.Document, error) {
    // 1. 检测文件格式
    format := s.detectFileFormat(file)

    // 2. 根据格式判断文档类型
    docType := models.GetDocumentType(format)

    // 3. 验证文件格式（如果启用了格式限制）
    if !s.config.AllowAllFormats {
        if !s.isFormatAllowed(docType, format) {
            return nil, fmt.Errorf("不支持的文件格式: %s", format)
        }
    }

    // 4. 继续上传流程...
}
```

### 4. 格式检测

即使允许所有格式，仍然会检测文件格式用于分类：

```go
func (s *UploadService) detectFileFormat(file *multipart.FileHeader) string {
    // 1. 读取文件头
    src, _ := file.Open()
    defer src.Close()

    buffer := make([]byte, 512)
    n, _ := src.Read(buffer)

    // 2. 使用 http.DetectContentType 检测 MIME 类型
    mimeType := http.DetectContentType(buffer[:n])

    // 3. 将 MIME 类型映射到文件扩展名
    format := s.mimeTypeToFormat(mimeType)

    // 4. 如果无法从 MIME 检测，尝试从文件名获取
    if format == "" {
        format = strings.ToLower(strings.TrimPrefix(filepath.Ext(file.Filename), "."))
    }

    return format
}
```

## 环境变量覆盖

可以通过环境变量覆盖配置：

```bash
# 允许所有格式
export DOCUMENT_ALLOW_ALL_FORMATS=true

# 限制格式
export DOCUMENT_ALLOW_ALL_FORMATS=false
```

**优先级**: 环境变量 > YAML配置文件 > 默认值

## 安全建议

### 1. 内部使用

如果文件库仅供内部使用，建议：

```yaml
allow_all_formats: true # 允许所有格式，方便使用
```

### 2. 对外服务

如果文件库对外提供服务，建议：

```yaml
allow_all_formats: false # 限制格式，提高安全性
allowed_formats:
  document:
    - pdf
    - docx
    - xlsx
  video:
    - mp4
  # 不允许可执行文件
```

### 3. 混合场景

可以通过权限控制实现混合场景：

- 管理员：允许所有格式
- 普通用户：限制格式

（需要在代码中实现权限判断）

## 文件类型分类

即使允许所有格式，系统仍会自动分类：

### 已知格式

根据 `FormatTypeMap` 自动分类：

```go
var FormatTypeMap = map[string]string{
    "pdf":  TypeDocument,
    "doc":  TypeDocument,
    "docx": TypeDocument,
    "mp4":  TypeVideo,
    "webm": TypeVideo,
    "zip":  TypeArchive,
    "rar":  TypeArchive,
    // ...
}
```

### 未知格式

未在 `FormatTypeMap` 中的格式归类为 `other`：

```go
func GetDocumentType(format string) string {
    if docType, ok := FormatTypeMap[strings.ToLower(format)]; ok {
        return docType
    }
    return TypeOther  // 未知格式
}
```

## 文件大小限制

文件大小限制仍然生效，按类型限制：

```yaml
max_file_size:
  document: 104857600 # 100MB
  video: 2147483648 # 2GB
  archive: 524288000 # 500MB
  other: 52428800 # 50MB
```

**注意**: 未知格式使用 `other` 类型的大小限制（50MB）

## 测试建议

### 1. 允许所有格式测试

```yaml
allow_all_formats: true
```

测试用例：

- [x] 上传常见格式（PDF、DOCX、MP4）
- [x] 上传不常见格式（EXE、DLL、SH）
- [x] 上传无扩展名文件
- [x] 上传自定义扩展名文件

### 2. 限制格式测试

```yaml
allow_all_formats: false
allowed_formats:
  document: [pdf]
```

测试用例：

- [x] 上传允许的格式（PDF）- 应该成功
- [x] 上传不允许的格式（DOCX）- 应该失败
- [x] 错误消息是否清晰

### 3. 环境变量测试

```bash
export DOCUMENT_ALLOW_ALL_FORMATS=false
```

测试用例：

- [x] 环境变量是否覆盖 YAML 配置
- [x] 重启服务后配置是否生效

### 4. 边界测试

- [ ] 空文件
- [ ] 超大文件
- [ ] 损坏的文件
- [ ] 伪装扩展名的文件（如 virus.exe 改名为 virus.pdf）

## 注意事项

### 1. MIME 类型检测

系统使用 `http.DetectContentType` 检测文件类型，基于文件内容而非扩展名：

```go
// 即使文件名是 virus.pdf，如果内容是 EXE，会被检测为 application/x-msdownload
mimeType := http.DetectContentType(buffer)
```

### 2. 未知格式处理

未知格式会被归类为 `other` 类型：

- 使用 `other` 类型的大小限制（50MB）
- 在前端显示为 "OTHER" 标签
- 无法预览，只能下载

### 3. 安全风险

允许所有格式可能带来安全风险：

- 可执行文件（EXE、DLL、SH、BAT）
- 脚本文件（JS、VBS、PS1）
- 宏文档（带宏的 Office 文件）

建议：

- 内部使用时开启
- 对外服务时关闭
- 添加病毒扫描
- 限制下载权限

### 4. 存储空间

允许所有格式可能导致存储空间快速增长，建议：

- 定期清理无用文件
- 设置存储配额
- 监控存储使用情况

## 配置示例

### 示例 1: 完全开放（内部使用）

```yaml
document:
  allow_all_formats: true
  max_file_size:
    document: 104857600 # 100MB
    video: 2147483648 # 2GB
    archive: 524288000 # 500MB
    other: 104857600 # 100MB（提高未知格式限制）
```

### 示例 2: 严格限制（对外服务）

```yaml
document:
  allow_all_formats: false
  allowed_formats:
    document:
      - pdf
      - docx
      - xlsx
    video:
      - mp4
    # 不允许压缩包和其他格式
  max_file_size:
    document: 52428800 # 50MB
    video: 524288000 # 500MB
```

### 示例 3: 中等限制（混合场景）

```yaml
document:
  allow_all_formats: false
  allowed_formats:
    document:
      - pdf
      - doc
      - docx
      - xls
      - xlsx
      - ppt
      - pptx
      - txt
      - md
    video:
      - mp4
      - webm
    archive:
      - zip
    other:
      - jpg
      - png
      - gif
      - mp3
  max_file_size:
    document: 104857600
    video: 1073741824 # 1GB
    archive: 104857600
    other: 52428800
```

## 总结

`allow_all_formats` 配置已完成，主要特点：

✅ **默认开启**: 默认允许所有格式，方便使用  
✅ **灵活配置**: 可以通过 YAML 或环境变量配置  
✅ **安全可控**: 可以根据需求限制格式  
✅ **自动分类**: 即使允许所有格式，仍会自动分类  
✅ **大小限制**: 文件大小限制仍然生效

这个功能让文件库更加灵活，既可以完全开放供内部使用，也可以严格限制供对外服务。
