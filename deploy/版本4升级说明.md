# 版本 4 升级说明 - 清理丢失的文件记录

## 问题描述

发现部分文件在数据库中显示已下载（`status=1`），但物理文件实际不存在，导致前端访问时报错：

```
error: "文件不存在"
path: "/vol1/1003/project/editor_v2/static/textures/Fence008A/Fence008A_2K-JPG_Color.jpg"
```

## 解决方案

版本 4 升级会自动：

1. **检查所有文件记录**：遍历数据库中的所有文件记录
2. **验证物理文件**：检查对应的物理文件是否真实存在
3. **删除丢失记录**：删除物理文件不存在的数据库记录
4. **更新材质状态**：重新计算材质的下载状态和同步状态
5. **触发重新下载**：系统会自动重新下载丢失的文件

## 升级方法

### 方法 1: 重启后端（自动升级）

```bash
# 停止后端
sudo systemctl stop 3d-editor-backend

# 或者
pkill -f app-linux

# 启动后端（会自动执行升级）
sudo systemctl start 3d-editor-backend

# 或者
cd /vol1/1003/project/editor_v2/deploy
nohup ./app-linux > logs/app.log 2>&1 &

# 查看升级日志
tail -f logs/app.log
```

### 方法 2: 手动触发升级

如果已经是版本 4，想重新执行升级：

```bash
# 删除版本记录
rm data/.db_version

# 重启后端
sudo systemctl restart 3d-editor-backend
```

## 升级日志示例

```
time="2026-01-26 15:00:00" level=info msg="执行版本 4 升级: 清理丢失的文件记录..."
time="2026-01-26 15:00:00" level=info msg="开始检查文件完整性..."
time="2026-01-26 15:00:00" level=info msg="找到 5716 个文件记录，开始检查物理文件..."
time="2026-01-26 15:00:05" level=warning msg="文件不存在，删除记录: static/textures/Fence008A/Fence008A_2K-JPG_Color.jpg (ID: 9636)"
time="2026-01-26 15:00:10" level=info msg="已检查 100/5716 个文件，删除 5 个丢失记录..."
time="2026-01-26 15:00:30" level=info msg="文件完整性检查完成: 检查 5716 个，删除 23 个丢失记录"
time="2026-01-26 15:00:30" level=info msg="开始更新材质同步状态..."
time="2026-01-26 15:00:35" level=info msg="成功更新 15 个材质的同步状态"
time="2026-01-26 15:00:35" level=info msg="版本 4 升级完成"
```

## 支持的路径格式

升级脚本会自动检查多种路径格式：

1. 原始路径：`static\textures\Fence008A\Fence008A.png`
2. Unix 路径：`static/textures/Fence008A/Fence008A.png`
3. Windows 路径：`static\textures\Fence008A\Fence008A.png`
4. 相对路径：`textures/Fence008A/Fence008A.png`
5. NAS 绝对路径：`/vol1/1003/project/editor_v2/static/textures/Fence008A/Fence008A.png`

## 升级后效果

1. ✅ 数据库记录与物理文件保持一致
2. ✅ 材质的下载状态准确反映实际情况
3. ✅ 前端不再报"文件不存在"错误
4. ✅ 系统会自动重新下载丢失的文件

## 注意事项

1. **备份数据库**：升级前建议备份数据库

   ```bash
   cp data/app.db data/app.db.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **检查磁盘空间**：确保有足够空间重新下载文件

3. **网络连接**：确保代理服务正常运行

   ```bash
   sudo systemctl status mihomo
   ```

4. **查看日志**：升级过程中可以实时查看日志
   ```bash
   tail -f logs/app.log
   ```

## 故障排查

### 升级未执行

检查当前版本：

```bash
cat data/.db_version
```

如果显示 `4`，说明已经升级过了。要重新执行，删除版本文件：

```bash
rm data/.db_version
```

### 文件仍然丢失

1. 检查 NAS 路径配置：

   ```bash
   cat config.yaml | grep nas_path
   ```

2. 检查文件权限：

   ```bash
   ls -la /vol1/1003/project/editor_v2/static/textures/
   ```

3. 手动触发同步：
   ```bash
   curl -X POST http://localhost:23359/api/textures/sync
   ```

### 下载失败

1. 检查代理：

   ```bash
   curl -x http://127.0.0.1:7890 https://www.google.com
   ```

2. 查看下载日志：
   ```bash
   tail -f logs/app.log | grep -i download
   ```

## 相关文件

- 配置文件：`configs/database_version.yaml`
- 升级脚本：`database/migrations.go`
- 版本记录：`data/.db_version`
- 日志文件：`logs/app.log`
