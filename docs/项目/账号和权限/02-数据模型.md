# 账号和权限数据模型

## User 用户表

```go
type User struct {
    ID               uint       `gorm:"primaryKey" json:"id"`
    Username         string     `gorm:"uniqueIndex;size:50" json:"username"`
    Password         string     `gorm:"size:255" json:"-"` // 不返回给前端
    Email            string     `gorm:"uniqueIndex;size:100" json:"email"`
    Phone            string     `gorm:"size:20" json:"phone"`
    RealName         string     `gorm:"size:50" json:"real_name"`
    Avatar           string     `gorm:"size:512" json:"avatar"`

    // 状态
    Status           string     `gorm:"default:'active';index" json:"status"` // active, disabled, locked

    // 关联
    Roles            []Role            `gorm:"many2many:user_roles;" json:"roles"`
    Permissions      []Permission      `gorm:"many2many:user_permissions;" json:"permissions"`
    PermissionGroups []PermissionGroup `gorm:"many2many:user_permission_groups;" json:"permission_groups"`

    // 登录信息
    LastLoginAt      *time.Time `json:"last_login_at"`
    LastLoginIP      string     `gorm:"size:50" json:"last_login_ip"`
    LoginFailCount   int        `gorm:"default:0" json:"-"` // 登录失败次数
    LockedUntil      *time.Time `json:"-"` // 锁定到期时间

    CreatedAt        time.Time  `json:"created_at"`
    UpdatedAt        time.Time  `json:"updated_at"`
}
```

## Role 角色表

```go
type Role struct {
    ID               uint              `gorm:"primaryKey" json:"id"`
    Code             string            `gorm:"uniqueIndex;size:100" json:"code"` // super_admin, admin, editor
    Name             string            `gorm:"size:100" json:"name"`
    Description      string            `gorm:"size:500" json:"description"`
    IsSystem         bool              `gorm:"default:false;index" json:"is_system"` // 系统预设不可删除

    // 关联
    Permissions      []Permission      `gorm:"many2many:role_permissions;" json:"permissions"`
    PermissionGroups []PermissionGroup `gorm:"many2many:role_permission_groups;" json:"permission_groups"`

    CreatedAt        time.Time         `json:"created_at"`
    UpdatedAt        time.Time         `json:"updated_at"`
}
```

## Permission 权限表

```go
type Permission struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    Code        string    `gorm:"uniqueIndex;size:100" json:"code"` // documents:read
    Name        string    `gorm:"size:100" json:"name"`
    Resource    string    `gorm:"index;size:50" json:"resource"` // documents, models
    Action      string    `gorm:"index;size:50" json:"action"` // read, write, delete
    Description string    `gorm:"size:500" json:"description"`
    IsSystem    bool      `gorm:"default:false;index" json:"is_system"`

    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

## PermissionGroup 权限组表

```go
type PermissionGroup struct {
    ID          uint         `gorm:"primaryKey" json:"id"`
    Code        string       `gorm:"uniqueIndex;size:100" json:"code"` // document_manager
    Name        string       `gorm:"size:100" json:"name"`
    Description string       `gorm:"size:500" json:"description"`
    IsSystem    bool         `gorm:"default:false;index" json:"is_system"`

    // 关联
    Permissions []Permission `gorm:"many2many:permission_group_permissions;" json:"permissions"`

    CreatedAt   time.Time    `json:"created_at"`
    UpdatedAt   time.Time    `json:"updated_at"`
}
```

## ResourcePermission 资源权限表

```go
type ResourcePermission struct {
    ID           uint       `gorm:"primaryKey" json:"id"`
    UserID       uint       `gorm:"index" json:"user_id"`
    ResourceType string     `gorm:"index;size:50" json:"resource_type"` // documents, models
    ResourceID   uint       `gorm:"index" json:"resource_id"`
    Permission   string     `gorm:"size:50" json:"permission"` // read, write, delete

    // 授权信息
    GrantedBy    uint       `json:"granted_by"` // 授权人ID
    ExpiresAt    *time.Time `json:"expires_at"` // 过期时间

    CreatedAt    time.Time  `json:"created_at"`
    UpdatedAt    time.Time  `json:"updated_at"`

    // 关联
    User         User       `gorm:"foreignKey:UserID" json:"user"`
}
```

## 关联表

### user_roles 用户角色关联

```go
type UserRole struct {
    UserID    uint      `gorm:"primaryKey"`
    RoleID    uint      `gorm:"primaryKey"`
    CreatedAt time.Time
}
```

### user_permissions 用户权限关联

```go
type UserPermission struct {
    UserID       uint      `gorm:"primaryKey"`
    PermissionID uint      `gorm:"primaryKey"`
    CreatedAt    time.Time
}
```

### user_permission_groups 用户权限组关联

```go
type UserPermissionGroup struct {
    UserID             uint      `gorm:"primaryKey"`
    PermissionGroupID  uint      `gorm:"primaryKey"`
    CreatedAt          time.Time
}
```

### role_permissions 角色权限关联

```go
type RolePermission struct {
    RoleID       uint      `gorm:"primaryKey"`
    PermissionID uint      `gorm:"primaryKey"`
    CreatedAt    time.Time
}
```

### role_permission_groups 角色权限组关联

```go
type RolePermissionGroup struct {
    RoleID            uint      `gorm:"primaryKey"`
    PermissionGroupID uint      `gorm:"primaryKey"`
    CreatedAt         time.Time
}
```

### permission_group_permissions 权限组权限关联

```go
type PermissionGroupPermission struct {
    PermissionGroupID uint      `gorm:"primaryKey"`
    PermissionID      uint      `gorm:"primaryKey"`
    CreatedAt         time.Time
}
```

## 状态常量

```go
// 用户状态
const (
    UserStatusActive   = "active"   // 正常
    UserStatusDisabled = "disabled" // 禁用
    UserStatusLocked   = "locked"   // 锁定（登录失败过多）
)

// 资源类型
const (
    ResourceDocuments = "documents"
    ResourceModels    = "models"
    ResourceAssets    = "assets"
    ResourceTextures  = "textures"
    ResourceProjects  = "projects"
    ResourceAI3D      = "ai3d"
    ResourceUsers     = "users"
    ResourceRoles     = "roles"
    ResourcePermissions = "permissions"
)

// 操作类型
const (
    ActionRead     = "read"
    ActionCreate   = "create"
    ActionUpdate   = "update"
    ActionDelete   = "delete"
    ActionDownload = "download"
    ActionUpload   = "upload"
    ActionShare    = "share"
    ActionAdmin    = "admin"
)
```

## 索引设计

```go
// 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);

// 角色表索引
CREATE INDEX idx_roles_code ON roles(code);
CREATE INDEX idx_roles_is_system ON roles(is_system);

// 权限表索引
CREATE INDEX idx_permissions_code ON permissions(code);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_permissions_action ON permissions(action);

// 资源权限表索引
CREATE INDEX idx_resource_permissions_user ON resource_permissions(user_id);
CREATE INDEX idx_resource_permissions_resource ON resource_permissions(resource_type, resource_id);
CREATE INDEX idx_resource_permissions_expires ON resource_permissions(expires_at);
```
