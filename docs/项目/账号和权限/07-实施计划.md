# 实施计划

## 阶段一：基础模型和服务（1-2天）

### 1.1 创建数据模型

- [ ] `models/user.go` - 用户模型
- [ ] `models/role.go` - 角色模型
- [ ] `models/permission.go` - 权限模型
- [ ] `models/permission_group.go` - 权限组模型
- [ ] `models/resource_permission.go` - 资源权限模型

### 1.2 数据库迁移

- [ ] 在 `database/database.go` 中添加模型迁移
- [ ] 创建必要的索引
- [ ] 测试迁移脚本

### 1.3 初始化数据

- [ ] `database/init_auth.go` - 权限系统初始化
- [ ] 创建系统权限
- [ ] 创建系统权限组
- [ ] 创建系统角色
- [ ] 创建默认管理员账号

## 阶段二：Service 层实现（2-3天）

### 2.1 核心服务

- [ ] `services/auth/user_service.go` - 用户服务
- [ ] `services/auth/role_service.go` - 角色服务
- [ ] `services/auth/permission_service.go` - 权限服务
- [ ] `services/auth/permission_group_service.go` - 权限组服务
- [ ] `services/auth/resource_permission_service.go` - 资源权限服务

### 2.2 认证服务

- [ ] `services/auth/auth_service.go` - 认证服务
  - 注册
  - 登录
  - 登出
  - Token 刷新
  - 密码管理

### 2.3 权限计算

- [ ] `services/auth/permission_calculator.go` - 权限计算器
  - 计算用户最终权限
  - 权限匹配逻辑
  - 通配符支持
  - 权限缓存

## 阶段三：中间件增强（1天）

### 3.1 权限中间件

- [ ] `middleware/permission.go` - 权限验证中间件
  - RequirePermission
  - RequireAnyPermission
  - RequireAllPermissions
  - RequireOwnership
  - RequireResourcePermission

### 3.2 辅助函数

- [ ] 权限匹配函数
- [ ] 所有权检查函数
- [ ] 资源权限检查函数

## 阶段四：Controller 层实现（2-3天）

### 4.1 认证控制器

- [ ] `controllers/auth_controller.go`
  - 注册
  - 登录
  - 登出
  - 刷新 Token
  - 修改密码
  - 权限检查接口

### 4.2 用户管理控制器

- [ ] `controllers/user_controller.go`
  - CRUD 操作
  - 状态管理
  - 角色分配
  - 权限授予
  - 获取用户权限

### 4.3 角色管理控制器

- [ ] `controllers/role_controller.go`
  - CRUD 操作
  - 权限分配
  - 权限组分配

### 4.4 权限管理控制器

- [ ] `controllers/permission_controller.go`
  - CRUD 操作
  - 资源和操作查询

### 4.5 权限组管理控制器

- [ ] `controllers/permission_group_controller.go`
  - CRUD 操作
  - 权限管理

### 4.6 资源权限控制器

- [ ] `controllers/resource_permission_controller.go`
  - 授予/撤销资源权限
  - 查询资源权限

## 阶段五：路由集成（1天）

### 5.1 注册认证路由

- [ ] 在 `api/routes.go` 中添加认证路由
- [ ] 添加用户管理路由
- [ ] 添加角色管理路由
- [ ] 添加权限管理路由
- [ ] 添加权限组管理路由
- [ ] 添加资源权限路由

### 5.2 保护现有路由

- [ ] 文档库路由添加权限验证
- [ ] 模型库路由添加权限验证
- [ ] 资产库路由添加权限验证
- [ ] 贴图库路由添加权限验证
- [ ] 项目管理路由添加权限验证
- [ ] AI3D 路由添加权限验证

## 阶段六：审计日志集成（0.5天）

### 6.1 集成现有审计系统

- [ ] 登录/登出记录
- [ ] 权限变更记录
- [ ] 角色变更记录
- [ ] 用户操作记录

## 阶段七：前端接口对接（根据前端进度）

### 7.1 提供接口文档

- [ ] Swagger 文档更新
- [ ] API 测试用例
- [ ] Postman Collection

### 7.2 前端功能

- [ ] 登录页面
- [ ] 用户管理页面
- [ ] 角色管理页面
- [ ] 权限管理页面
- [ ] 个人中心页面

## 阶段八：测试和优化（1-2天）

### 8.1 单元测试

- [ ] Service 层测试
- [ ] 权限计算测试
- [ ] 中间件测试

### 8.2 集成测试

- [ ] 完整认证流程测试
- [ ] 权限验证测试
- [ ] 资源权限测试

### 8.3 性能优化

- [ ] 权限缓存优化
- [ ] 数据库查询优化
- [ ] 索引优化

## 阶段九：文档和部署（0.5天）

### 9.1 文档完善

- [ ] API 文档
- [ ] 部署文档
- [ ] 使用手册

### 9.2 部署准备

- [ ] 配置文件模板
- [ ] 数据库迁移脚本
- [ ] 初始化脚本

## 总计时间估算

- 开发时间：8-12 天
- 测试时间：1-2 天
- 文档和部署：0.5-1 天

总计：9.5-15 天

## 优先级

### P0（必须）

- 用户模型和认证
- 角色和权限模型
- 基础 CRUD 接口
- 登录/登出功能
- 权限验证中间件

### P1（重要）

- 权限组功能
- 资源权限功能
- 用户管理界面
- 角色管理界面

### P2（可选）

- 自定义权限创建
- 临时权限（过期时间）
- 权限继承
- 高级权限查询

## 风险和注意事项

### 技术风险

- 权限计算性能问题 → 使用缓存
- 数据库迁移失败 → 做好备份
- 现有功能兼容性 → 渐进式集成

### 业务风险

- 权限设计过于复杂 → 从简单开始，逐步扩展
- 用户体验问题 → 提供清晰的权限说明
- 数据安全 → 严格的权限验证和审计

## 回滚方案

如果出现问题，可以：

1. 保留现有代码不变
2. 新功能使用特性开关控制
3. 数据库迁移可回滚
4. 默认不启用权限验证，逐步开启
