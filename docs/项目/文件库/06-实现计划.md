# 文件库实现计划

## 阶段一：基础功能（核心）

### 1. 配置和模型

- [ ] 在 `config.yaml` 添加 document 配置段
- [ ] 在 `config/config.go` 添加 DocumentConfig 结构
- [ ] 创建 `models/document.go` 定义数据模型
- [ ] 数据库迁移脚本

### 2. 存储服务

- [ ] 复用 `services/storage/file_storage_service.go`
- [ ] 支持本地存储和 NAS 存储

### 3. 基础上传和查询

- [ ] 创建 `services/document/upload_service.go`
- [ ] 创建 `services/document/query_service.go`
- [ ] 实现文件上传
- [ ] 实现文件列表查询
- [ ] 实现文件详情查询
- [ ] 实现文件删除

### 4. Controller 和路由

- [ ] 创建 `controllers/document_controller.go`
- [ ] 实现基础 API 接口
- [ ] 注册路由

## 阶段二：文件处理（增强）

### 1. Processor 接口

- [ ] 创建 `services/document/processor_interface.go`
- [ ] 定义 DocumentProcessor 接口

### 2. PDF 处理器

- [ ] 创建 `services/document/processors/pdf_processor.go`
- [ ] PDF 验证
- [ ] 生成缩略图
- [ ] 提取元数据（页数、作者等）
- [ ] 生成预览图

### 3. 视频处理器

- [ ] 创建 `services/document/processors/video_processor.go`
- [ ] 视频验证
- [ ] 生成缩略图（FFmpeg）
- [ ] 提取元数据（时长、分辨率等）

### 4. 其他处理器

- [ ] Office 文档处理器（可选）
- [ ] 压缩包处理器（可选）

## 阶段三：版本管理（高级）

### 1. 版本服务

- [ ] 创建 `services/document/version_service.go`
- [ ] 实现版本创建
- [ ] 实现版本列表
- [ ] 实现版本切换
- [ ] 实现版本删除

### 2. 版本 API

- [ ] 上传新版本接口
- [ ] 版本列表接口
- [ ] 版本切换接口

## 阶段四：权限和日志（安全）

### 1. 权限服务

- [ ] 创建 `services/document/permission_service.go`
- [ ] 实现权限检查
- [ ] 实现部门隔离
- [ ] 实现项目隔离

### 2. 访问日志

- [ ] 创建 `services/document/access_log_service.go`
- [ ] 记录访问日志
- [ ] 查询访问日志
- [ ] 清理过期日志

### 3. 日志 API

- [ ] 访问日志查询接口
- [ ] 操作日志接口

## 阶段五：统计和优化（完善）

### 1. 统计功能

- [ ] 存储空间统计
- [ ] 文件类型分布
- [ ] 下载次数统计
- [ ] 热门文件排行

### 2. 批量操作

- [ ] 批量删除
- [ ] 批量移动
- [ ] 批量标签

### 3. 性能优化

- [ ] 缓存预览图
- [ ] 异步处理大文件
- [ ] 分片上传（可选）

## 文件结构

```
run-scene-backend/
├── config/
│   └── config.go                    # 添加 DocumentConfig
├── models/
│   └── document.go                  # 文档模型
├── controllers/
│   └── document_controller.go       # 文档控制器
├── services/
│   └── document/
│       ├── upload_service.go        # 上传服务
│       ├── query_service.go         # 查询服务
│       ├── version_service.go       # 版本服务
│       ├── preview_service.go       # 预览服务
│       ├── permission_service.go    # 权限服务
│       ├── access_log_service.go    # 日志服务
│       ├── processor_interface.go   # 处理器接口
│       └── processors/
│           ├── pdf_processor.go     # PDF处理器
│           ├── video_processor.go   # 视频处理器
│           ├── document_processor.go # Office处理器
│           └── archive_processor.go  # 压缩包处理器
├── docs/
│   └── 项目/
│       └── 文件库/
│           ├── 01-概述.md
│           ├── 02-数据模型.md
│           ├── 03-配置设计.md
│           ├── 04-API接口.md
│           ├── 05-Service层设计.md
│           └── 06-实现计划.md
└── config.yaml                      # 添加 document 配置段
```

## 依赖工具

### 必需

- FFmpeg：视频处理
- ImageMagick 或 Poppler：PDF 转图片

### 可选

- LibreOffice：Office 文档预览
- 7zip：压缩包处理

## 测试计划

### 单元测试

- [ ] 文件上传测试
- [ ] 文件类型检测测试
- [ ] 哈希计算测试
- [ ] 版本管理测试

### 集成测试

- [ ] 完整上传流程测试
- [ ] 预览生成测试
- [ ] 权限控制测试

### 性能测试

- [ ] 大文件上传测试
- [ ] 并发上传测试
- [ ] 预览生成性能测试

## 注意事项

1. **参考资产库实现**：文件库的实现模式与资产库类似，可以复用很多代码结构
2. **存储服务复用**：直接使用现有的 `storage.FileStorageService`
3. **配置独立**：文件库有独立的配置段，不影响其他模块
4. **渐进式开发**：先实现核心功能，再逐步添加高级特性
5. **安全性**：注意文件类型验证、大小限制、权限控制
6. **性能**：大文件处理考虑异步和分片
