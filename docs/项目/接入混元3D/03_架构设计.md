# 混元3D接入 - 架构设计

## 目录结构

```
models/hunyuan/
├── task.go            # 任务模型
└── config.go          # 配置模型

services/hunyuan/
├── client.go          # 腾讯云API客户端
├── task_service.go    # 任务管理服务
├── config_service.go  # 配置管理服务
└── storage_service.go # 文件存储服务

controllers/
└── hunyuan_controller.go  # API控制器
```

## 服务层设计

### 1. client.go - API客户端

```go
type HunyuanClient struct {
    secretID  string
    secretKey string
    region    string
}

func NewHunyuanClient(secretID, secretKey, region string) *HunyuanClient

// 提交任务（默认3.1模型，GLB格式，启用PBR）
func (c *HunyuanClient) SubmitJob(params *GenerateParams) (jobID string, err error)

// 查询任务
func (c *HunyuanClient) QueryJob(jobID string) (*TaskResult, error)

// 签名生成
func (c *HunyuanClient) sign(action string, payload []byte, timestamp int64) string
```

### 2. task_service.go - 任务服务

```go
type TaskService struct {
    db     *gorm.DB
    client *HunyuanClient
    config *ConfigService
    storage *StorageService
}

func NewTaskService(db *gorm.DB, config *ConfigService, storage *StorageService) *TaskService

// 创建任务
func (s *TaskService) CreateTask(params *GenerateParams, userInfo UserInfo) (*HunyuanTask, error)

// 查询任务状态
func (s *TaskService) GetTaskStatus(taskID uint) (*HunyuanTask, error)

// 轮询任务直到完成
func (s *TaskService) PollTask(taskID uint) error

// 任务列表
func (s *TaskService) ListTasks(page, pageSize int, filters TaskFilters) ([]HunyuanTask, int64, error)

// 取消任务
func (s *TaskService) CancelTask(taskID uint) error

// 重试失败任务
func (s *TaskService) RetryTask(taskID uint) error

// 删除任务（包括文件）
func (s *TaskService) DeleteTask(taskID uint) error
```

### 3. config_service.go - 配置服务

```go
type ConfigService struct {
    db *gorm.DB
}

func NewConfigService(db *gorm.DB) *ConfigService

// 获取配置
func (s *ConfigService) GetConfig() (*HunyuanConfig, error)

// 更新配置
func (s *ConfigService) UpdateConfig(config *HunyuanConfig) error

// 获取客户端
func (s *ConfigService) GetClient() (*HunyuanClient, error)

// 验证配置
func (s *ConfigService) ValidateConfig(config *HunyuanConfig) error
```

### 4. storage_service.go - 存储服务

```go
type StorageService struct {
    db     *gorm.DB
    config *HunyuanConfig
}

func NewStorageService(db *gorm.DB, config *HunyuanConfig) *StorageService

// 下载并保存模型文件
func (s *StorageService) SaveTaskResult(task *HunyuanTask, files []File3D) (*StorageInfo, error)

// 下载文件
func (s *StorageService) downloadFile(url string) ([]byte, error)

// 保存到本地
func (s *StorageService) saveToLocal(data []byte, filename string) (string, error)

// 保存到NAS
func (s *StorageService) saveToNAS(data []byte, filename string) (string, error)

// 生成文件哈希
func (s *StorageService) calculateHash(data []byte) string

// 检查文件是否存在
func (s *StorageService) fileExists(hash string) (*HunyuanTask, error)

// 删除文件
func (s *StorageService) DeleteFiles(task *HunyuanTask) error

// 获取访问URL
func (s *StorageService) GetAccessURL(task *HunyuanTask) string
```

## 控制器设计

### hunyuan_controller.go

```go
type HunyuanController struct {
    taskService    *TaskService
    configService  *ConfigService
    storageService *StorageService
}

func NewHunyuanController(db *gorm.DB) *HunyuanController

// 提交任务
func (c *HunyuanController) SubmitTask(ctx *gin.Context)

// 查询任务
func (c *HunyuanController) GetTask(ctx *gin.Context)

// 任务列表
func (c *HunyuanController) ListTasks(ctx *gin.Context)

// 轮询任务
func (c *HunyuanController) PollTask(ctx *gin.Context)

// 取消任务
func (c *HunyuanController) CancelTask(ctx *gin.Context)

// 重试任务
func (c *HunyuanController) RetryTask(ctx *gin.Context)

// 删除任务
func (c *HunyuanController) DeleteTask(ctx *gin.Context)

// 下载文件
func (c *HunyuanController) DownloadFile(ctx *gin.Context)

// 获取配置
func (c *HunyuanController) GetConfig(ctx *gin.Context)

// 更新配置
func (c *HunyuanController) UpdateConfig(ctx *gin.Context)

// 获取统计信息
func (c *HunyuanController) GetStatistics(ctx *gin.Context)
```

## 核心流程

### 任务提交流程

```
1. 接收请求参数（默认：model=3.1, enablePBR=true, resultFormat=GLB）
2. 验证参数（文本/图片必填其一）
3. 获取配置和客户端
4. 调用腾讯云API提交任务
5. 创建本地任务记录
6. 启动后台轮询（可选）
7. 返回任务ID
```

### 任务轮询流程

```
1. 获取任务记录
2. 检查状态（已完成则返回）
3. 调用腾讯云API查询
4. 更新本地状态
5. 如果完成：
   - 下载GLB文件（带PBR贴图）
   - 下载预览图
   - 计算文件哈希
   - 检查是否重复
   - 保存到本地/NAS
   - 更新任务记录
6. 如果失败：记录错误信息
7. 如果运行中：等待后重试
```

### 文件存储流程

```
1. 下载GLB文件和预览图
2. 计算文件哈希（去重）
3. 检查是否已存在
4. 如果启用本地存储：
   - 保存到 static/hunyuan/{year}/{month}/{hash}.glb
   - 保存预览图到 static/hunyuan/{year}/{month}/{hash}.png
5. 如果启用NAS存储：
   - 保存到 NAS路径/{year}/{month}/{hash}.glb
   - 保存预览图
6. 更新任务记录（路径、大小、哈希）
7. 返回访问URL
```

### 文件访问流程

```
1. 根据配置确定访问方式
2. 本地存储：返回 baseURL + localPath
3. NAS存储：返回 baseURL + nasPath
4. 支持直接下载和预览
```

## 并发控制

- 使用数据库记录跟踪运行中任务数
- 提交前检查并发限制
- 任务完成后释放槽位
- 支持配置最大并发数

## 错误处理

- API调用失败：记录错误，支持重试
- 下载失败：保留任务记录，可手动重试
- 存储失败：回滚任务状态，清理临时文件
- 超时处理：24小时后自动标记为失败
- 重复文件：直接引用已存在文件，不重复下载

## NAS存储支持

### Windows SMB共享

```go
// 使用 \\server\share\path 格式
nasPath := "\\\\192.168.3.10\\project\\hunyuan"
```

### 文件操作

```go
// 直接使用标准库操作
os.WriteFile(nasPath + "/file.glb", data, 0644)
```

### 权限要求

- 读写权限
- 网络连接稳定
- 足够的存储空间
