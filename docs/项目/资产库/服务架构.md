# 服务架构

## 目录结构

```
services/asset/
  ├── upload_service.go      # 上传服务
  ├── query_service.go       # 查询服务
  ├── processor_service.go   # 文件处理服务
  └── tag_service.go         # 标签服务（复用）

services/asset/processors/
  ├── image_processor.go     # 图片处理器
  └── video_processor.go     # 视频处理器

models/
  ├── asset.go               # 资产相关模型
  └── asset_metadata.go      # 元数据模型

controllers/
  └── asset_controller.go    # 资产控制器
```

---

## 核心服务

### 1. UploadService (上传服务)

```go
type UploadService struct {
    db *gorm.DB
    config *AssetConfig
    processors map[string]AssetProcessor
}

// 上传资产
func (s *UploadService) Upload(file *multipart.FileHeader, metadata UploadMetadata) (*Asset, error)

// 保存文件到磁盘
func (s *UploadService) saveFile(file *multipart.FileHeader, assetType string, assetID uint) (string, error)

// 验证文件格式
func (s *UploadService) validateFile(file *multipart.FileHeader, assetType string) error

// 检查文件是否已存在（基于MD5）
func (s *UploadService) checkDuplicate(fileHash string) (*Asset, bool, error)

// 计算文件哈希
func (s *UploadService) calculateHash(file *multipart.FileHeader) (string, error)

// 获取对应的处理器
func (s *UploadService) getProcessor(assetType string) (AssetProcessor, error)
```

**UploadMetadata 结构**：

```go
type UploadMetadata struct {
    Name        string
    Description string
    Category    string
    Tags        []string
    Type        string   // image, video
    UploadedBy  string
    UploadIP    string
}
```

---

### 2. ProcessorService (文件处理服务)

定义统一的处理器接口：

```go
type AssetProcessor interface {
    // 生成缩略图
    GenerateThumbnail(filePath string, outputPath string) error

    // 提取元数据
    ExtractMetadata(filePath string) (*AssetMetadata, error)

    // 验证文件
    Validate(file *multipart.FileHeader) error

    // 获取支持的格式
    SupportedFormats() []string
}
```

#### 2.1 TextureProcessor (贴图处理器)

```go
type TextureProcessor struct {
    config *ThumbnailConfig
}

func (p *TextureProcessor) GenerateThumbnail(filePath, outputPath string) error
func (p *TextureProcessor) ExtractMetadata(filePath string) (*AssetMetadata, error)
func (p *TextureProcessor) Validate(file *multipart.FileHeader) error
func (p *TextureProcessor) SupportedFormats() []string
```

**功能**：

- 生成WebP缩略图
- 提取图片尺寸、色彩模式、DPI

#### 2.2 EnvironmentProcessor (环境图处理器)

```go
type EnvironmentProcessor struct {
    config *ThumbnailConfig
}

func (p *EnvironmentProcessor) GenerateThumbnail(filePath, outputPath string) error
func (p *EnvironmentProcessor) ExtractMetadata(filePath string) (*AssetMetadata, error)
func (p *EnvironmentProcessor) Validate(file *multipart.FileHeader) error
func (p *EnvironmentProcessor) SupportedFormats() []string
```

**功能**：

- HDR/EXR转WebP预览图
- 提取分辨率、投影方式、动态范围

#### 2.3 VideoProcessor (视频处理器)

```go
type VideoProcessor struct {
    config *VideoConfig
    ffmpegPath string
}

func (p *VideoProcessor) GenerateThumbnail(filePath, outputPath string) error
func (p *VideoProcessor) ExtractMetadata(filePath string) (*AssetMetadata, error)
func (p *VideoProcessor) Validate(file *multipart.FileHeader) error
func (p *VideoProcessor) SupportedFormats() []string
```

**功能**：

- 使用FFmpeg截取视频帧作为缩略图
- 提取时长、分辨率、帧率、编码格式

#### 2.4 AudioProcessor (音频处理器)

```go
type AudioProcessor struct {
    config *AudioConfig
}

func (p *AudioProcessor) GenerateThumbnail(filePath, outputPath string) error
func (p *AudioProcessor) ExtractMetadata(filePath string) (*AssetMetadata, error)
func (p *AudioProcessor) Validate(file *multipart.FileHeader) error
func (p *AudioProcessor) SupportedFormats() []string
```

**功能**：

- 使用默认音频图标作为缩略图
- 提取时长、采样率、比特率、声道数

---

### 3. QueryService (查询服务)

```go
type QueryService struct {
    db *gorm.DB
}

// 分页查询
func (q *QueryService) List(page, pageSize int, filters QueryFilters) ([]*Asset, int64, error)

// 按类型查询
func (q *QueryService) ListByType(assetType string, page, pageSize int) ([]*Asset, int64, error)

// 按分类查询
func (q *QueryService) ListByCategory(category string, page, pageSize int) ([]*Asset, int64, error)

// 按标签查询
func (q *QueryService) ListByTags(tagIDs []uint, page, pageSize int) ([]*Asset, int64, error)

// 搜索（名称、标签）
func (q *QueryService) Search(keyword string, page, pageSize int) ([]*Asset, int64, error)

// 获取详情（包含元数据）
func (q *QueryService) GetDetail(id uint) (*Asset, *AssetMetadata, []*Tag, error)

// 记录使用次数
func (q *QueryService) IncrementUseCount(id uint) error

// 获取统计信息
func (q *QueryService) GetStatistics(assetType string) (*AssetStatistics, error)

// 删除资产
func (q *QueryService) Delete(id uint) error

// 更新资产信息
func (q *QueryService) Update(id uint, updates map[string]interface{}) error
```

**QueryFilters 结构**：

```go
type QueryFilters struct {
    Type      string   // image, video
    Category  string
    Tags      []string
    Format    string   // jpg, png, hdr, mp4等
    SortBy    string   // name, created_at, use_count, file_size
    SortOrder string   // asc, desc
}
```

---

### 4. TagService (标签服务)

复用贴图库的 TagService，扩展支持资产：

```go
// 关联资产和标签
func (t *TagService) AssociateAssetTags(assetID uint, tagIDs []uint) error

// 获取资产的标签
func (t *TagService) GetAssetTags(assetID uint) ([]*Tag, error)

// 更新资产标签
func (t *TagService) UpdateAssetTags(assetID uint, tagIDs []uint) error
```

---

## 工作流程

### 上传流程

```
1. 接收文件上传请求
2. 验证文件格式和大小
3. 计算文件MD5，检查是否重复
4. 创建资产ID
5. 保存文件到磁盘 (static/assets/{id}/file.{ext})
6. 根据类型选择处理器
7. 生成缩略图 (static/assets/{id}/thumbnail.webp)
8. 提取元数据
9. 创建数据库记录（资产 + 元数据）
10. 处理标签关联
11. 更新统计信息
12. 返回资产信息
```

### 查询流程

```
1. 接收查询参数
2. 构建查询条件
3. 执行数据库查询
4. 加载关联数据（元数据、标签）
5. 组装返回数据
6. 返回结果
```

---

## 配置管理

```go
type AssetConfig struct {
    StorageDir        string
    MaxFileSize       map[string]int64  // image, video
    AllowedFormats    map[string][]string
    ThumbnailConfig   *ThumbnailConfig
    VideoConfig       *VideoConfig
    UploadConcurrency int
}

type ThumbnailConfig struct {
    Width   int
    Height  int
    Quality int
}

type VideoConfig struct {
    FFmpegPath      string
    ThumbnailTime   float64  // 截图时间点（秒）
    MaxDuration     float64  // 最大时长（秒）
}

func LoadConfig() (*AssetConfig, error)
```

---

## 错误处理

```go
var (
    ErrInvalidType        = errors.New("不支持的资源类型")
    ErrInvalidFormat      = errors.New("不支持的文件格式")
    ErrFileTooLarge       = errors.New("文件大小超过限制")
    ErrDuplicateFile      = errors.New("文件已存在")
    ErrProcessorNotFound  = errors.New("找不到对应的处理器")
    ErrThumbnailFailed    = errors.New("缩略图生成失败")
    ErrMetadataFailed     = errors.New("元数据提取失败")
)
```

---

## 并发控制

```go
type UploadPool struct {
    workers   int
    taskQueue chan *UploadTask
    wg        sync.WaitGroup
}

type UploadTask struct {
    File     *multipart.FileHeader
    Metadata UploadMetadata
    Result   chan *UploadResult
}

func NewUploadPool(workers int) *UploadPool
func (p *UploadPool) Submit(task *UploadTask)
func (p *UploadPool) Wait()
```
