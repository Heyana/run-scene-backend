# 文件库重构完成文档

## 重构目标

将文件库和文件组从两个独立系统重构为统一的云盘式文件管理系统，文件和文件夹在同一个表中，通过 `is_folder` 字段区分。

## 已完成的工作

### 1. 数据模型统一 ✅

**文件**: `models/document.go`

- 添加 `is_folder` 字段：区分文件和文件夹
- 添加 `parent_id` 字段：支持无限层级嵌套
- 添加 `child_count` 字段：自动统计子项数量
- 实现 GORM 钩子：
  - `AfterCreate`: 创建后自动更新父文件夹的 `child_count`
  - `AfterDelete`: 删除后自动更新父文件夹的 `child_count`
  - `AfterFind`: 查询后自动拼接完整 URL（仅文件）

### 2. 后端服务层 ✅

#### UploadService (`services/document/upload_service.go`)

- ✅ 添加 `CreateFolder` 方法：创建文件夹
- ✅ `Upload` 方法支持 `parent_id` 参数：上传文件到指定文件夹
- ✅ 文件名清洗：自动移除特殊字符
- ✅ MD5 重复检测：防止重复上传

#### QueryService (`services/document/query_service.go`)

- ✅ `List` 方法支持 `parent_id` 过滤：
  - `parent_id = nil`: 查询所有
  - `parent_id = 0`: 查询根目录
  - `parent_id = N`: 查询指定文件夹下的内容
- ✅ `Delete` 方法支持级联删除（通过 GORM 的 `AfterDelete` 钩子）

### 3. 控制器层 ✅

**文件**: `controllers/document_controller.go`

- ✅ 添加 `CreateFolder` 端点：`POST /api/documents/folder`
- ✅ `Upload` 端点支持 `parent_id` 参数
- ✅ `List` 端点支持 `parent_id` 查询参数
- ✅ `Delete` 端点支持删除文件夹（级联删除）

### 4. 路由配置 ✅

**文件**: `api/routes.go`

- ✅ 添加 `POST /api/documents/folder` 路由
- ✅ 删除所有 `/api/document-groups` 相关路由
- ✅ 更新文件库路由注释，说明支持统一管理

### 5. 前端实现 ✅

#### API 层 (`frontend/src/api/documents.ts`)

- ✅ 更新 `Document` 接口：添加 `is_folder`, `parent_id`, `child_count` 字段
- ✅ 更新 `DocumentListParams`：添加 `parent_id` 参数
- ✅ 添加 `createFolder` 函数

#### 视图层 (`frontend/src/views/Documents.tsx`)

- ✅ 删除 `folders` 状态，统一使用 `documents`
- ✅ `currentFolderId` 改为数字类型（0 表示根目录）
- ✅ `loadCurrentFolder` 使用单一 API 调用，通过 `parent_id` 过滤
- ✅ `handleCreateFolder` 调用 `createFolder` API
- ✅ `handleUpload` 支持 `parent_id` 参数
- ✅ `handleDelete` 统一处理文件和文件夹删除
- ✅ `handleOpenFolder` 使用 `Document` 类型
- ✅ 面包屑导航支持文件夹层级
- ✅ 统计信息使用 computed 计算文件夹和文件数量
- ✅ 渲染逻辑检查 `item.is_folder` 属性

#### 已删除的文件 ✅

- ✅ `frontend/src/api/documentGroups.ts`
- ✅ `frontend/src/views/DocumentGroups.tsx`
- ✅ `frontend/src/views/DocumentGroupDetail.tsx`
- ✅ `frontend/src/views/DocumentGroups.less`

### 6. 数据库迁移 ✅

**文件**: `database/database.go`

- ✅ 删除 `DocumentGroup` 和 `DocumentGroupItem` 表的迁移
- ✅ `Document` 表已包含所有必要字段

## 核心特性

### 1. 统一模型

- 文件和文件夹在同一个 `documents` 表中
- 通过 `is_folder` 字段区分类型
- 通过 `parent_id` 字段实现层级关系

### 2. 无限嵌套

- 支持任意层级的文件夹嵌套
- 面包屑导航显示完整路径
- 点击面包屑可快速跳转

### 3. 自动统计

- `child_count` 字段自动维护
- GORM 钩子确保数据一致性
- 前端实时显示子项数量

### 4. 级联删除

- 删除文件夹时提示子项数量
- 支持级联删除所有子项
- 自动更新父文件夹统计

### 5. 文件上传

- 支持上传到指定文件夹
- 自动清洗文件名
- MD5 重复检测

## API 接口

### 创建文件夹

```
POST /api/documents/folder
Content-Type: application/json

{
  "name": "文件夹名称",
  "description": "描述",
  "parent_id": 0  // 可选，0或null表示根目录
}
```

### 上传文件

```
POST /api/documents/upload
Content-Type: multipart/form-data

file: <文件>
name: 文件名称
parent_id: 1  // 可选，指定父文件夹ID
```

### 查询文件列表

```
GET /api/documents?parent_id=0&page=1&pageSize=24

parent_id: 0 表示根目录，其他数字表示指定文件夹
```

### 删除文件/文件夹

```
DELETE /api/documents/:id

如果是文件夹且包含子项，会级联删除
```

## 使用流程

### 1. 查看根目录

```typescript
getDocuments({ parent_id: 0, page: 1, pageSize: 24 });
```

### 2. 创建文件夹

```typescript
createFolder({ name: "新文件夹", parent_id: 0 });
```

### 3. 进入文件夹

```typescript
// 点击文件夹后
getDocuments({ parent_id: folderId, page: 1, pageSize: 24 });
```

### 4. 上传文件到文件夹

```typescript
const formData = new FormData();
formData.append("file", file);
formData.append("parent_id", String(currentFolderId));
uploadDocument(formData);
```

### 5. 返回上级

```typescript
// 通过面包屑导航或返回按钮
getDocuments({ parent_id: parentFolderId, page: 1, pageSize: 24 });
```

## 数据库结构

### documents 表

```sql
CREATE TABLE documents (
  id INTEGER PRIMARY KEY,
  name VARCHAR(200),
  description TEXT,
  type VARCHAR(20),  -- folder, document, video, archive, other
  parent_id INTEGER,  -- 父文件夹ID，NULL表示根目录
  is_folder BOOLEAN DEFAULT FALSE,  -- 是否是文件夹
  child_count INTEGER DEFAULT 0,  -- 子项数量
  file_size INTEGER,  -- 文件大小（仅文件）
  file_path VARCHAR(512),  -- 文件路径（仅文件）
  file_hash VARCHAR(64),  -- MD5哈希（仅文件）
  format VARCHAR(20),  -- 文件格式（仅文件）
  created_at DATETIME,
  updated_at DATETIME,
  ...
)
```

## 测试建议

1. **创建文件夹**
   - 在根目录创建文件夹
   - 在子文件夹中创建文件夹
   - 验证 `child_count` 自动更新

2. **上传文件**
   - 上传到根目录
   - 上传到子文件夹
   - 验证文件显示在正确位置

3. **导航测试**
   - 点击文件夹进入
   - 使用面包屑返回
   - 使用返回按钮返回上级

4. **删除测试**
   - 删除空文件夹
   - 删除包含文件的文件夹（级联删除）
   - 验证父文件夹 `child_count` 更新

5. **预览测试**
   - 点击图片文件预览
   - 点击视频文件播放
   - 点击其他文件下载

## 注意事项

1. **parent_id 的含义**
   - `NULL` 或 `0`: 根目录
   - 其他数字: 指定文件夹的 ID

2. **child_count 维护**
   - 由 GORM 钩子自动维护
   - 不要手动修改此字段

3. **级联删除**
   - 删除文件夹会删除所有子项
   - 前端会提示用户确认

4. **文件路径**
   - 存储相对路径（基于 `static` 目录）
   - `AfterFind` 钩子自动拼接完整 URL

## 迁移说明

如果已有旧数据需要迁移：

1. **DocumentGroup 数据迁移到 Document**

   ```sql
   INSERT INTO documents (name, description, parent_id, is_folder, type, created_at, updated_at)
   SELECT name, description, parent_id, TRUE, 'folder', created_at, updated_at
   FROM document_groups;
   ```

2. **更新现有文件的 parent_id**

   ```sql
   UPDATE documents d
   SET parent_id = (
     SELECT dg.id FROM document_groups dg
     WHERE dg.id = d.group_id
   )
   WHERE d.group_id IS NOT NULL;
   ```

3. **删除旧表**
   ```sql
   DROP TABLE document_group_items;
   DROP TABLE document_groups;
   ```

## 总结

重构已完成，文件库现在是一个统一的云盘式文件管理系统：

- ✅ 文件和文件夹在同一个表中
- ✅ 支持无限层级嵌套
- ✅ 自动维护统计信息
- ✅ 支持级联删除
- ✅ 前端统一渲染
- ✅ 删除了所有旧的 document_group 代码

系统现在更简洁、更易维护，用户体验类似云盘。
